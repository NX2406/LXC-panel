#!/bin/bash
set -euo pipefail

RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[0;33m'; BLUE='\033[0;36m'; PLAIN='\033[0m'
info(){ echo -e "${BLUE}[INFO]${PLAIN} $*"; }
ok(){ echo -e "${GREEN}[OK]${PLAIN} $*"; }
warn(){ echo -e "${YELLOW}[WARN]${PLAIN} $*"; }
die(){ echo -e "${RED}[ERR]${PLAIN} $*"; exit 1; }

[[ $EUID -eq 0 ]] || die "è¯·ç”¨ root è¿è¡Œ"

export DEBIAN_FRONTEND=noninteractive

APP_DIR="/opt/lxd-webpanel"
CFG_DIR="/etc/lxd-webpanel"
DATA_DIR="/var/lib/lxd-webpanel"
SERVICE_NAME="lxd-webpanel"
PORT="${PORT:-8088}"

rand_hex(){ tr -dc 'a-f0-9' </dev/urandom | head -c "${1:-16}"; }
rand_pw(){ tr -dc 'A-Za-z0-9_@#%+=' </dev/urandom | head -c "${1:-18}"; }

host_ip() {
  local ip
  ip="$(hostname -I 2>/dev/null | awk '{print $1}')"
  [[ -z "${ip}" ]] && ip="127.0.0.1"
  echo "$ip"
}

install_node() {
  if command -v node >/dev/null 2>&1; then
    ok "Node å·²å­˜åœ¨ï¼š$(node -v)"
    return
  fi
  info "å®‰è£… Node.jsï¼ˆDebian/Ubuntu å®˜æ–¹æºå¯èƒ½è¾ƒæ—§ï¼Œå…ˆå°è¯• aptï¼‰..."
  apt-get update -y
  apt-get install -y ca-certificates curl gnupg
  # NodeSource 18.xï¼ˆç¨³ï¼‰
  curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
  apt-get install -y nodejs
  ok "Node å·²å®‰è£…ï¼š$(node -v)"
}

install_deps() {
  info "å®‰è£…ç³»ç»Ÿä¾èµ–..."
  apt-get update -y
  apt-get install -y git build-essential python3 make g++ sqlite3
  ok "ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"
}

write_app_files() {
  info "å†™å…¥åº”ç”¨æ–‡ä»¶..."
  mkdir -p "$APP_DIR" "$CFG_DIR" "$DATA_DIR"

  cat > "${APP_DIR}/package.json" << 'JSON'
{
  "name": "lxd-webpanel",
  "version": "1.0.0",
  "private": true,
  "type": "module",
  "main": "server.js",
  "scripts": {
    "start": "node server.js"
  },
  "dependencies": {
    "bcryptjs": "^2.4.3",
    "cookie-parser": "^1.4.6",
    "csurf": "^1.11.0",
    "express": "^4.19.2",
    "express-rate-limit": "^7.4.1",
    "express-session": "^1.17.3",
    "sqlite3": "^5.1.7"
  }
}
JSON

  cat > "${APP_DIR}/server.js" << 'JS'
import express from "express";
import session from "express-session";
import rateLimit from "express-rate-limit";
import cookieParser from "cookie-parser";
import csrf from "csurf";
import bcrypt from "bcryptjs";
import sqlite3 from "sqlite3";
import { promisify } from "util";
import fs from "fs";
import path from "path";
import os from "os";

const CFG_PATH = process.env.CFG_PATH || "/etc/lxd-webpanel/config.json";
const DATA_DIR = process.env.DATA_DIR || "/var/lib/lxd-webpanel";
const DB_PATH = path.join(DATA_DIR, "webpanel.db");

function die(msg){ console.error(msg); process.exit(1); }
if(!fs.existsSync(CFG_PATH)) die("Missing config: " + CFG_PATH);

const cfg = JSON.parse(fs.readFileSync(CFG_PATH, "utf-8"));
const ENTRY = (cfg.entry_path || "/panel").replace(/\/+$/,"");
const PANEL_URL = (cfg.panel_url || "").replace(/\/+$/,"");
const PANEL_ADMIN_USER = cfg.panel_admin_user || "admin";
const PANEL_ADMIN_PASS = cfg.panel_admin_pass || "";
const PORT = Number(cfg.listen_port || 8088);

if(!PANEL_URL) die("config.panel_url is empty");
if(!PANEL_ADMIN_PASS) die("config.panel_admin_pass is empty");

const app = express();
app.disable("x-powered-by");
app.set("trust proxy", 1);

app.use(express.urlencoded({ extended: false, limit:"1mb" }));
app.use(express.json({ limit:"1mb" }));
app.use(cookieParser());

app.use(rateLimit({
  windowMs: 60_000,
  limit: 180,
  standardHeaders: "draft-7",
  legacyHeaders: false
}));

app.use(session({
  secret: cfg.session_secret || "change-me",
  resave: false,
  saveUninitialized: false,
  cookie: { httpOnly:true, sameSite:"lax", secure:false, maxAge: 7*24*3600*1000 }
}));

const csrfProtection = csrf({ cookie: false });

/** ---------------- DB ---------------- */
sqlite3.verbose();
const db = new sqlite3.Database(DB_PATH);
const run = (sql, params=[]) => new Promise((res, rej)=>db.run(sql, params, function(err){ err?rej(err):res(this); }));
const get = (sql, params=[]) => new Promise((res, rej)=>db.get(sql, params, (err,row)=>err?rej(err):res(row)));
const all = (sql, params=[]) => new Promise((res, rej)=>db.all(sql, params, (err,rows)=>err?rej(err):res(rows)));

async function initDb(){
  await run(`CREATE TABLE IF NOT EXISTS users(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    passhash TEXT NOT NULL,
    role TEXT NOT NULL,
    enabled INTEGER NOT NULL DEFAULT 1,
    created_at TEXT NOT NULL
  )`);
  await run(`CREATE TABLE IF NOT EXISTS assignments(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    node_id TEXT NOT NULL,
    instance_name TEXT NOT NULL,
    created_at TEXT NOT NULL,
    UNIQUE(user_id, node_id, instance_name)
  )`);
  await run(`CREATE TABLE IF NOT EXISTS audit(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    ts TEXT NOT NULL,
    actor TEXT NOT NULL,
    action TEXT NOT NULL,
    detail TEXT NOT NULL
  )`);

  // ensure admin
  const adminUser = cfg.admin_user || "admin";
  const adminPass = cfg.admin_pass || "";
  if(!adminPass) die("config.admin_pass empty");
  const row = await get("SELECT id FROM users WHERE username=?", [adminUser]);
  if(!row){
    const passhash = bcrypt.hashSync(adminPass, 10);
    await run("INSERT INTO users(username, passhash, role, enabled, created_at) VALUES(?,?,?,?,?)",
      [adminUser, passhash, "admin", 1, new Date().toISOString()]);
    await audit("system","admin.bootstrap", JSON.stringify({adminUser}));
  }
}

async function audit(actor, action, detail){
  await run("INSERT INTO audit(ts,actor,action,detail) VALUES(?,?,?,?)",
    [new Date().toISOString(), actor, action, detail]);
}

/** ---------------- Panel JWT cache ---------------- */
let panelJwt = "";
let panelJwtAt = 0;

async function panelLogin(){
  const now = Date.now();
  // 15åˆ†é’Ÿå†…å¤ç”¨
  if(panelJwt && (now - panelJwtAt) < 15*60*1000) return panelJwt;

  const r = await fetch(PANEL_URL + "/auth/login", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ username: PANEL_ADMIN_USER, password: PANEL_ADMIN_PASS })
  });
  const txt = await r.text();
  let j = null; try{ j = txt?JSON.parse(txt):null; }catch{}
  if(!r.ok) throw new Error(j?.detail || j?.message || txt || ("Panel login failed: "+r.status));
  if(!j?.token) throw new Error("Panel login response missing token");
  panelJwt = j.token;
  panelJwtAt = now;
  return panelJwt;
}

async function panelFetch(method, path, body){
  const token = await panelLogin();
  const url = PANEL_URL + path;
  const headers = { "Authorization": "Bearer " + token };
  if(body !== undefined) headers["Content-Type"] = "application/json";

  const r = await fetch(url, { method, headers, body: body===undefined? undefined : JSON.stringify(body) });
  const txt = await r.text();
  let j = null; try{ j = txt?JSON.parse(txt):null; }catch{}
  if(!r.ok) throw new Error(j?.detail || j?.message || txt || ("Panel request failed: "+r.status));
  return j ?? txt;
}

/** ---------------- Auth middleware ---------------- */
function mustLogin(req,res,next){
  if(!req.session.user) return res.redirect(ENTRY + "/login");
  next();
}
function mustAdmin(req,res,next){
  if(!req.session.user || req.session.user.role!=="admin") return res.status(403).send("Forbidden");
  next();
}
function mustUser(req,res,next){
  if(!req.session.user || (req.session.user.role!=="user" && req.session.user.role!=="admin")) return res.status(403).send("Forbidden");
  next();
}

/** ---------------- HTML helpers ---------------- */
function esc(s){ return String(s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

function layout(title, user, body){
  const u = user ? `${esc(user.username)} (${esc(user.role)})` : "æœªç™»å½•";
  return `<!doctype html>
<html lang="zh-CN"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>${esc(title)}</title>
<style>
:root{--bg:#0b1220;--panel:#0f1a33;--card:#111f3f;--muted:#9fb2d0;--text:#e7efff;--accent:#6aa5ff;--good:#53e3a6;--warn:#ffcc66;--bad:#ff6b6b;--line:#22355f;--mono:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;--sans:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
*{box-sizing:border-box} body{margin:0;background:radial-gradient(1100px 700px at 20% 0%, #122652 0%, var(--bg) 55%);color:var(--text);font-family:var(--sans)}
a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
header{padding:14px 16px;border-bottom:1px solid var(--line);position:sticky;top:0;background:rgba(11,18,32,.86);backdrop-filter: blur(10px);z-index:10}
h1{margin:0;font-size:14px} .sub{color:var(--muted);font-size:12px;margin-top:6px}
.wrap{max-width:1200px;margin:0 auto;padding:14px;display:grid;grid-template-columns:240px 1fr;gap:14px}
.card{background:linear-gradient(180deg, rgba(17,31,63,.92), rgba(15,26,51,.92));border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.card h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--line);font-size:13px}
.card .body{padding:12px 14px}
.nav a{display:block;padding:10px 12px;border-radius:12px;border:1px solid var(--line);margin:8px 0;background:rgba(12,22,48,.55);color:var(--text)}
.nav a:hover{border-color:var(--accent)}
label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
input,select,textarea{width:100%;background:#0c1630;border:1px solid #274173;border-radius:12px;color:var(--text);padding:10px;font-size:13px;outline:none}
textarea{min-height:120px;font-family:var(--mono);font-size:12px}
button{background:#152a57;border:1px solid #2b4b86;color:var(--text);border-radius:12px;padding:10px 12px;font-size:13px;cursor:pointer}
button.primary{background:linear-gradient(180deg,#2a63d6,#1e4fb1);border-color:#2b61c7}
button.good{background:linear-gradient(180deg,#0f6b4a,#0a4a34);border-color:#158a61}
button.bad{background:linear-gradient(180deg,#7a2424,#541818);border-color:#a23b3b}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.hint{color:var(--muted);font-size:12px;line-height:1.55}
pre{white-space:pre-wrap;word-break:break-word;background:rgba(12,22,48,.55);border:1px solid var(--line);border-radius:14px;padding:10px;font-family:var(--mono);font-size:12px}
@media(max-width:980px){.wrap{grid-template-columns:1fr}}
</style></head>
<body>
<header>
  <h1>ğŸ§Š LXD WebPanelï¼ˆå‰ç«¯ç‹¬ç«‹VPSï¼‰</h1>
  <div class="sub">å…¥å£ï¼š<b>${esc(ENTRY)}</b> Â· å½“å‰ï¼š${u}</div>
</header>
<div class="wrap">
  <div class="card"><h2>å¯¼èˆª</h2><div class="body nav">
    ${user? `<a href="${ENTRY}/home">é¦–é¡µ</a>` : ``}
    ${user && user.role==="admin" ? `
      <a href="${ENTRY}/admin/nodes">èŠ‚ç‚¹/å®¹å™¨</a>
      <a href="${ENTRY}/admin/users">ç”¨æˆ·ç®¡ç†</a>
      <a href="${ENTRY}/admin/audit">å®¡è®¡</a>
      <a href="${ENTRY}/admin/raw">Raw API</a>
    ` : ``}
    ${user && user.role!=="admin" ? `
      <a href="${ENTRY}/user/instances">æˆ‘çš„å®¹å™¨</a>
      <a href="${ENTRY}/user/raw">Rawï¼ˆä»…é™å·²æˆæƒå®¹å™¨ï¼‰</a>
    ` : ``}
    ${user ? `<a href="${ENTRY}/logout">é€€å‡º</a>` : `<a href="${ENTRY}/login">ç™»å½•</a>`}
  </div></div>
  <div class="card"><h2>${esc(title)}</h2><div class="body">${body}</div></div>
</div>
</body></html>`;
}

function jsonOk(res, data){ res.setHeader("Content-Type","application/json"); res.end(JSON.stringify({ok:true, ...data}, null, 2)); }
function jsonErr(res, msg, status=400){ res.status(status).json({ok:false, error:String(msg||"error")}); }

/** ---------------- Routes: Entry redirect ---------------- */
app.get("/", (req,res)=>res.redirect(ENTRY + "/login"));
app.get(ENTRY, (req,res)=>res.redirect(ENTRY + "/login"));

/** ---------------- Login ---------------- */
app.get(ENTRY + "/login", csrfProtection, async (req,res)=>{
  const u = (req.query.user||"").toString();
  const body = `
    <div class="hint">åƒå®å¡”ä¸€æ ·ï¼šå…¥å£è·¯å¾„æ˜¯éšæœºçš„ã€‚ç®¡ç†å‘˜å¯ä»¥åœ¨åå°ç”Ÿæˆç”¨æˆ·è´¦å·å¯†ç ï¼Œå¹¶æŠŠç™»å½•é“¾æ¥å‘ç»™ç”¨æˆ·ã€‚</div>
    <form method="POST" action="${ENTRY}/login">
      <input type="hidden" name="_csrf" value="${req.csrfToken()}"/>
      <label>ç”¨æˆ·å</label><input name="username" value="${esc(u)}" required/>
      <label>å¯†ç </label><input name="password" type="password" required/>
      <div style="margin-top:12px"><button class="primary" type="submit">ç™»å½•</button></div>
    </form>
  `;
  res.send(layout("ç™»å½•", null, body));
});

app.post(ENTRY + "/login", csrfProtection, async (req,res)=>{
  const { username, password } = req.body || {};
  try{
    const row = await get("SELECT id,username,passhash,role,enabled FROM users WHERE username=?", [String(username||"")]);
    if(!row) return res.send(layout("ç™»å½•å¤±è´¥", null, `<div class="hint">è´¦å·æˆ–å¯†ç é”™è¯¯ã€‚</div>`));
    if(Number(row.enabled)!==1) return res.send(layout("ç™»å½•å¤±è´¥", null, `<div class="hint">è´¦å·å·²ç¦ç”¨ã€‚</div>`));
    const okp = bcrypt.compareSync(String(password||""), row.passhash);
    if(!okp) return res.send(layout("ç™»å½•å¤±è´¥", null, `<div class="hint">è´¦å·æˆ–å¯†ç é”™è¯¯ã€‚</div>`));
    req.session.user = { id: row.id, username: row.username, role: row.role };
    await audit(row.username, "login", JSON.stringify({role:row.role}));
    res.redirect(ENTRY + "/home");
  }catch(e){
    res.send(layout("ç™»å½•å¤±è´¥", null, `<pre>${esc(e.message||String(e))}</pre>`));
  }
});

app.get(ENTRY + "/logout", async (req,res)=>{
  const u = req.session.user?.username || "unknown";
  req.session.destroy(()=>{});
  try{ await audit(u,"logout","{}"); }catch{}
  res.redirect(ENTRY + "/login");
});

app.get(ENTRY + "/home", mustLogin, (req,res)=>{
  const body = `
    <div class="hint">
      ä½ ç°åœ¨ç™»å½•çš„æ˜¯ <b>${esc(req.session.user.username)}</b>ï¼ˆ${esc(req.session.user.role)}ï¼‰ã€‚
      <br/>æœ¬é¢æ¿è¿è¡Œåœ¨â€œç‹¬ç«‹å‰ç«¯ VPSâ€ï¼Œé€šè¿‡åå°ä»£ç†è°ƒç”¨ Panel APIï¼ˆè§£å†³è·¨åŸŸï¼Œç»Ÿä¸€æƒé™ï¼‰ã€‚
    </div>
    <div style="margin-top:10px" class="hint">
      Panel URLï¼š<b>${esc(PANEL_URL)}</b><br/>
      å…¥å£è·¯å¾„ï¼š<b>${esc(ENTRY)}</b>
    </div>
  `;
  res.send(layout("é¦–é¡µ", req.session.user, body));
});

/** ---------------- Admin: Users ---------------- */
app.get(ENTRY + "/admin/users", mustAdmin, csrfProtection, async (req,res)=>{
  const users = await all("SELECT id,username,role,enabled,created_at FROM users ORDER BY id DESC");
  const rows = users.map(u=>`
    <tr>
      <td>${u.id}</td><td>${esc(u.username)}</td><td>${esc(u.role)}</td>
      <td>${Number(u.enabled)===1 ? "enabled" : "disabled"}</td>
      <td class="mono">${esc(u.created_at)}</td>
    </tr>`).join("");

  const body = `
    <div class="hint">ç®¡ç†å‘˜å¯ä»¥åˆ›å»ºç”¨æˆ·ã€é‡ç½®å¯†ç ã€ç¦ç”¨ç”¨æˆ·ï¼Œå¹¶æŠŠâ€œç™»å½•é“¾æ¥ + è´¦å·å¯†ç â€å‘ç»™ç”¨æˆ·ã€‚</div>
    <form method="POST" action="${ENTRY}/admin/users/create">
      <input type="hidden" name="_csrf" value="${req.csrfToken()}"/>
      <div class="row">
        <div><label>ç”¨æˆ·å</label><input name="username" placeholder="user001" required/></div>
        <div><label>è§’è‰²</label>
          <select name="role"><option value="user" selected>user</option><option value="admin">admin</option></select>
        </div>
      </div>
      <div style="margin-top:12px"><button class="good" type="submit">åˆ›å»ºç”¨æˆ·ï¼ˆè‡ªåŠ¨ç”Ÿæˆå¯†ç ï¼‰</button></div>
    </form>
    <hr style="border:none;border-top:1px solid var(--line);margin:14px 0">
    <form method="POST" action="${ENTRY}/admin/users/reset">
      <input type="hidden" name="_csrf" value="${req.csrfToken()}"/>
      <div class="row">
        <div><label>é‡ç½®å¯†ç ï¼šç”¨æˆ·å</label><input name="username" placeholder="user001" required/></div>
        <div style="display:flex;align-items:end"><button type="submit">é‡ç½®å¯†ç ï¼ˆç”Ÿæˆæ–°å¯†ç ï¼‰</button></div>
      </div>
    </form>
    <form method="POST" action="${ENTRY}/admin/users/toggle" style="margin-top:10px">
      <input type="hidden" name="_csrf" value="${req.csrfToken()}"/>
      <div class="row">
        <div><label>å¯ç”¨/ç¦ç”¨ï¼šç”¨æˆ·å</label><input name="username" placeholder="user001" required/></div>
        <div>
          <label>æ“ä½œ</label>
          <select name="enabled"><option value="1">å¯ç”¨</option><option value="0">ç¦ç”¨</option></select>
        </div>
      </div>
      <div style="margin-top:12px"><button class="bad" type="submit">æ‰§è¡Œ</button></div>
    </form>

    <hr style="border:none;border-top:1px solid var(--line);margin:14px 0">
    <h3 style="margin:0 0 8px;font-size:13px">ç”¨æˆ·åˆ—è¡¨</h3>
    <div style="overflow:auto">
      <table style="width:100%;border-collapse:collapse;font-size:12px">
        <thead><tr>
          <th style="text-align:left;padding:8px;border-bottom:1px solid var(--line)">ID</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid var(--line)">Username</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid var(--line)">Role</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid var(--line)">Status</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid var(--line)">Created</th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>

    <hr style="border:none;border-top:1px solid var(--line);margin:14px 0">
    <div class="hint">
      ç”¨æˆ·ç™»å½•é“¾æ¥æ¨¡æ¿ï¼š<b>${esc(ENTRY)}/login?user=USERNAME</b>ï¼ˆæŠŠ USERNAME æ¢æˆç”¨æˆ·åï¼‰
    </div>
  `;
  res.send(layout("ç”¨æˆ·ç®¡ç†", req.session.user, body));
});

app.post(ENTRY + "/admin/users/create", mustAdmin, csrfProtection, async (req,res)=>{
  try{
    const username = String(req.body.username||"").trim();
    const role = (String(req.body.role||"user")==="admin") ? "admin" : "user";
    if(!username) throw new Error("username empty");
    const pw = (cfg.user_password_policy==="fixed") ? (cfg.default_user_pass||"123456") : (Math.random().toString(36).slice(2,10) + randHex(4));
    const passhash = bcrypt.hashSync(pw, 10);
    await run("INSERT INTO users(username, passhash, role, enabled, created_at) VALUES(?,?,?,?,?)",
      [username, passhash, role, 1, new Date().toISOString()]);
    await audit(req.session.user.username, "user.create", JSON.stringify({username, role}));

    const ip = cfg.public_host || req.headers.host;
    const link = `http://${ip}${ENTRY}/login?user=${encodeURIComponent(username)}`;
    const body = `
      <div class="hint">ç”¨æˆ·å·²åˆ›å»ºï¼ˆå¯†ç åªå±•ç¤ºä¸€æ¬¡ï¼Œè®°å¾—å¤åˆ¶ç»™ç”¨æˆ·ï¼‰ã€‚</div>
      <pre>ç™»å½•é“¾æ¥ï¼š${link}
è´¦å·ï¼š${username}
å¯†ç ï¼š${pw}
è§’è‰²ï¼š${role}</pre>
      <div class="hint">ä¸‹ä¸€æ­¥ï¼šå»â€œèŠ‚ç‚¹/å®¹å™¨â€é¡µï¼ŒæŠŠæŸäº›å®¹å™¨åˆ†é…ç»™è¯¥ç”¨æˆ·ï¼ˆå¦åˆ™ç”¨æˆ·ç™»å½•åçœ‹ä¸åˆ°ä»»ä½•å®¹å™¨ï¼‰ã€‚</div>
      <div style="margin-top:10px"><a href="${ENTRY}/admin/users">è¿”å›</a></div>
    `;
    res.send(layout("åˆ›å»ºæˆåŠŸ", req.session.user, body));
  }catch(e){
    res.send(layout("åˆ›å»ºå¤±è´¥", req.session.user, `<pre>${esc(e.message||String(e))}</pre><a href="${ENTRY}/admin/users">è¿”å›</a>`));
  }
});

function randHex(n){ return [...crypto.getRandomValues(new Uint8Array(n/2))].map(x=>x.toString(16).padStart(2,'0')).join(''); }

app.post(ENTRY + "/admin/users/reset", mustAdmin, csrfProtection, async (req,res)=>{
  try{
    const username = String(req.body.username||"").trim();
    if(!username) throw new Error("username empty");
    const pw = (Math.random().toString(36).slice(2,10) + "-" + Math.random().toString(36).slice(2,6));
    const passhash = bcrypt.hashSync(pw, 10);
    const r = await run("UPDATE users SET passhash=? WHERE username=?", [passhash, username]);
    if(r.changes===0) throw new Error("user not found");
    await audit(req.session.user.username, "user.reset", JSON.stringify({username}));
    const ip = cfg.public_host || req.headers.host;
    const link = `http://${ip}${ENTRY}/login?user=${encodeURIComponent(username)}`;
    res.send(layout("é‡ç½®æˆåŠŸ", req.session.user, `<pre>ç™»å½•é“¾æ¥ï¼š${link}\nè´¦å·ï¼š${username}\næ–°å¯†ç ï¼š${pw}</pre><a href="${ENTRY}/admin/users">è¿”å›</a>`));
  }catch(e){
    res.send(layout("é‡ç½®å¤±è´¥", req.session.user, `<pre>${esc(e.message||String(e))}</pre><a href="${ENTRY}/admin/users">è¿”å›</a>`));
  }
});

app.post(ENTRY + "/admin/users/toggle", mustAdmin, csrfProtection, async (req,res)=>{
  try{
    const username = String(req.body.username||"").trim();
    const enabled = Number(req.body.enabled||"0")===1 ? 1 : 0;
    const r = await run("UPDATE users SET enabled=? WHERE username=?", [enabled, username]);
    if(r.changes===0) throw new Error("user not found");
    await audit(req.session.user.username, "user.toggle", JSON.stringify({username, enabled}));
    res.redirect(ENTRY + "/admin/users");
  }catch(e){
    res.send(layout("æ“ä½œå¤±è´¥", req.session.user, `<pre>${esc(e.message||String(e))}</pre><a href="${ENTRY}/admin/users">è¿”å›</a>`));
  }
});

/** ---------------- Admin: Nodes/Instances ---------------- */
app.get(ENTRY + "/admin/nodes", mustAdmin, csrfProtection, async (req,res)=>{
  try{
    const nodes = await panelFetch("GET", "/nodes");
    const list = (nodes.nodes||[]).map(n=>`<option value="${esc(n.id)}">${esc(n.name)} (${esc(n.id)}) @ ${esc(n.url)}</option>`).join("");
    const body = `
      <div class="hint">è¿™é‡Œç›´æ¥é€šè¿‡æœ¬æœåŠ¡ä»£ç†è°ƒç”¨ Panelï¼š/nodesã€/nodes/{id}/...ï¼ˆè§£å†³è·¨åŸŸ & ç»Ÿä¸€é‰´æƒï¼‰ã€‚</div>

      <form method="POST" action="${ENTRY}/admin/node/instances" style="margin-top:10px">
        <input type="hidden" name="_csrf" value="${req.csrfToken()}"/>
        <label>é€‰æ‹©èŠ‚ç‚¹</label>
        <select name="node_id" required>
          <option value="">-- é€‰æ‹©èŠ‚ç‚¹ --</option>
          ${list}
        </select>
        <div style="margin-top:12px"><button class="primary" type="submit">æŸ¥çœ‹è¯¥èŠ‚ç‚¹å®¹å™¨åˆ—è¡¨</button></div>
      </form>

      <hr style="border:none;border-top:1px solid var(--line);margin:14px 0">

      <form method="POST" action="${ENTRY}/admin/pair_token">
        <input type="hidden" name="_csrf" value="${req.csrfToken()}"/>
        <div class="row">
          <div><label>ç”Ÿæˆ Pair Token TTLï¼ˆç§’ï¼‰</label><input name="ttl" value="600" type="number" min="60" max="3600"/></div>
          <div style="display:flex;align-items:end"><button class="good" type="submit">ç”Ÿæˆ Pair Token</button></div>
        </div>
      </form>
    `;
    res.send(layout("èŠ‚ç‚¹/å®¹å™¨", req.session.user, body));
  }catch(e){
    res.send(layout("èŠ‚ç‚¹/å®¹å™¨", req.session.user, `<pre>${esc(e.message||String(e))}</pre>`));
  }
});

app.post(ENTRY + "/admin/pair_token", mustAdmin, csrfProtection, async (req,res)=>{
  try{
    const ttl = Math.max(60, Math.min(3600, Number(req.body.ttl||600)));
    const r = await panelFetch("POST", `/nodes/pair_token?ttl_seconds=${ttl}`);
    await audit(req.session.user.username, "pair_token.create", JSON.stringify({ttl}));
    const body = `<pre>Pair Tokenï¼š${r.token}\nexpires_inï¼š${r.expires_in}s</pre>
    <div class="hint">æŠŠ token è´´åˆ°â€œèŠ‚ç‚¹å®‰è£…è„šæœ¬â€çš„ enroll æ­¥éª¤å³å¯ã€‚</div>
    <a href="${ENTRY}/admin/nodes">è¿”å›</a>`;
    res.send(layout("Pair Token", req.session.user, body));
  }catch(e){
    res.send(layout("ç”Ÿæˆå¤±è´¥", req.session.user, `<pre>${esc(e.message||String(e))}</pre><a href="${ENTRY}/admin/nodes">è¿”å›</a>`));
  }
});

app.post(ENTRY + "/admin/node/instances", mustAdmin, csrfProtection, async (req,res)=>{
  try{
    const nodeId = String(req.body.node_id||"").trim();
    if(!nodeId) throw new Error("node_id empty");
    const inst = await panelFetch("GET", `/nodes/${encodeURIComponent(nodeId)}/instances`);
    const rows = (inst.instances||[]).map(x=>{
      const name = x?.name || x?.Name || x?.instance || x?.server_name || x?.metadata?.name || "";
      const st = x?.status || x?.Status || x?.state || x?.status_code || "";
      return `<tr>
        <td style="padding:8px;border-bottom:1px solid rgba(34,53,95,.55)">${esc(name)}</td>
        <td style="padding:8px;border-bottom:1px solid rgba(34,53,95,.55)">${esc(String(st))}</td>
      </tr>`;
    }).join("");

    const body = `
      <div class="hint">èŠ‚ç‚¹ï¼š<b>${esc(nodeId)}</b></div>

      <h3 style="margin:10px 0 8px;font-size:13px">åˆ›å»ºå®¹å™¨</h3>
      <form method="POST" action="${ENTRY}/admin/instance/create">
        <input type="hidden" name="_csrf" value="${req.csrfToken()}"/>
        <input type="hidden" name="node_id" value="${esc(nodeId)}"/>
        <div class="row">
          <div><label>å®¹å™¨å</label><input name="name" required placeholder="ct-001"/></div>
          <div><label>é•œåƒ</label><input name="image" value="images:ubuntu/22.04"/></div>
        </div>
        <div class="row3">
          <div><label>CPU æ ¸å¿ƒ</label><input name="cpu_cores" type="number" min="1" placeholder="2"/></div>
          <div><label>CPU ä¸Šé™%</label><input name="cpu_limit_percent" type="number" min="1" max="100" placeholder="50"/></div>
          <div><label>å†…å­˜ MB</label><input name="memory_mb" type="number" min="128" placeholder="2048"/></div>
        </div>
        <div class="row3">
          <div><label>ç£ç›˜ GB</label><input name="disk_gb" type="number" min="1" placeholder="20"/></div>
          <div><label>ä¸Šè¡Œ Mbit</label><input name="up_mbit" type="number" min="1" placeholder="50"/></div>
          <div><label>ä¸‹è¡Œ Mbit</label><input name="down_mbit" type="number" min="1" placeholder="200"/></div>
        </div>
        <div style="margin-top:12px"><button class="good" type="submit">åˆ›å»º</button></div>
      </form>

      <hr style="border:none;border-top:1px solid var(--line);margin:14px 0">
      <h3 style="margin:0 0 8px;font-size:13px">å®¹å™¨åˆ—è¡¨ï¼ˆåŸæ ·è¿”å›ï¼Œå¯èƒ½å­—æ®µå›  LXD ç‰ˆæœ¬ç•¥ä¸åŒï¼‰</h3>
      <pre>${esc(JSON.stringify(inst, null, 2))}</pre>

      <hr style="border:none;border-top:1px solid var(--line);margin:14px 0">
      <h3 style="margin:0 0 8px;font-size:13px">ç»™ç”¨æˆ·åˆ†é…å®¹å™¨ï¼ˆRBAC æ˜ å°„ï¼‰</h3>
      <form method="POST" action="${ENTRY}/admin/assign">
        <input type="hidden" name="_csrf" value="${req.csrfToken()}"/>
        <input type="hidden" name="node_id" value="${esc(nodeId)}"/>
        <div class="row">
          <div><label>ç”¨æˆ·å</label><input name="username" placeholder="user001" required/></div>
          <div><label>å®¹å™¨åï¼ˆinstance_nameï¼‰</label><input name="instance_name" placeholder="ct-001" required/></div>
        </div>
        <div style="margin-top:12px"><button type="submit">åˆ†é…ç»™ç”¨æˆ·</button></div>
      </form>

      <div style="margin-top:10px"><a href="${ENTRY}/admin/nodes">è¿”å›</a></div>
    `;
    res.send(layout("èŠ‚ç‚¹å®¹å™¨", req.session.user, body));
  }catch(e){
    res.send(layout("å®¹å™¨åˆ—è¡¨å¤±è´¥", req.session.user, `<pre>${esc(e.message||String(e))}</pre><a href="${ENTRY}/admin/nodes">è¿”å›</a>`));
  }
});

app.post(ENTRY + "/admin/instance/create", mustAdmin, csrfProtection, async (req,res)=>{
  try{
    const node_id = String(req.body.node_id||"").trim();
    const name = String(req.body.name||"").trim();
    const image = String(req.body.image||"images:ubuntu/22.04").trim();
    if(!node_id || !name) throw new Error("node_id/name empty");

    const payload = { name, image };
    const takeNum = (k)=>{ const v = Number(req.body[k]); return Number.isFinite(v) && v>0 ? v : null; };
    const cpu = takeNum("cpu_cores");
    const cpuPct = takeNum("cpu_limit_percent");
    const mem = takeNum("memory_mb");
    const disk = takeNum("disk_gb");
    const up = takeNum("up_mbit");
    const down = takeNum("down_mbit");
    if(cpu) payload.cpu_cores = cpu;
    if(cpuPct) payload.cpu_limit_percent = cpuPct;
    if(mem) payload.memory_mb = mem;
    if(disk) payload.disk_gb = disk;
    if(up) payload.up_mbit = up;
    if(down) payload.down_mbit = down;

    const r = await panelFetch("POST", `/nodes/${encodeURIComponent(node_id)}/instances`, payload);
    await audit(req.session.user.username, "instance.create", JSON.stringify({node_id, name}));
    res.send(layout("åˆ›å»ºç»“æœ", req.session.user, `<pre>${esc(JSON.stringify(r,null,2))}</pre><a href="${ENTRY}/admin/nodes">è¿”å›</a>`));
  }catch(e){
    res.send(layout("åˆ›å»ºå¤±è´¥", req.session.user, `<pre>${esc(e.message||String(e))}</pre><a href="${ENTRY}/admin/nodes">è¿”å›</a>`));
  }
});

app.post(ENTRY + "/admin/assign", mustAdmin, csrfProtection, async (req,res)=>{
  try{
    const username = String(req.body.username||"").trim();
    const node_id = String(req.body.node_id||"").trim();
    const instance_name = String(req.body.instance_name||"").trim();
    if(!username || !node_id || !instance_name) throw new Error("missing fields");
    const u = await get("SELECT id,role FROM users WHERE username=?", [username]);
    if(!u) throw new Error("user not found");
    if(u.role!=="user") throw new Error("åªèƒ½åˆ†é…ç»™ user è§’è‰²ï¼ˆadmin ä¸éœ€è¦åˆ†é…ï¼‰");

    await run("INSERT OR IGNORE INTO assignments(user_id,node_id,instance_name,created_at) VALUES(?,?,?,?)",
      [u.id, node_id, instance_name, new Date().toISOString()]);
    await audit(req.session.user.username, "assign.add", JSON.stringify({username,node_id,instance_name}));
    res.send(layout("åˆ†é…æˆåŠŸ", req.session.user, `<pre>å·²åˆ†é…ï¼š${esc(username)} -> ${esc(node_id)} / ${esc(instance_name)}</pre><a href="${ENTRY}/admin/nodes">è¿”å›</a>`));
  }catch(e){
    res.send(layout("åˆ†é…å¤±è´¥", req.session.user, `<pre>${esc(e.message||String(e))}</pre><a href="${ENTRY}/admin/nodes">è¿”å›</a>`));
  }
});

/** ---------------- Admin/Raw & Audit ---------------- */
app.get(ENTRY + "/admin/audit", mustAdmin, async (req,res)=>{
  const rows = await all("SELECT * FROM audit ORDER BY id DESC LIMIT 200");
  res.send(layout("æœ¬é¢æ¿å®¡è®¡", req.session.user, `<pre>${esc(JSON.stringify(rows,null,2))}</pre>`));
});

app.get(ENTRY + "/admin/raw", mustAdmin, csrfProtection, (req,res)=>{
  const body = `
    <div class="hint">Raw APIï¼šç›´æ¥ä»£ç†è°ƒç”¨ Panelã€‚method/path/body è‡ªå·±å¡«ã€‚</div>
    <form method="POST" action="${ENTRY}/admin/raw">
      <input type="hidden" name="_csrf" value="${req.csrfToken()}"/>
      <div class="row">
        <div><label>Method</label>
          <select name="method"><option>GET</option><option>POST</option><option>PUT</option><option>PATCH</option><option>DELETE</option></select>
        </div>
        <div><label>Pathï¼ˆä»¥ / å¼€å¤´ï¼‰</label><input name="path" value="/nodes"/></div>
      </div>
      <label>JSON Bodyï¼ˆå¯ç©ºï¼‰</label><textarea name="body" placeholder='{"a":1}'></textarea>
      <div style="margin-top:12px"><button class="primary" type="submit">å‘é€</button></div>
    </form>
  `;
  res.send(layout("Raw API", req.session.user, body));
});

app.post(ENTRY + "/admin/raw", mustAdmin, csrfProtection, async (req,res)=>{
  try{
    const method = String(req.body.method||"GET").toUpperCase();
    const p = String(req.body.path||"/health").trim();
    if(!p.startsWith("/")) throw new Error("path must start with /");
    const bodyText = String(req.body.body||"").trim();
    let body = undefined;
    if(bodyText) { body = JSON.parse(bodyText); }
    const r = await panelFetch(method, p, body);
    await audit(req.session.user.username, "raw", JSON.stringify({method,path:p}));
    res.send(layout("Raw ç»“æœ", req.session.user, `<pre>${esc(JSON.stringify(r,null,2))}</pre><a href="${ENTRY}/admin/raw">è¿”å›</a>`));
  }catch(e){
    res.send(layout("Raw å¤±è´¥", req.session.user, `<pre>${esc(e.message||String(e))}</pre><a href="${ENTRY}/admin/raw">è¿”å›</a>`));
  }
});

/** ---------------- User portal ---------------- */
app.get(ENTRY + "/user/instances", mustUser, csrfProtection, async (req,res)=>{
  const me = req.session.user;
  if(me.role==="admin"){
    return res.send(layout("æç¤º", me, `<div class="hint">ä½ æ˜¯ adminï¼Œå»ºè®®å»â€œèŠ‚ç‚¹/å®¹å™¨â€é¡µç®¡ç†å…¨å±€ã€‚</div>`));
  }

  const asg = await all(
    "SELECT a.node_id,a.instance_name FROM assignments a WHERE a.user_id=? ORDER BY a.node_id,a.instance_name",
    [me.id]
  );

  const list = asg.map(x=>`<option value="${esc(x.node_id)}::${esc(x.instance_name)}">${esc(x.node_id)} / ${esc(x.instance_name)}</option>`).join("");
  const body = `
    <div class="hint">ç”¨æˆ·ç«¯åªèƒ½æ“ä½œç®¡ç†å‘˜åˆ†é…ç»™ä½ çš„å®¹å™¨ã€‚</div>

    <h3 style="margin:10px 0 8px;font-size:13px">æˆ‘çš„å®¹å™¨ï¼ˆé€‰æ‹©ä¸€ä¸ªï¼‰</h3>
    <select id="pick" style="width:100%">${list || `<option value="">(æš‚æ— åˆ†é…)</option>`}</select>

    <hr style="border:none;border-top:1px solid var(--line);margin:14px 0">
    <form method="POST" action="${ENTRY}/user/action">
      <input type="hidden" name="_csrf" value="${req.csrfToken()}"/>
      <label>åŠ¨ä½œ</label>
      <select name="action">
        <option value="list_ports">æŸ¥çœ‹ç«¯å£æ± </option>
        <option value="list_instances">æŸ¥çœ‹è¯¥èŠ‚ç‚¹å®¹å™¨åˆ—è¡¨</option>
        <option value="add_port">æ·»åŠ ç«¯å£æ˜ å°„</option>
        <option value="del_port">åˆ é™¤ç«¯å£æ˜ å°„</option>
        <option value="set_limits">è®¾ç½®é™åˆ¶ï¼ˆå«å¸¦å®½ï¼‰</option>
        <option value="reinstall">é‡è£…ï¼ˆå±é™©ï¼‰</option>
        <option value="create_user">å®¹å™¨å†…åˆ›å»ºç”¨æˆ·</option>
      </select>

      <div class="row">
        <div><label>host_portï¼ˆåˆ é™¤æ˜ å°„ç”¨ï¼‰</label><input name="host_port" placeholder="20001"/></div>
        <div><label>container_portï¼ˆæ·»åŠ æ˜ å°„ç”¨ï¼‰</label><input name="container_port" placeholder="22"/></div>
      </div>
      <div class="row">
        <div><label>proto</label><select name="proto"><option value="tcp">tcp</option><option value="udp">udp</option></select></div>
        <div><label>æŒ‡å®šå®¿ä¸»æœºç«¯å£ï¼ˆå¯ç©º=è‡ªåŠ¨åˆ†é…ï¼‰</label><input name="host_port_add" placeholder="2222"/></div>
      </div>

      <div class="row3">
        <div><label>CPU æ ¸å¿ƒ</label><input name="cpu_cores" placeholder="2"/></div>
        <div><label>CPU ä¸Šé™%</label><input name="cpu_limit_percent" placeholder="50"/></div>
        <div><label>å†…å­˜MB</label><input name="memory_mb" placeholder="2048"/></div>
      </div>
      <div class="row3">
        <div><label>ç£ç›˜GB</label><input name="disk_gb" placeholder="20"/></div>
        <div><label>ä¸Šè¡ŒMbit</label><input name="up_mbit" placeholder="50"/></div>
        <div><label>ä¸‹è¡ŒMbit</label><input name="down_mbit" placeholder="200"/></div>
      </div>

      <div class="row">
        <div><label>é‡è£…é•œåƒ</label><input name="image" value="images:debian/12"/></div>
        <div><label>ä¿ç•™ç«¯å£/é™åˆ¶</label>
          <select name="preserve"><option value="1" selected>ä¿ç•™</option><option value="0">ä¸ä¿ç•™</option></select>
        </div>
      </div>

      <div class="row">
        <div><label>å®¹å™¨å†…ç”¨æˆ·å</label><input name="linux_user" placeholder="alice"/></div>
        <div><label>å®¹å™¨å†…å¯†ç ï¼ˆå¯ç©ºï¼‰</label><input name="linux_pass" placeholder="optional"/></div>
      </div>
      <label>SSH å…¬é’¥ï¼ˆå¯ç©ºï¼‰</label><textarea name="ssh_key" placeholder="ssh-ed25519 AAAA..."></textarea>

      <input type="hidden" name="pick" id="pickHidden"/>
      <div style="margin-top:12px"><button class="primary" type="submit">æ‰§è¡Œ</button></div>
    </form>

    <script>
      const s = document.getElementById("pick");
      const h = document.getElementById("pickHidden");
      function sync(){ h.value = s.value; }
      sync(); s.addEventListener("change", sync);
    </script>
  `;
  res.send(layout("æˆ‘çš„å®¹å™¨", me, body));
});

function parsePick(pick){
  const [node_id, instance_name] = String(pick||"").split("::");
  if(!node_id || !instance_name) throw new Error("æœªé€‰æ‹©å®¹å™¨");
  return { node_id, instance_name };
}

async function userAllowed(userId, node_id, instance_name){
  const row = await get(
    "SELECT 1 AS ok FROM assignments WHERE user_id=? AND node_id=? AND instance_name=?",
    [userId, node_id, instance_name]
  );
  return !!row;
}

app.post(ENTRY + "/user/action", mustUser, csrfProtection, async (req,res)=>{
  const me = req.session.user;
  try{
    if(me.role==="admin") throw new Error("admin è¯·èµ°ç®¡ç†ç«¯");
    const { node_id, instance_name } = parsePick(req.body.pick);
    const allowed = await userAllowed(me.id, node_id, instance_name);
    if(!allowed) return res.status(403).send(layout("æ‹’ç»", me, "<div class='hint'>ä½ æ²¡æœ‰æƒé™æ“ä½œè¯¥å®¹å™¨ã€‚</div>"));

    const action = String(req.body.action||"").trim();
    const num = (k)=>{ const v = Number(req.body[k]); return Number.isFinite(v) && v>0 ? v : null; };

    let r = null;
    if(action==="list_ports"){
      r = await panelFetch("GET", `/nodes/${encodeURIComponent(node_id)}/ports`);
    }else if(action==="list_instances"){
      r = await panelFetch("GET", `/nodes/${encodeURIComponent(node_id)}/instances`);
    }else if(action==="add_port"){
      const cp = num("container_port"); if(!cp) throw new Error("container_port å¿…å¡«");
      const proto = String(req.body.proto||"tcp");
      const hp = num("host_port_add");
      const payload = { container_port: cp, proto };
      if(hp) payload.host_port = hp;
      r = await panelFetch("POST", `/nodes/${encodeURIComponent(node_id)}/instances/${encodeURIComponent(instance_name)}/ports`, payload);
    }else if(action==="del_port"){
      const hp = num("host_port"); if(!hp) throw new Error("host_port å¿…å¡«");
      r = await panelFetch("DELETE", `/nodes/${encodeURIComponent(node_id)}/instances/${encodeURIComponent(instance_name)}/ports/${hp}`);
    }else if(action==="set_limits"){
      const payload = {};
      const cpu = num("cpu_cores"); if(cpu) payload.cpu_cores = cpu;
      const cpuPct = num("cpu_limit_percent"); if(cpuPct) payload.cpu_limit_percent = cpuPct;
      const mem = num("memory_mb"); if(mem) payload.memory_mb = mem;
      const disk = num("disk_gb"); if(disk) payload.disk_gb = disk;
      const up = num("up_mbit"); if(up) payload.up_mbit = up;
      const down = num("down_mbit"); if(down) payload.down_mbit = down;
      if(Object.keys(payload).length===0) throw new Error("è‡³å°‘å¡«ä¸€ä¸ªé™åˆ¶é¡¹");
      r = await panelFetch("POST", `/nodes/${encodeURIComponent(node_id)}/instances/${encodeURIComponent(instance_name)}/limits`, payload);
    }else if(action==="reinstall"){
      const image = String(req.body.image||"").trim(); if(!image) throw new Error("image å¿…å¡«");
      const preserve = String(req.body.preserve||"1")==="1";
      r = await panelFetch("POST", `/nodes/${encodeURIComponent(node_id)}/instances/${encodeURIComponent(instance_name)}/reinstall`, {
        image, preserve_ports: preserve, preserve_limits: preserve
      });
    }else if(action==="create_user"){
      const username = String(req.body.linux_user||"").trim(); if(!username) throw new Error("linux_user å¿…å¡«");
      const payload = { username, sudo: true };
      const pw = String(req.body.linux_pass||"").trim(); if(pw) payload.password = pw;
      const key = String(req.body.ssh_key||"").trim(); if(key) payload.ssh_public_key = key;
      r = await panelFetch("POST", `/nodes/${encodeURIComponent(node_id)}/instances/${encodeURIComponent(instance_name)}/users`, payload);
    }else{
      throw new Error("æœªçŸ¥ action");
    }

    await audit(me.username, "user.action", JSON.stringify({node_id, instance_name, action}));
    res.send(layout("æ‰§è¡Œç»“æœ", me, `<pre>${esc(JSON.stringify(r,null,2))}</pre><a href="${ENTRY}/user/instances">è¿”å›</a>`));
  }catch(e){
    res.send(layout("æ‰§è¡Œå¤±è´¥", req.session.user, `<pre>${esc(e.message||String(e))}</pre><a href="${ENTRY}/user/instances">è¿”å›</a>`));
  }
});

app.get(ENTRY + "/user/raw", mustUser, csrfProtection, async (req,res)=>{
  const me = req.session.user;
  const body = `
    <div class="hint">
      è¿™æ˜¯â€œç”¨æˆ· Rawâ€ï¼Œä¸ºäº†å®‰å…¨ï¼šä½ ä»ç„¶åªèƒ½å¯¹â€œå·²åˆ†é…çš„å®¹å™¨â€åšæ“ä½œã€‚
      å¦‚æœä½ è¦æ›´å¼€æ”¾çš„ rawï¼ˆæ¯”å¦‚ /nodes/{id}/instancesï¼‰ï¼Œå»ºè®®åœ¨ç®¡ç†å‘˜ç«¯ç”¨ Rawã€‚
    </div>
    <form method="POST" action="${ENTRY}/user/raw">
      <input type="hidden" name="_csrf" value="${req.csrfToken()}"/>
      <div class="row">
        <div><label>node_id</label><input name="node_id" placeholder="å¿…é¡»æ˜¯åˆ†é…ç»™ä½ çš„èŠ‚ç‚¹"/></div>
        <div><label>instance_name</label><input name="instance_name" placeholder="å¿…é¡»æ˜¯åˆ†é…ç»™ä½ çš„å®¹å™¨"/></div>
      </div>
      <div class="row">
        <div><label>Method</label><select name="method"><option>GET</option><option>POST</option><option>DELETE</option><option>PUT</option><option>PATCH</option></select></div>
        <div><label>Node Pathï¼ˆä»¥ / å¼€å¤´ï¼Œæ¯”å¦‚ /instances/{name}/limitsï¼‰</label><input name="path" value="/instances/ct-001/limits"/></div>
      </div>
      <label>JSON Bodyï¼ˆå¯ç©ºï¼‰</label><textarea name="body" placeholder='{"memory_mb":2048}'></textarea>
      <div style="margin-top:12px"><button class="primary" type="submit">å‘é€</button></div>
    </form>
  `;
  res.send(layout("ç”¨æˆ· Raw", me, body));
});

app.post(ENTRY + "/user/raw", mustUser, csrfProtection, async (req,res)=>{
  const me = req.session.user;
  try{
    const node_id = String(req.body.node_id||"").trim();
    const instance_name = String(req.body.instance_name||"").trim();
    if(!node_id || !instance_name) throw new Error("node_id/instance_name å¿…å¡«");
    const allowed = await userAllowed(me.id, node_id, instance_name);
    if(!allowed) throw new Error("ä½ æ— æƒæ“ä½œè¯¥å®¹å™¨");

    const method = String(req.body.method||"GET").toUpperCase();
    const p = String(req.body.path||"").trim();
    if(!p.startsWith("/")) throw new Error("path must start with /");
    // é¢å¤–é™åˆ¶ï¼šå¿…é¡»åŒ…å«è¯¥å®¹å™¨åï¼Œé¿å…ç”¨æˆ·è¶Šæƒæ‰“åˆ°åˆ«çš„å®¹å™¨
    if(!p.includes(encodeURIComponent(instance_name)) && !p.includes(instance_name)) {
      throw new Error("ä¸ºé˜²è¶Šæƒï¼Œpath å¿…é¡»åŒ…å« instance_name");
    }
    const bodyText = String(req.body.body||"").trim();
    let body = undefined;
    if(bodyText) body = JSON.parse(bodyText);

    const r = await panelFetch(method, `/nodes/${encodeURIComponent(node_id)}${p}`, body);
    await audit(me.username, "user.raw", JSON.stringify({node_id, instance_name, method, path:p}));
    res.send(layout("Raw ç»“æœ", me, `<pre>${esc(JSON.stringify(r,null,2))}</pre><a href="${ENTRY}/user/raw">è¿”å›</a>`));
  }catch(e){
    res.send(layout("Raw å¤±è´¥", req.session.user, `<pre>${esc(e.message||String(e))}</pre><a href="${ENTRY}/user/raw">è¿”å›</a>`));
  }
});

/** ---------------- Health ---------------- */
app.get(ENTRY + "/health", async (req,res)=>{
  try{
    const r = await panelFetch("GET","/health");
    jsonOk(res,{ service:"lxd-webpanel", panel_health:r, entry:ENTRY });
  }catch(e){
    jsonErr(res, e.message||String(e), 502);
  }
});

/** ---------------- Start ---------------- */
await initDb();

app.listen(PORT, "0.0.0.0", ()=>{
  console.log(`[lxd-webpanel] listen :${PORT}`);
  console.log(`[lxd-webpanel] entry  ${ENTRY}/login`);
});
JS

  ok "åº”ç”¨æ–‡ä»¶å†™å…¥å®Œæˆ"
}

npm_install() {
  info "å®‰è£… npm ä¾èµ–ï¼ˆé¦–æ¬¡ä¼šç¨æ…¢ï¼‰..."
  cd "$APP_DIR"
  npm install --omit=dev
  ok "npm ä¾èµ–å®‰è£…å®Œæˆ"
}

write_config() {
  info "ç”Ÿæˆé…ç½®..."
  local entry="/$(rand_hex 10)"
  local admin_user="admin"
  local admin_pass="$(rand_pw 18)"
  local session_secret="$(rand_pw 32)"

  read -r -p "è¯·è¾“å…¥ Panel URLï¼ˆä¾‹å¦‚ http://PANEL_IP:9876ï¼‰: " panel_url
  read -r -p "è¯·è¾“å…¥ Panel admin ç”¨æˆ·åï¼ˆé»˜è®¤ adminï¼‰: " panel_admin_user
  read -r -p "è¯·è¾“å…¥ Panel admin å¯†ç ï¼ˆæ¥è‡ª /etc/lxd-panel-v2/panel.admin.passï¼‰: " panel_admin_pass

  panel_admin_user="${panel_admin_user:-admin}"

  [[ -n "${panel_url:-}" ]] || die "Panel URL ä¸èƒ½ä¸ºç©º"
  [[ -n "${panel_admin_pass:-}" ]] || die "Panel admin å¯†ç ä¸èƒ½ä¸ºç©º"

  mkdir -p "$CFG_DIR" "$DATA_DIR"
  chmod 750 "$DATA_DIR" || true

  cat > "${CFG_DIR}/config.json" << EOF
{
  "listen_port": ${PORT},
  "entry_path": "${entry}",
  "panel_url": "${panel_url%/}",
  "panel_admin_user": "${panel_admin_user}",
  "panel_admin_pass": "${panel_admin_pass}",
  "admin_user": "${admin_user}",
  "admin_pass": "${admin_pass}",
  "session_secret": "${session_secret}",
  "public_host": ""
}
EOF
  chmod 600 "${CFG_DIR}/config.json"
  ok "é…ç½®å·²ç”Ÿæˆï¼š${CFG_DIR}/config.json"

  echo "${entry}" > "${CFG_DIR}/entry.path"
  echo "${admin_user}" > "${CFG_DIR}/admin.user"
  echo "${admin_pass}" > "${CFG_DIR}/admin.pass"
  chmod 600 "${CFG_DIR}/entry.path" "${CFG_DIR}/admin.user" "${CFG_DIR}/admin.pass"
}

write_systemd() {
  info "æ³¨å†Œ systemd..."
  cat > "/etc/systemd/system/${SERVICE_NAME}.service" << EOF
[Unit]
Description=LXD WebPanel (Admin/User, proxy to Panel)
After=network.target

[Service]
Type=simple
Environment=CFG_PATH=${CFG_DIR}/config.json
Environment=DATA_DIR=${DATA_DIR}
WorkingDirectory=${APP_DIR}
ExecStart=/usr/bin/node ${APP_DIR}/server.js
Restart=always
RestartSec=2
User=root
NoNewPrivileges=true
PrivateTmp=true
ProtectHome=true
ProtectSystem=full
ReadWritePaths=${DATA_DIR} ${CFG_DIR} ${APP_DIR}

[Install]
WantedBy=multi-user.target
EOF

  systemctl daemon-reload
  systemctl enable "${SERVICE_NAME}" >/dev/null
  systemctl restart "${SERVICE_NAME}"
  ok "æœåŠ¡å·²å¯åŠ¨ï¼š${SERVICE_NAME}"
}

show_result() {
  local ip entry admin_user admin_pass
  ip="$(host_ip)"
  entry="$(cat "${CFG_DIR}/entry.path")"
  admin_user="$(cat "${CFG_DIR}/admin.user")"
  alignment="=========================================================="
  admin_pass="$(cat "${CFG_DIR}/admin.pass")"

  echo -e "\n${GREEN}${alignment}${PLAIN}"
  echo -e "${GREEN}[LXD WebPanel å·²éƒ¨ç½²å®Œæˆ]${PLAIN}"
  echo -e "ç™»å½•å…¥å£ï¼š${BLUE}http://${ip}:${PORT}${entry}/login${PLAIN}"
  echo -e "ç®¡ç†å‘˜è´¦å·ï¼š${YELLOW}${admin_user}${PLAIN}"
  echo -e "ç®¡ç†å‘˜å¯†ç ï¼š${YELLOW}${admin_pass}${PLAIN}"
  echo -e "${GREEN}${alignment}${PLAIN}\n"

  echo -e "${YELLOW}å»ºè®®ï¼ˆç”Ÿäº§ï¼‰ï¼š${PLAIN}"
  echo -e "1) ç”¨ Nginx åš HTTPS + åä»£åˆ° 127.0.0.1:${PORT}ï¼ˆé˜²æ­¢æ˜æ–‡ç™»å½•ï¼‰"
  echo -e "2) entry_path å…¥å£ä¸è¦æ³„éœ²ç»™æ— å…³äººå‘˜ï¼ˆåƒå®å¡”ä¸€æ ·ï¼‰"
  echo -e "3) Panel ä¸ Node-Agent é€šä¿¡å»ºè®®èµ°å†…ç½‘/VPN/mTLS\n"
}

main() {
  install_deps
  install_node
  write_app_files
  npm_install
  write_config
  write_systemd
  show_result
}

main
