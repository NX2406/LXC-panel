#!/bin/bash
set -euo pipefail

RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[0;33m'; BLUE='\033[0;36m'; PLAIN='\033[0m'
info(){ echo -e "${BLUE}[INFO]${PLAIN} $*"; }
ok(){ echo -e "${GREEN}[OK]${PLAIN} $*"; }
warn(){ echo -e "${YELLOW}[WARN]${PLAIN} $*"; }
die(){ echo -e "${RED}[ERR]${PLAIN} $*"; exit 1; }

[[ $EUID -eq 0 ]] || die "请用 root 运行"
export DEBIAN_FRONTEND=noninteractive

PORT="${PORT:-2095}"
APP_DIR="/opt/lxd-3xui-panel"
CFG_DIR="/etc/lxd-3xui-panel"
DATA_DIR="/var/lib/lxd-3xui-panel"
SVC="lxd-3xui-panel"

rand_hex(){ tr -dc 'a-f0-9' </dev/urandom | head -c "${1:-16}"; }
rand_pw(){ tr -dc 'A-Za-z0-9_@#%+=' </dev/urandom | head -c "${1:-18}"; }

host_ip() {
  local ip
  ip="$(hostname -I 2>/dev/null | awk '{print $1}')"
  [[ -z "${ip}" ]] && ip="127.0.0.1"
  echo "$ip"
}

install_deps(){
  info "安装系统依赖..."
  apt-get update -y
  apt-get install -y ca-certificates curl gnupg git sqlite3 build-essential python3 make g++
  ok "系统依赖安装完成"
}

install_node(){
  if command -v node >/dev/null 2>&1; then
    ok "Node 已存在：$(node -v)"
    return
  fi
  info "安装 Node.js 18..."
  curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
  apt-get install -y nodejs
  ok "Node 已安装：$(node -v)"
}

write_files(){
  info "写入应用文件..."
  mkdir -p "$APP_DIR" "$CFG_DIR" "$DATA_DIR"
  chmod 750 "$DATA_DIR" || true

  cat > "$APP_DIR/package.json" <<'JSON'
{
  "name": "lxd-3xui-panel",
  "version": "2.0.0",
  "private": true,
  "type": "module",
  "main": "server.js",
  "scripts": { "start": "node server.js" },
  "dependencies": {
    "bcryptjs": "^2.4.3",
    "cookie-parser": "^1.4.6",
    "csurf": "^1.11.0",
    "express": "^4.19.2",
    "express-rate-limit": "^7.4.1",
    "express-session": "^1.17.3",
    "sqlite3": "^5.1.7"
  }
}
JSON

  cat > "$APP_DIR/server.js" <<'JS'
import express from "express";
import session from "express-session";
import rateLimit from "express-rate-limit";
import cookieParser from "cookie-parser";
import csrf from "csurf";
import bcrypt from "bcryptjs";
import sqlite3 from "sqlite3";
import fs from "fs";
import path from "path";

const CFG_PATH = process.env.CFG_PATH || "/etc/lxd-3xui-panel/config.json";
const DATA_DIR = process.env.DATA_DIR || "/var/lib/lxd-3xui-panel";
const DB_PATH = path.join(DATA_DIR, "panel.db");

function die(msg){ console.error(msg); process.exit(1); }
function esc(s){ return String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
function nowIso(){ return new Date().toISOString(); }

if(!fs.existsSync(CFG_PATH)) die("Missing config: " + CFG_PATH);
const cfg = JSON.parse(fs.readFileSync(CFG_PATH, "utf-8"));
const ENTRY = (cfg.entry_path || "/panel").replace(/\/+$/,"");
const PORT = Number(cfg.listen_port || 2095);

sqlite3.verbose();
const db = new sqlite3.Database(DB_PATH);
const run = (sql, params=[]) => new Promise((res, rej)=>db.run(sql, params, function(err){ err?rej(err):res(this); }));
const get = (sql, params=[]) => new Promise((res, rej)=>db.get(sql, params, (err,row)=>err?rej(err):res(row)));
const all = (sql, params=[]) => new Promise((res, rej)=>db.all(sql, params, (err,rows)=>err?rej(err):res(rows)));

async function audit(actor, action, detail){
  await run("INSERT INTO audit(ts,actor,action,detail) VALUES(?,?,?,?)",
    [Date.now(), actor, action, JSON.stringify(detail ?? {}, null, 0)]);
}

async function initDb(){
  await run(`CREATE TABLE IF NOT EXISTS users(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    passhash TEXT NOT NULL,
    role TEXT NOT NULL,
    enabled INTEGER NOT NULL DEFAULT 1,
    created_at TEXT NOT NULL
  )`);
  await run(`CREATE TABLE IF NOT EXISTS backends(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    base_url TEXT NOT NULL,
    admin_user TEXT NOT NULL,
    admin_pass TEXT NOT NULL,
    is_default INTEGER NOT NULL DEFAULT 0,
    enabled INTEGER NOT NULL DEFAULT 1,
    created_at TEXT NOT NULL
  )`);
  await run(`CREATE TABLE IF NOT EXISTS assignments(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    backend_id INTEGER NOT NULL,
    node_id TEXT NOT NULL,
    instance_name TEXT NOT NULL,
    created_at TEXT NOT NULL,
    UNIQUE(user_id, backend_id, node_id, instance_name)
  )`);
  await run(`CREATE TABLE IF NOT EXISTS audit(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    ts INTEGER NOT NULL,
    actor TEXT NOT NULL,
    action TEXT NOT NULL,
    detail TEXT NOT NULL
  )`);

  // bootstrap admin
  const adminUser = cfg.admin_user || "admin";
  const adminPass = cfg.admin_pass || "";
  if(!adminPass) die("config.admin_pass empty");
  const row = await get("SELECT id FROM users WHERE username=?", [adminUser]);
  if(!row){
    const passhash = bcrypt.hashSync(adminPass, 10);
    await run("INSERT INTO users(username, passhash, role, enabled, created_at) VALUES(?,?,?,?,?)",
      [adminUser, passhash, "admin", 1, nowIso()]);
    await audit("system","admin.bootstrap",{adminUser});
  }
}

/** ---- Backend connector (Panel API) ---- */
const jwtCache = new Map(); // backend_id -> {token, at}

async function pickDefaultBackend(){
  const b = await get("SELECT * FROM backends WHERE enabled=1 AND is_default=1 ORDER BY id DESC LIMIT 1");
  if(b) return b;
  return await get("SELECT * FROM backends WHERE enabled=1 ORDER BY id DESC LIMIT 1");
}

async function backendLogin(backend){
  const c = jwtCache.get(backend.id);
  const now = Date.now();
  if(c?.token && (now - c.at) < 15*60*1000) return c.token;

  const url = backend.base_url.replace(/\/+$/,"") + "/auth/login";
  const r = await fetch(url, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ username: backend.admin_user, password: backend.admin_pass })
  });
  const txt = await r.text();
  let j=null; try{ j = txt?JSON.parse(txt):null; }catch{}
  if(!r.ok) throw new Error(j?.detail || j?.message || txt || ("backend login failed " + r.status));
  if(!j?.token) throw new Error("backend login missing token");
  jwtCache.set(backend.id, { token: j.token, at: now });
  return j.token;
}

async function backendFetch(backend, method, apiPath, body){
  const token = await backendLogin(backend);
  const base = backend.base_url.replace(/\/+$/,"");
  const url = base + apiPath;
  const headers = { "Authorization":"Bearer " + token };
  if(body !== undefined) headers["Content-Type"]="application/json";
  const r = await fetch(url, { method, headers, body: body===undefined?undefined:JSON.stringify(body) });
  const txt = await r.text();
  let j=null; try{ j = txt?JSON.parse(txt):null; }catch{}
  if(!r.ok) throw new Error(j?.detail || j?.message || txt || ("backend request failed "+r.status));
  return j ?? txt;
}

/** ---- Web app ---- */
const app = express();
app.disable("x-powered-by");
app.set("trust proxy", 1);

app.use(express.urlencoded({ extended:false, limit:"1mb" }));
app.use(express.json({ limit:"1mb" }));
app.use(cookieParser());

app.use(rateLimit({
  windowMs: 60_000,
  limit: 220,
  standardHeaders: "draft-7",
  legacyHeaders: false
}));

app.use(session({
  secret: cfg.session_secret || "change-me",
  resave: false,
  saveUninitialized: false,
  cookie: { httpOnly:true, sameSite:"lax", secure:false, maxAge: 7*24*3600*1000 }
}));

const csrfProtection = csrf({ cookie:false });

function mustLogin(req,res,next){
  if(!req.session.user) return res.redirect(ENTRY + "/login");
  next();
}
function mustAdmin(req,res,next){
  if(!req.session.user || req.session.user.role!=="admin") return res.status(403).send("Forbidden");
  next();
}
function mustUser(req,res,next){
  if(!req.session.user || (req.session.user.role!=="user" && req.session.user.role!=="admin")) return res.status(403).send("Forbidden");
  next();
}

/** ---- 3x-ui-like layout ---- */
function layout(title, user, body, bannerHtml=""){
  const u = user ? `${esc(user.username)} <span class="pill">${esc(user.role)}</span>` : `<span class="muted">未登录</span>`;
  const navAdmin = user?.role==="admin" ? `
    <a class="nav" href="${ENTRY}/admin/dashboard">仪表盘</a>
    <a class="nav" href="${ENTRY}/admin/backends">后端连接</a>
    <a class="nav" href="${ENTRY}/admin/nodes">节点/容器</a>
    <a class="nav" href="${ENTRY}/admin/users">用户管理</a>
    <a class="nav" href="${ENTRY}/admin/audit">审计</a>
    <a class="nav" href="${ENTRY}/admin/raw">Raw</a>
  ` : "";
  const navUser = (user && user.role!=="admin") ? `
    <a class="nav" href="${ENTRY}/user/instances">我的容器</a>
    <a class="nav" href="${ENTRY}/user/raw">Raw</a>
  ` : "";
  const navAuth = user ? `<a class="nav danger" href="${ENTRY}/logout">退出</a>` : `<a class="nav" href="${ENTRY}/login">登录</a>`;
  return `<!doctype html>
<html lang="zh-CN"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>${esc(title)}</title>
<style>
:root{
  --bg:#0b0f14; --panel:#0f1620; --card:#0f1b26; --line:#1b2a3a;
  --text:#e8f0ff; --muted:#90a4b8; --accent:#3aa0ff; --good:#22c55e; --warn:#fbbf24; --bad:#ef4444;
  --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
  --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#0a0f14 0%,#070b10 100%);color:var(--text);font-family:var(--sans)}
a{color:inherit;text-decoration:none}
a:hover{opacity:.92}
.topbar{
  height:54px; display:flex; align-items:center; justify-content:space-between;
  padding:0 16px; background:rgba(10,15,20,.92); border-bottom:1px solid var(--line);
  position:sticky; top:0; z-index:10; backdrop-filter: blur(10px);
}
.brand{display:flex;gap:10px;align-items:center;font-weight:700}
.brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 18px rgba(58,160,255,.55)}
.userbox{font-size:12px;color:var(--muted)}
.pill{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;margin-left:6px;color:var(--muted)}
.shell{display:grid;grid-template-columns:240px 1fr;gap:12px;max-width:1280px;margin:0 auto;padding:12px}
.sidebar{
  background:linear-gradient(180deg,rgba(15,22,32,.92),rgba(12,18,26,.92));
  border:1px solid var(--line); border-radius:14px; padding:10px;
  position:sticky; top:66px; height:calc(100vh - 78px);
}
.section{margin:10px 0 6px;font-size:11px;color:var(--muted);letter-spacing:.12em;text-transform:uppercase}
.nav{
  display:block;padding:10px 10px;margin:6px 0;border-radius:12px;border:1px solid rgba(27,42,58,.9);
  background:rgba(10,15,20,.35);
}
.nav:hover{border-color:rgba(58,160,255,.55)}
.nav.danger{border-color:rgba(239,68,68,.4)}
.main{display:flex;flex-direction:column;gap:12px}
.card{
  background:linear-gradient(180deg,rgba(15,27,38,.92),rgba(12,18,26,.92));
  border:1px solid var(--line); border-radius:14px;
}
.card h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--line);font-size:13px}
.card .body{padding:12px 14px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
label{display:block;margin:10px 0 6px;font-size:12px;color:var(--muted)}
input,select,textarea{
  width:100%; padding:10px; border-radius:12px; border:1px solid rgba(27,42,58,.9);
  background:#0a0f14; color:var(--text); outline:none; font-size:13px;
}
textarea{min-height:120px;font-family:var(--mono);font-size:12px}
button{
  padding:10px 12px; border-radius:12px; border:1px solid rgba(27,42,58,.9);
  background:#0a0f14; color:var(--text); cursor:pointer; font-size:13px;
}
button.primary{border-color:rgba(58,160,255,.55); background:rgba(58,160,255,.12)}
button.good{border-color:rgba(34,197,94,.55); background:rgba(34,197,94,.12)}
button.bad{border-color:rgba(239,68,68,.55); background:rgba(239,68,68,.12)}
.muted{color:var(--muted)}
pre{white-space:pre-wrap;word-break:break-word;background:rgba(10,15,20,.35);border:1px solid var(--line);border-radius:12px;padding:10px;font-family:var(--mono);font-size:12px}
.banner{
  border:1px solid rgba(251,191,36,.35);
  background:rgba(251,191,36,.08);
  padding:10px 12px;border-radius:14px;color:var(--muted)
}
@media(max-width:980px){.shell{grid-template-columns:1fr}.sidebar{position:relative;top:auto;height:auto}}
</style></head>
<body>
  <div class="topbar">
    <div class="brand"><span class="dot"></span> LXD Panel UI <span class="pill">3x-ui style</span></div>
    <div class="userbox">入口：<b>${esc(ENTRY)}</b> · ${u}</div>
  </div>
  <div class="shell">
    <div class="sidebar">
      <div class="section">Navigation</div>
      ${navAdmin}
      ${navUser}
      ${navAuth}
      <div class="section">Status</div>
      <div class="muted" style="font-size:12px;line-height:1.6">
        独立运行：✅<br/>
        后端连接：在“后端连接”添加 Panel<br/>
      </div>
    </div>
    <div class="main">
      ${bannerHtml}
      <div class="card"><h2>${esc(title)}</h2><div class="body">${body}</div></div>
    </div>
  </div>
</body></html>`;
}

function banner(msg){ return `<div class="banner">${msg}</div>`; }

/** ---- routes ---- */
app.get("/", (req,res)=>res.redirect(ENTRY + "/login"));
app.get(ENTRY, (req,res)=>res.redirect(ENTRY + "/login"));

app.get(ENTRY + "/login", csrfProtection, async (req,res)=>{
  const u = (req.query.user||"").toString();
  const body = `
    <div class="muted" style="line-height:1.7">
      这是独立面板：即使没有安装后端 Panel，也可以先登录、创建用户、配置后端连接。<br/>
      管理员在“后端连接”里添加 Panel 后，才会启用节点/容器操作。
    </div>
    <form method="POST" action="${ENTRY}/login" style="margin-top:10px">
      <input type="hidden" name="_csrf" value="${req.csrfToken()}"/>
      <label>用户名</label><input name="username" value="${esc(u)}" required/>
      <label>密码</label><input name="password" type="password" required/>
      <div style="margin-top:12px"><button class="primary" type="submit">登录</button></div>
    </form>
  `;
  res.send(layout("登录", null, body));
});

app.post(ENTRY + "/login", csrfProtection, async (req,res)=>{
  const { username, password } = req.body || {};
  try{
    const row = await get("SELECT id,username,passhash,role,enabled FROM users WHERE username=?", [String(username||"")]);
    if(!row) return res.send(layout("登录失败", null, `<div class="muted">账号或密码错误。</div>`));
    if(Number(row.enabled)!==1) return res.send(layout("登录失败", null, `<div class="muted">账号已禁用。</div>`));
    const okp = bcrypt.compareSync(String(password||""), row.passhash);
    if(!okp) return res.send(layout("登录失败", null, `<div class="muted">账号或密码错误。</div>`));
    req.session.user = { id: row.id, username: row.username, role: row.role };
    await audit(row.username,"login",{role:row.role});
    return res.redirect(row.role==="admin" ? (ENTRY + "/admin/dashboard") : (ENTRY + "/user/instances"));
  }catch(e){
    res.send(layout("登录失败", null, `<pre>${esc(e.message||String(e))}</pre>`));
  }
});

app.get(ENTRY + "/logout", async (req,res)=>{
  const u = req.session.user?.username || "unknown";
  req.session.destroy(()=>{});
  try{ await audit(u,"logout",{}); }catch{}
  res.redirect(ENTRY + "/login");
});

/** ---- Admin: dashboard ---- */
app.get(ENTRY + "/admin/dashboard", mustAdmin, async (req,res)=>{
  const b = await pickDefaultBackend();
  const backends = await all("SELECT id,name,base_url,enabled,is_default,created_at FROM backends ORDER BY id DESC");
  const users = await all("SELECT id,username,role,enabled,created_at FROM users ORDER BY id DESC LIMIT 30");
  let bannerHtml = "";
  if(!b) bannerHtml = banner("⚠️ 你还没有添加任何后端 Panel 连接：去【后端连接】添加。面板仍可独立使用（账号/用户/分配关系等）。");
  const body = `
    <div class="grid2">
      <div class="card" style="border-radius:14px"><h2>后端连接概览</h2><div class="body">
        <div class="muted">默认后端：${b ? `<b>${esc(b.name)}</b> (${esc(b.base_url)})` : `<b>未设置</b>`}</div>
        <div style="margin-top:10px"><a class="nav" href="${ENTRY}/admin/backends">进入后端连接</a></div>
      </div></div>
      <div class="card" style="border-radius:14px"><h2>账号体系（独立）</h2><div class="body">
        <div class="muted">管理员可以创建用户、重置密码、禁用用户，即使无后端也可操作。</div>
        <div style="margin-top:10px"><a class="nav" href="${ENTRY}/admin/users">进入用户管理</a></div>
      </div></div>
    </div>
    <div style="margin-top:12px" class="muted">后端连接数：<b>${backends.length}</b> · 用户数：<b>${users.length}</b></div>
  `;
  res.send(layout("仪表盘", req.session.user, body, bannerHtml));
});

/** ---- Admin: backends (independent) ---- */
app.get(ENTRY + "/admin/backends", mustAdmin, csrfProtection, async (req,res)=>{
  const rows = await all("SELECT * FROM backends ORDER BY id DESC");
  const body = `
    <div class="muted" style="line-height:1.7">
      这里是“可插拔后端”。你可以先不装后端，面板也能登录运行。<br/>
      当你添加一个 Panel 后端连接并设为默认后，节点/容器功能自动启用。
    </div>

    <form method="POST" action="${ENTRY}/admin/backends/add" style="margin-top:10px">
      <input type="hidden" name="_csrf" value="${req.csrfToken()}"/>
      <div class="grid2">
        <div><label>名称</label><input name="name" placeholder="prod-panel" required/></div>
        <div><label>Panel Base URL</label><input name="base_url" placeholder="http://PANEL_IP:9876" required/></div>
      </div>
      <div class="grid2">
        <div><label>Panel Admin 用户</label><input name="admin_user" value="admin" required/></div>
        <div><label>Panel Admin 密码</label><input name="admin_pass" placeholder="从 panel.admin.pass 复制" required/></div>
      </div>
      <div style="margin-top:12px">
        <button class="good" type="submit">添加后端</button>
      </div>
    </form>

    <hr style="border:none;border-top:1px solid var(--line);margin:14px 0">

    <h3 style="margin:0 0 8px;font-size:13px">已添加后端</h3>
    <pre>${esc(JSON.stringify(rows.map(r=>({id:r.id,name:r.name,base_url:r.base_url,enabled:r.enabled,is_default:r.is_default,created_at:r.created_at})), null, 2))}</pre>

    <form method="POST" action="${ENTRY}/admin/backends/set_default" style="margin-top:10px">
      <input type="hidden" name="_csrf" value="${req.csrfToken()}"/>
      <label>设为默认（填写 backend_id）</label>
      <div class="grid2">
        <input name="id" placeholder="例如 1" required/>
        <button class="primary" type="submit">设为默认</button>
      </div>
    </form>

    <form method="POST" action="${ENTRY}/admin/backends/toggle" style="margin-top:10px">
      <input type="hidden" name="_csrf" value="${req.csrfToken()}"/>
      <div class="grid3">
        <div><label>backend_id</label><input name="id" required/></div>
        <div><label>启用/禁用</label><select name="enabled"><option value="1">启用</option><option value="0">禁用</option></select></div>
        <div style="display:flex;align-items:end"><button type="submit" class="bad">执行</button></div>
      </div>
    </form>

    <form method="POST" action="${ENTRY}/admin/backends/test" style="margin-top:10px">
      <input type="hidden" name="_csrf" value="${req.csrfToken()}"/>
      <div class="grid2">
        <div><label>测试连接 backend_id（可空=默认）</label><input name="id" placeholder="留空测试默认"/></div>
        <div style="display:flex;align-items:end"><button type="submit">测试 /health</button></div>
      </div>
    </form>
  `;
  res.send(layout("后端连接", req.session.user, body));
});

app.post(ENTRY + "/admin/backends/add", mustAdmin, csrfProtection, async (req,res)=>{
  try{
    const name = String(req.body.name||"").trim();
    const base_url = String(req.body.base_url||"").trim().replace(/\/+$/,"");
    const admin_user = String(req.body.admin_user||"admin").trim();
    const admin_pass = String(req.body.admin_pass||"").trim();
    if(!name || !base_url || !admin_pass) throw new Error("字段不能为空");
    await run("INSERT INTO backends(name,base_url,admin_user,admin_pass,is_default,enabled,created_at) VALUES(?,?,?,?,?,?,?)",
      [name, base_url, admin_user, admin_pass, 0, 1, nowIso()]);
    await audit(req.session.user.username,"backend.add",{name,base_url});
    res.redirect(ENTRY + "/admin/backends");
  }catch(e){
    res.send(layout("添加失败", req.session.user, `<pre>${esc(e.message||String(e))}</pre><a class="nav" href="${ENTRY}/admin/backends">返回</a>`));
  }
});

app.post(ENTRY + "/admin/backends/set_default", mustAdmin, csrfProtection, async (req,res)=>{
  try{
    const id = Number(req.body.id);
    if(!Number.isFinite(id) || id<=0) throw new Error("id 不合法");
    await run("UPDATE backends SET is_default=0");
    const r = await run("UPDATE backends SET is_default=1 WHERE id=?", [id]);
    if(r.changes===0) throw new Error("backend 不存在");
    await audit(req.session.user.username,"backend.set_default",{id});
    res.redirect(ENTRY + "/admin/backends");
  }catch(e){
    res.send(layout("设置失败", req.session.user, `<pre>${esc(e.message||String(e))}</pre><a class="nav" href="${ENTRY}/admin/backends">返回</a>`));
  }
});

app.post(ENTRY + "/admin/backends/toggle", mustAdmin, csrfProtection, async (req,res)=>{
  try{
    const id = Number(req.body.id);
    const enabled = Number(req.body.enabled)==="1" || Number(req.body.enabled)===1 ? 1 : 0;
    const r = await run("UPDATE backends SET enabled=? WHERE id=?", [enabled, id]);
    if(r.changes===0) throw new Error("backend 不存在");
    await audit(req.session.user.username,"backend.toggle",{id, enabled});
    res.redirect(ENTRY + "/admin/backends");
  }catch(e){
    res.send(layout("操作失败", req.session.user, `<pre>${esc(e.message||String(e))}</pre><a class="nav" href="${ENTRY}/admin/backends">返回</a>`));
  }
});

app.post(ENTRY + "/admin/backends/test", mustAdmin, csrfProtection, async (req,res)=>{
  try{
    const idTxt = String(req.body.id||"").trim();
    let b = null;
    if(idTxt){
      const id = Number(idTxt);
      b = await get("SELECT * FROM backends WHERE id=?", [id]);
    }else{
      b = await pickDefaultBackend();
    }
    if(!b) throw new Error("没有可用后端（请先添加）");
    const r = await backendFetch(b, "GET", "/health");
    await audit(req.session.user.username,"backend.test",{id:b.id});
    res.send(layout("测试成功", req.session.user, `<pre>${esc(JSON.stringify(r,null,2))}</pre><a class="nav" href="${ENTRY}/admin/backends">返回</a>`));
  }catch(e){
    res.send(layout("测试失败", req.session.user, `<pre>${esc(e.message||String(e))}</pre><a class="nav" href="${ENTRY}/admin/backends">返回</a>`));
  }
});

/** ---- Admin: users (independent) ---- */
app.get(ENTRY + "/admin/users", mustAdmin, csrfProtection, async (req,res)=>{
  const users = await all("SELECT id,username,role,enabled,created_at FROM users ORDER BY id DESC");
  const body = `
    <div class="muted">账号体系完全独立：没装后端也能创建用户并发链接。</div>

    <form method="POST" action="${ENTRY}/admin/users/create" style="margin-top:10px">
      <input type="hidden" name="_csrf" value="${req.csrfToken()}"/>
      <div class="grid2">
        <div><label>用户名</label><input name="username" placeholder="user001" required/></div>
        <div><label>角色</label>
          <select name="role"><option value="user" selected>user</option><option value="admin">admin</option></select>
        </div>
      </div>
      <div style="margin-top:12px"><button class="good" type="submit">创建用户（自动生成密码）</button></div>
    </form>

    <form method="POST" action="${ENTRY}/admin/users/reset" style="margin-top:10px">
      <input type="hidden" name="_csrf" value="${req.csrfToken()}"/>
      <div class="grid2">
        <div><label>重置密码：用户名</label><input name="username" required/></div>
        <div style="display:flex;align-items:end"><button type="submit">重置</button></div>
      </div>
    </form>

    <form method="POST" action="${ENTRY}/admin/users/toggle" style="margin-top:10px">
      <input type="hidden" name="_csrf" value="${req.csrfToken()}"/>
      <div class="grid3">
        <div><label>用户名</label><input name="username" required/></div>
        <div><label>启用</label><select name="enabled"><option value="1">启用</option><option value="0">禁用</option></select></div>
        <div style="display:flex;align-items:end"><button class="bad" type="submit">执行</button></div>
      </div>
    </form>

    <hr style="border:none;border-top:1px solid var(--line);margin:14px 0">
    <pre>${esc(JSON.stringify(users, null, 2))}</pre>

    <div class="muted">用户登录链接模板：<b>${esc(ENTRY)}/login?user=USERNAME</b></div>
  `;
  res.send(layout("用户管理", req.session.user, body));
});

function genUserPass(){
  const a = Math.random().toString(36).slice(2,10);
  const b = Math.random().toString(36).slice(2,6);
  return `${a}-${b}`;
}

app.post(ENTRY + "/admin/users/create", mustAdmin, csrfProtection, async (req,res)=>{
  try{
    const username = String(req.body.username||"").trim();
    const role = (String(req.body.role||"user")==="admin") ? "admin" : "user";
    if(!username) throw new Error("username empty");
    const pw = genUserPass();
    const passhash = bcrypt.hashSync(pw, 10);
    await run("INSERT INTO users(username, passhash, role, enabled, created_at) VALUES(?,?,?,?,?)",
      [username, passhash, role, 1, nowIso()]);
    await audit(req.session.user.username,"user.create",{username, role});
    const host = cfg.public_host || req.headers.host;
    const link = `http://${host}${ENTRY}/login?user=${encodeURIComponent(username)}`;
    res.send(layout("创建成功", req.session.user,
      `<pre>登录链接：${esc(link)}\n账号：${esc(username)}\n密码：${esc(pw)}\n角色：${esc(role)}</pre>
       <a class="nav" href="${ENTRY}/admin/users">返回</a>`));
  }catch(e){
    res.send(layout("创建失败", req.session.user, `<pre>${esc(e.message||String(e))}</pre><a class="nav" href="${ENTRY}/admin/users">返回</a>`));
  }
});

app.post(ENTRY + "/admin/users/reset", mustAdmin, csrfProtection, async (req,res)=>{
  try{
    const username = String(req.body.username||"").trim();
    if(!username) throw new Error("username empty");
    const pw = genUserPass();
    const passhash = bcrypt.hashSync(pw, 10);
    const r = await run("UPDATE users SET passhash=? WHERE username=?", [passhash, username]);
    if(r.changes===0) throw new Error("user not found");
    await audit(req.session.user.username,"user.reset",{username});
    const host = cfg.public_host || req.headers.host;
    const link = `http://${host}${ENTRY}/login?user=${encodeURIComponent(username)}`;
    res.send(layout("重置成功", req.session.user,
      `<pre>登录链接：${esc(link)}\n账号：${esc(username)}\n新密码：${esc(pw)}</pre>
       <a class="nav" href="${ENTRY}/admin/users">返回</a>`));
  }catch(e){
    res.send(layout("重置失败", req.session.user, `<pre>${esc(e.message||String(e))}</pre><a class="nav" href="${ENTRY}/admin/users">返回</a>`));
  }
});

app.post(ENTRY + "/admin/users/toggle", mustAdmin, csrfProtection, async (req,res)=>{
  try{
    const username = String(req.body.username||"").trim();
    const enabled = Number(req.body.enabled)===1 || String(req.body.enabled)==="1" ? 1 : 0;
    const r = await run("UPDATE users SET enabled=? WHERE username=?", [enabled, username]);
    if(r.changes===0) throw new Error("user not found");
    await audit(req.session.user.username,"user.toggle",{username, enabled});
    res.redirect(ENTRY + "/admin/users");
  }catch(e){
    res.send(layout("操作失败", req.session.user, `<pre>${esc(e.message||String(e))}</pre><a class="nav" href="${ENTRY}/admin/users">返回</a>`));
  }
});

/** ---- Admin: nodes/instances (requires backend but page still loads) ---- */
app.get(ENTRY + "/admin/nodes", mustAdmin, csrfProtection, async (req,res)=>{
  let b = await pickDefaultBackend();
  let bannerHtml = "";
  if(!b){
    bannerHtml = banner("⚠️ 未配置后端 Panel。你仍可使用本面板，但节点/容器功能需要先在【后端连接】添加 Panel 并设为默认。");
    const body = `<div class="muted">没有后端连接，无法拉取 nodes。</div>
                  <a class="nav" href="${ENTRY}/admin/backends">去添加后端连接</a>`;
    return res.send(layout("节点/容器", req.session.user, body, bannerHtml));
  }
  try{
    const nodes = await backendFetch(b, "GET", "/nodes");
    const list = (nodes.nodes||[]).map(n=>`<option value="${esc(n.id)}">${esc(n.name)} (${esc(n.id)}) @ ${esc(n.url)}</option>`).join("");
    const body = `
      <div class="muted">当前默认后端：<b>${esc(b.name)}</b> · ${esc(b.base_url)}</div>

      <form method="POST" action="${ENTRY}/admin/node/instances" style="margin-top:10px">
        <input type="hidden" name="_csrf" value="${req.csrfToken()}"/>
        <label>选择节点</label>
        <select name="node_id" required>
          <option value="">-- 选择节点 --</option>
          ${list}
        </select>
        <div style="margin-top:12px"><button class="primary" type="submit">查看容器列表</button></div>
      </form>

      <hr style="border:none;border-top:1px solid var(--line);margin:14px 0">

      <form method="POST" action="${ENTRY}/admin/pair_token">
        <input type="hidden" name="_csrf" value="${req.csrfToken()}"/>
        <div class="grid2">
          <div><label>生成 Pair Token TTL（秒）</label><input name="ttl" value="600" type="number" min="60" max="3600"/></div>
          <div style="display:flex;align-items:end"><button class="good" type="submit">生成 Pair Token</button></div>
        </div>
      </form>
    `;
    res.send(layout("节点/容器", req.session.user, body));
  }catch(e){
    bannerHtml = banner("⚠️ 后端连接存在，但请求失败：请检查 Panel 是否可达 / admin 密码是否正确。");
    res.send(layout("节点/容器", req.session.user, `<pre>${esc(e.message||String(e))}</pre>`, bannerHtml));
  }
});

app.post(ENTRY + "/admin/pair_token", mustAdmin, csrfProtection, async (req,res)=>{
  try{
    const b = await pickDefaultBackend();
    if(!b) throw new Error("no backend");
    const ttl = Math.max(60, Math.min(3600, Number(req.body.ttl||600)));
    const r = await backendFetch(b, "POST", `/nodes/pair_token?ttl_seconds=${ttl}`);
    await audit(req.session.user.username,"pair_token.create",{backend_id:b.id, ttl});
    res.send(layout("Pair Token", req.session.user,
      `<pre>PAIR_TOKEN=${esc(r.token)}\nexpires_in=${esc(r.expires_in)}s</pre>
       <div class="muted">把 token 贴到节点机 enroll 即可。</div>
       <a class="nav" href="${ENTRY}/admin/nodes">返回</a>`));
  }catch(e){
    res.send(layout("生成失败", req.session.user, `<pre>${esc(e.message||String(e))}</pre><a class="nav" href="${ENTRY}/admin/nodes">返回</a>`));
  }
});

app.post(ENTRY + "/admin/node/instances", mustAdmin, csrfProtection, async (req,res)=>{
  try{
    const b = await pickDefaultBackend();
    if(!b) throw new Error("no backend");
    const nodeId = String(req.body.node_id||"").trim();
    if(!nodeId) throw new Error("node_id empty");
    const inst = await backendFetch(b, "GET", `/nodes/${encodeURIComponent(nodeId)}/instances`);
    const body = `
      <div class="muted">后端：<b>${esc(b.name)}</b> · 节点：<b>${esc(nodeId)}</b></div>

      <h3 style="margin:10px 0 8px;font-size:13px">创建容器</h3>
      <form method="POST" action="${ENTRY}/admin/instance/create">
        <input type="hidden" name="_csrf" value="${req.csrfToken()}"/>
        <input type="hidden" name="node_id" value="${esc(nodeId)}"/>
        <div class="grid2">
          <div><label>容器名</label><input name="name" required placeholder="ct-001"/></div>
          <div><label>镜像</label><input name="image" value="images:ubuntu/22.04"/></div>
        </div>
        <div class="grid3">
          <div><label>CPU 核心</label><input name="cpu_cores" type="number" min="1" placeholder="2"/></div>
          <div><label>CPU 上限%</label><input name="cpu_limit_percent" type="number" min="1" max="100" placeholder="50"/></div>
          <div><label>内存 MB</label><input name="memory_mb" type="number" min="128" placeholder="2048"/></div>
        </div>
        <div class="grid3">
          <div><label>磁盘 GB</label><input name="disk_gb" type="number" min="1" placeholder="20"/></div>
          <div><label>上行 Mbit</label><input name="up_mbit" type="number" min="1" placeholder="50"/></div>
          <div><label>下行 Mbit</label><input name="down_mbit" type="number" min="1" placeholder="200"/></div>
        </div>
        <div style="margin-top:12px"><button class="good" type="submit">创建</button></div>
      </form>

      <hr style="border:none;border-top:1px solid var(--line);margin:14px 0">
      <h3 style="margin:0 0 8px;font-size:13px">容器列表（原样 JSON）</h3>
      <pre>${esc(JSON.stringify(inst, null, 2))}</pre>

      <hr style="border:none;border-top:1px solid var(--line);margin:14px 0">
      <h3 style="margin:0 0 8px;font-size:13px">给用户分配容器（RBAC 映射）</h3>
      <form method="POST" action="${ENTRY}/admin/assign">
        <input type="hidden" name="_csrf" value="${req.csrfToken()}"/>
        <input type="hidden" name="node_id" value="${esc(nodeId)}"/>
        <div class="grid2">
          <div><label>用户名</label><input name="username" placeholder="user001" required/></div>
          <div><label>容器名（instance_name）</label><input name="instance_name" placeholder="ct-001" required/></div>
        </div>
        <div style="margin-top:12px"><button type="submit" class="primary">分配</button></div>
      </form>

      <a class="nav" href="${ENTRY}/admin/nodes">返回</a>
    `;
    res.send(layout("节点容器", req.session.user, body));
  }catch(e){
    res.send(layout("失败", req.session.user, `<pre>${esc(e.message||String(e))}</pre><a class="nav" href="${ENTRY}/admin/nodes">返回</a>`));
  }
});

app.post(ENTRY + "/admin/instance/create", mustAdmin, csrfProtection, async (req,res)=>{
  try{
    const b = await pickDefaultBackend();
    if(!b) throw new Error("no backend");
    const node_id = String(req.body.node_id||"").trim();
    const name = String(req.body.name||"").trim();
    const image = String(req.body.image||"images:ubuntu/22.04").trim();
    if(!node_id || !name) throw new Error("node_id/name empty");

    const payload = { name, image };
    const takeNum = (k)=>{ const v = Number(req.body[k]); return Number.isFinite(v) && v>0 ? v : null; };
    const cpu = takeNum("cpu_cores");
    const cpuPct = takeNum("cpu_limit_percent");
    const mem = takeNum("memory_mb");
    const disk = takeNum("disk_gb");
    const up = takeNum("up_mbit");
    const down = takeNum("down_mbit");
    if(cpu) payload.cpu_cores = cpu;
    if(cpuPct) payload.cpu_limit_percent = cpuPct;
    if(mem) payload.memory_mb = mem;
    if(disk) payload.disk_gb = disk;
    if(up) payload.up_mbit = up;
    if(down) payload.down_mbit = down;

    const r = await backendFetch(b, "POST", `/nodes/${encodeURIComponent(node_id)}/instances`, payload);
    await audit(req.session.user.username,"instance.create",{backend_id:b.id,node_id,name});
    res.send(layout("创建结果", req.session.user, `<pre>${esc(JSON.stringify(r,null,2))}</pre><a class="nav" href="${ENTRY}/admin/nodes">返回</a>`));
  }catch(e){
    res.send(layout("创建失败", req.session.user, `<pre>${esc(e.message||String(e))}</pre><a class="nav" href="${ENTRY}/admin/nodes">返回</a>`));
  }
});

app.post(ENTRY + "/admin/assign", mustAdmin, csrfProtection, async (req,res)=>{
  try{
    const b = await pickDefaultBackend();
    if(!b) throw new Error("no backend");
    const username = String(req.body.username||"").trim();
    const node_id = String(req.body.node_id||"").trim();
    const instance_name = String(req.body.instance_name||"").trim();
    if(!username || !node_id || !instance_name) throw new Error("missing fields");
    const u = await get("SELECT id,role FROM users WHERE username=?", [username]);
    if(!u) throw new Error("user not found");
    if(u.role!=="user") throw new Error("只能分配给 user 角色");

    await run("INSERT OR IGNORE INTO assignments(user_id,backend_id,node_id,instance_name,created_at) VALUES(?,?,?,?,?)",
      [u.id, b.id, node_id, instance_name, nowIso()]);
    await audit(req.session.user.username,"assign.add",{username,backend_id:b.id,node_id,instance_name});
    res.send(layout("分配成功", req.session.user, `<pre>${esc(username)} -> backend#${b.id} ${esc(node_id)}/${esc(instance_name)}</pre><a class="nav" href="${ENTRY}/admin/nodes">返回</a>`));
  }catch(e){
    res.send(layout("分配失败", req.session.user, `<pre>${esc(e.message||String(e))}</pre><a class="nav" href="${ENTRY}/admin/nodes">返回</a>`));
  }
});

/** ---- Admin audit/raw ---- */
app.get(ENTRY + "/admin/audit", mustAdmin, async (req,res)=>{
  const rows = await all("SELECT * FROM audit ORDER BY id DESC LIMIT 200");
  res.send(layout("审计", req.session.user, `<pre>${esc(JSON.stringify(rows,null,2))}</pre>`));
});

app.get(ENTRY + "/admin/raw", mustAdmin, csrfProtection, async (req,res)=>{
  const b = await pickDefaultBackend();
  const bannerHtml = b ? "" : banner("⚠️ 未配置后端，Raw 暂不可用。");
  const body = `
    <div class="muted">Raw：直接调用“默认后端 Panel”。</div>
    <form method="POST" action="${ENTRY}/admin/raw">
      <input type="hidden" name="_csrf" value="${req.csrfToken()}"/>
      <div class="grid2">
        <div><label>Method</label>
          <select name="method"><option>GET</option><option>POST</option><option>DELETE</option></select>
        </div>
        <div><label>Path（以 / 开头）</label><input name="path" value="/nodes"/></div>
      </div>
      <label>JSON Body（可空）</label><textarea name="body" placeholder='{"a":1}'></textarea>
      <div style="margin-top:12px"><button class="primary" type="submit">发送</button></div>
    </form>
  `;
  res.send(layout("Raw", req.session.user, body, bannerHtml));
});

app.post(ENTRY + "/admin/raw", mustAdmin, csrfProtection, async (req,res)=>{
  try{
    const b = await pickDefaultBackend();
    if(!b) throw new Error("no backend");
    const method = String(req.body.method||"GET").toUpperCase();
    const p = String(req.body.path||"/health").trim();
    if(!p.startsWith("/")) throw new Error("path must start with /");
    const bodyText = String(req.body.body||"").trim();
    let body = undefined;
    if(bodyText) body = JSON.parse(bodyText);
    const r = await backendFetch(b, method, p, body);
    await audit(req.session.user.username,"raw",{backend_id:b.id, method, path:p});
    res.send(layout("Raw 结果", req.session.user, `<pre>${esc(JSON.stringify(r,null,2))}</pre><a class="nav" href="${ENTRY}/admin/raw">返回</a>`));
  }catch(e){
    res.send(layout("Raw 失败", req.session.user, `<pre>${esc(e.message||String(e))}</pre><a class="nav" href="${ENTRY}/admin/raw">返回</a>`));
  }
});

/** ---- User portal ---- */
async function userDefaultBackendForOps(){
  // 用户端操作也使用默认后端（并通过 assignments 限制）
  return await pickDefaultBackend();
}

async function userAllowed(userId, backendId, node_id, instance_name){
  const row = await get(
    "SELECT 1 AS ok FROM assignments WHERE user_id=? AND backend_id=? AND node_id=? AND instance_name=?",
    [userId, backendId, node_id, instance_name]
  );
  return !!row;
}

app.get(ENTRY + "/user/instances", mustUser, csrfProtection, async (req,res)=>{
  const me = req.session.user;
  if(me.role==="admin"){
    return res.send(layout("提示", me, `<div class="muted">你是 admin，请用管理员侧管理全局。</div><a class="nav" href="${ENTRY}/admin/dashboard">去仪表盘</a>`));
  }
  const b = await userDefaultBackendForOps();
  let bannerHtml = "";
  if(!b){
    bannerHtml = banner("⚠️ 管理员尚未配置任何后端 Panel。你可以先登录，但无法操作容器。");
  }

  const asg = b ? await all(
    "SELECT node_id,instance_name FROM assignments WHERE user_id=? AND backend_id=? ORDER BY node_id,instance_name",
    [me.id, b.id]
  ) : [];

  const list = asg.map(x=>`<option value="${esc(x.node_id)}::${esc(x.instance_name)}">${esc(x.node_id)} / ${esc(x.instance_name)}</option>`).join("");
  const body = `
    <div class="muted">用户端只操作管理员分配的容器。默认后端：${b ? `<b>${esc(b.name)}</b>` : `<b>未配置</b>`}</div>

    <label>选择容器</label>
    <select id="pick">${list || `<option value="">(暂无分配)</option>`}</select>

    <hr style="border:none;border-top:1px solid var(--line);margin:14px 0">

    <form method="POST" action="${ENTRY}/user/action">
      <input type="hidden" name="_csrf" value="${req.csrfToken()}"/>
      <label>动作</label>
      <select name="action">
        <option value="list_ports">查看端口池</option>
        <option value="add_port">添加端口映射</option>
        <option value="del_port">删除端口映射</option>
        <option value="set_limits">设置限制（含带宽）</option>
        <option value="reinstall">重装（危险）</option>
        <option value="create_user">容器内创建用户</option>
      </select>

      <div class="grid2">
        <div><label>删除映射：host_port</label><input name="host_port" placeholder="20001"/></div>
        <div><label>添加映射：container_port</label><input name="container_port" placeholder="22"/></div>
      </div>
      <div class="grid2">
        <div><label>proto</label><select name="proto"><option value="tcp">tcp</option><option value="udp">udp</option></select></div>
        <div><label>指定宿主机端口（可空=自动分配）</label><input name="host_port_add" placeholder="2222"/></div>
      </div>

      <div class="grid3">
        <div><label>CPU 核心</label><input name="cpu_cores" placeholder="2"/></div>
        <div><label>CPU 上限%</label><input name="cpu_limit_percent" placeholder="50"/></div>
        <div><label>内存MB</label><input name="memory_mb" placeholder="2048"/></div>
      </div>
      <div class="grid3">
        <div><label>磁盘GB</label><input name="disk_gb" placeholder="20"/></div>
        <div><label>上行Mbit</label><input name="up_mbit" placeholder="50"/></div>
        <div><label>下行Mbit</label><input name="down_mbit" placeholder="200"/></div>
      </div>

      <div class="grid2">
        <div><label>重装镜像</label><input name="image" value="images:debian/12"/></div>
        <div><label>保留端口/限制</label>
          <select name="preserve"><option value="1" selected>保留</option><option value="0">不保留</option></select>
        </div>
      </div>

      <div class="grid2">
        <div><label>容器内用户名</label><input name="linux_user" placeholder="alice"/></div>
        <div><label>容器内密码（可空）</label><input name="linux_pass" placeholder="optional"/></div>
      </div>
      <label>SSH 公钥（可空）</label><textarea name="ssh_key" placeholder="ssh-ed25519 AAAA..."></textarea>

      <input type="hidden" name="pick" id="pickHidden"/>
      <div style="margin-top:12px"><button class="primary" type="submit">执行</button></div>
    </form>

    <script>
      const s=document.getElementById("pick"); const h=document.getElementById("pickHidden");
      function sync(){ h.value=s.value; } sync(); s.addEventListener("change",sync);
    </script>
  `;
  res.send(layout("我的容器", me, body, bannerHtml));
});

function parsePick(pick){
  const [node_id, instance_name] = String(pick||"").split("::");
  if(!node_id || !instance_name) throw new Error("未选择容器");
  return { node_id, instance_name };
}

app.post(ENTRY + "/user/action", mustUser, csrfProtection, async (req,res)=>{
  const me = req.session.user;
  try{
    if(me.role==="admin") throw new Error("admin 请使用管理员端");
    const b = await userDefaultBackendForOps();
    if(!b) throw new Error("管理员尚未配置后端 Panel");
    const { node_id, instance_name } = parsePick(req.body.pick);
    const allowed = await userAllowed(me.id, b.id, node_id, instance_name);
    if(!allowed) throw new Error("你没有权限操作该容器");

    const action = String(req.body.action||"").trim();
    const num = (k)=>{ const v=Number(req.body[k]); return Number.isFinite(v)&&v>0?v:null; };

    let r=null;
    if(action==="list_ports"){
      r = await backendFetch(b, "GET", `/nodes/${encodeURIComponent(node_id)}/ports`);
    }else if(action==="add_port"){
      const cp=num("container_port"); if(!cp) throw new Error("container_port 必填");
      const proto=String(req.body.proto||"tcp");
      const hp=num("host_port_add");
      const payload={ container_port: cp, proto };
      if(hp) payload.host_port=hp;
      r = await backendFetch(b, "POST", `/nodes/${encodeURIComponent(node_id)}/instances/${encodeURIComponent(instance_name)}/ports`, payload);
    }else if(action==="del_port"){
      const hp=num("host_port"); if(!hp) throw new Error("host_port 必填");
      r = await backendFetch(b, "DELETE", `/nodes/${encodeURIComponent(node_id)}/instances/${encodeURIComponent(instance_name)}/ports/${hp}`);
    }else if(action==="set_limits"){
      const payload={};
      const cpu=num("cpu_cores"); if(cpu) payload.cpu_cores=cpu;
      const cpuPct=num("cpu_limit_percent"); if(cpuPct) payload.cpu_limit_percent=cpuPct;
      const mem=num("memory_mb"); if(mem) payload.memory_mb=mem;
      const disk=num("disk_gb"); if(disk) payload.disk_gb=disk;
      const up=num("up_mbit"); if(up) payload.up_mbit=up;
      const down=num("down_mbit"); if(down) payload.down_mbit=down;
      if(Object.keys(payload).length===0) throw new Error("至少填一个限制项");
      r = await backendFetch(b, "POST", `/nodes/${encodeURIComponent(node_id)}/instances/${encodeURIComponent(instance_name)}/limits`, payload);
    }else if(action==="reinstall"){
      const image=String(req.body.image||"").trim(); if(!image) throw new Error("image 必填");
      const preserve=String(req.body.preserve||"1")==="1";
      r = await backendFetch(b, "POST", `/nodes/${encodeURIComponent(node_id)}/instances/${encodeURIComponent(instance_name)}/reinstall`, {
        image, preserve_ports: preserve, preserve_limits: preserve
      });
    }else if(action==="create_user"){
      const username=String(req.body.linux_user||"").trim(); if(!username) throw new Error("linux_user 必填");
      const payload={ username, sudo:true };
      const pw=String(req.body.linux_pass||"").trim(); if(pw) payload.password=pw;
      const key=String(req.body.ssh_key||"").trim(); if(key) payload.ssh_public_key=key;
      r = await backendFetch(b, "POST", `/nodes/${encodeURIComponent(node_id)}/instances/${encodeURIComponent(instance_name)}/users`, payload);
    }else{
      throw new Error("未知 action");
    }

    await audit(me.username,"user.action",{backend_id:b.id,node_id,instance_name,action});
    res.send(layout("执行结果", me, `<pre>${esc(JSON.stringify(r,null,2))}</pre><a class="nav" href="${ENTRY}/user/instances">返回</a>`));
  }catch(e){
    res.send(layout("执行失败", req.session.user, `<pre>${esc(e.message||String(e))}</pre><a class="nav" href="${ENTRY}/user/instances">返回</a>`));
  }
});

app.get(ENTRY + "/user/raw", mustUser, csrfProtection, async (req,res)=>{
  const me=req.session.user;
  if(me.role==="admin") return res.redirect(ENTRY + "/admin/raw");
  const body=`
    <div class="muted">用户 Raw 仍受容器归属限制：为防越权，path 必须包含 instance_name。</div>
    <form method="POST" action="${ENTRY}/user/raw">
      <input type="hidden" name="_csrf" value="${req.csrfToken()}"/>
      <div class="grid2">
        <div><label>node_id</label><input name="node_id" required/></div>
        <div><label>instance_name</label><input name="instance_name" required/></div>
      </div>
      <div class="grid2">
        <div><label>Method</label><select name="method"><option>GET</option><option>POST</option><option>DELETE</option></select></div>
        <div><label>Path（以 / 开头）</label><input name="path" value="/instances/ct-001/limits"/></div>
      </div>
      <label>JSON Body（可空）</label><textarea name="body" placeholder='{"memory_mb":2048}'></textarea>
      <div style="margin-top:12px"><button class="primary" type="submit">发送</button></div>
    </form>`;
  res.send(layout("用户 Raw", me, body));
});

app.post(ENTRY + "/user/raw", mustUser, csrfProtection, async (req,res)=>{
  const me=req.session.user;
  try{
    if(me.role==="admin") throw new Error("admin 请用管理员 raw");
    const b=await userDefaultBackendForOps();
    if(!b) throw new Error("管理员尚未配置后端 Panel");
    const node_id=String(req.body.node_id||"").trim();
    const instance_name=String(req.body.instance_name||"").trim();
    const allowed = await userAllowed(me.id,b.id,node_id,instance_name);
    if(!allowed) throw new Error("你无权操作该容器");
    const method=String(req.body.method||"GET").toUpperCase();
    const p=String(req.body.path||"").trim();
    if(!p.startsWith("/")) throw new Error("path must start with /");
    if(!p.includes(instance_name)) throw new Error("为防越权，path 必须包含 instance_name");
    const bodyText=String(req.body.body||"").trim();
    let body=undefined;
    if(bodyText) body=JSON.parse(bodyText);
    const r=await backendFetch(b, method, `/nodes/${encodeURIComponent(node_id)}${p}`, body);
    await audit(me.username,"user.raw",{backend_id:b.id,node_id,instance_name,method,path:p});
    res.send(layout("Raw 结果", me, `<pre>${esc(JSON.stringify(r,null,2))}</pre><a class="nav" href="${ENTRY}/user/raw">返回</a>`));
  }catch(e){
    res.send(layout("Raw 失败", req.session.user, `<pre>${esc(e.message||String(e))}</pre><a class="nav" href="${ENTRY}/user/raw">返回</a>`));
  }
});

/** ---- health ---- */
app.get(ENTRY + "/health", async (req,res)=>{
  const b = await pickDefaultBackend();
  let backend=null;
  if(b){
    try{ backend = await backendFetch(b,"GET","/health"); }catch(e){ backend = { ok:false, error:String(e.message||e) }; }
  }
  res.json({ ok:true, service:"lxd-3xui-panel", entry:ENTRY, backend_default: b?{id:b.id,name:b.name,base_url:b.base_url}:null, backend_health: backend });
});

/** ---- boot ---- */
await initDb();

app.listen(PORT, "0.0.0.0", ()=>{
  console.log(`[lxd-3xui-panel] listen :${PORT}`);
  console.log(`[lxd-3xui-panel] entry  ${ENTRY}/login`);
});
JS

  ok "写入完成"
}

npm_install(){
  info "安装 npm 依赖..."
  cd "$APP_DIR"
  npm install --omit=dev
  ok "npm 依赖安装完成"
}

write_config(){
  info "生成配置..."
  local entry="/$(rand_hex 10)"
  local admin_user="admin"
  local admin_pass="$(rand_pw 18)"
  local session_secret="$(rand_pw 32)"

  cat > "$CFG_DIR/config.json" <<EOF
{
  "listen_port": ${PORT},
  "entry_path": "${entry}",
  "admin_user": "${admin_user}",
  "admin_pass": "${admin_pass}",
  "session_secret": "${session_secret}",
  "public_host": ""
}
EOF
  chmod 600 "$CFG_DIR/config.json"
  echo "${entry}" > "$CFG_DIR/entry.path"
  echo "${admin_user}" > "$CFG_DIR/admin.user"
  echo "${admin_pass}" > "$CFG_DIR/admin.pass"
  chmod 600 "$CFG_DIR/"*.*
  ok "配置已生成：$CFG_DIR/config.json"
}

write_systemd(){
  info "注册 systemd..."
  cat > "/etc/systemd/system/${SVC}.service" <<EOF
[Unit]
Description=LXD 3xUI Style Panel (Independent)
After=network.target

[Service]
Type=simple
Environment=CFG_PATH=${CFG_DIR}/config.json
Environment=DATA_DIR=${DATA_DIR}
WorkingDirectory=${APP_DIR}
ExecStart=/usr/bin/node ${APP_DIR}/server.js
Restart=always
RestartSec=2
User=root
NoNewPrivileges=true
PrivateTmp=true
ProtectHome=true
ProtectSystem=full
ReadWritePaths=${DATA_DIR} ${CFG_DIR} ${APP_DIR}

[Install]
WantedBy=multi-user.target
EOF
  systemctl daemon-reload
  systemctl enable "$SVC" >/dev/null
  systemctl restart "$SVC"
  ok "服务已启动：$SVC"
}

show_result(){
  local ip entry admin_user admin_pass
  ip="$(host_ip)"
  entry="$(cat "$CFG_DIR/entry.path")"
  admin_user="$(cat "$CFG_DIR/admin.user")"
  admin_pass="$(cat "$CFG_DIR/admin.pass")"

  echo
  echo -e "${GREEN}================== 安装完成（独立面板已可用） ==================${PLAIN}"
  echo -e "登录入口：${BLUE}http://${ip}:${PORT}${entry}/login${PLAIN}"
  echo -e "管理员账号：${YELLOW}${admin_user}${PLAIN}"
  echo -e "管理员密码：${YELLOW}${admin_pass}${PLAIN}"
  echo -e "${GREEN}=============================================================${PLAIN}"
  echo
  echo -e "${YELLOW}下一步（不需要后端也能先登录）：${PLAIN}"
  echo -e "1) 先用管理员登录"
  echo -e "2) 进入【后端连接】添加 Panel URL + admin 密码（可选，后装也行）"
  echo -e "3) 进入【用户管理】创建用户并分配容器"
  echo
}

main(){
  install_deps
  install_node
  write_files
  npm_install
  write_config
  write_systemd
  show_result
}
main
