#!/bin/bash
# ==============================================================================
# é¡¹ç›®åç§°: LXD Container Node + Panel Proxy (æ–¹æ¡ˆA) ä¸€é”®å®‰è£…è„šæœ¬
# æ–‡ä»¶åç§°: lxd-agent-with-panel.sh
# è¿è¡Œç¯å¢ƒ: Debian 11+ / Ubuntu 20.04+ (éœ€ Root æƒé™)
#
# åŠŸèƒ½:
# 1) å®‰è£…/åˆå§‹åŒ– LXDï¼ˆsnapï¼‰+ Agent(FastAPI) + Nginx(mTLSç½‘å…³)
# 2) è¡¥é½åç«¯ /list æ¥å£ï¼ˆé¢æ¿å¯åˆ—å‡ºå®¹å™¨ï¼‰
# 3) å®‰è£… Node Proxyï¼ˆè´Ÿè´£ mTLS è½¬å‘ï¼Œæµè§ˆå™¨æ— éœ€è¯ä¹¦ï¼‰
# 4) ç”Ÿæˆä¸€ä¸ªå‰ç«¯é™æ€é¢æ¿ panel.htmlï¼ˆå¯ç›´æ¥æ‰“å¼€æˆ–è‡ªè¡Œæ”¾åˆ°é™æ€ç«™ç‚¹ï¼‰
#
# é»˜è®¤ç«¯å£:
# - å¤–éƒ¨ mTLS ç½‘å…³: 443 (Nginx)  -> å†…éƒ¨ Agent: 127.0.0.1:9042
# - é¢æ¿ Proxy:     18080 (HTTP) -> ä¸Šæ¸¸ mTLS: https://127.0.0.1:443
#
# å®‰å…¨æé†’:
# - Proxy ç«¯å£ 18080 ä¸åšé‰´æƒï¼ˆç»™å±€åŸŸç½‘/å†…ç½‘ç”¨ï¼‰ã€‚å…¬ç½‘ä½¿ç”¨è¯·è‡ªè¡ŒåŠ è®¤è¯/ä»…å…è®¸ç‰¹å®šIPè®¿é—®ã€‚
# ==============================================================================

set -euo pipefail

# --- å…¨å±€é…ç½® ---
AGENT_DIR="/opt/lxd-agent"
DATA_DIR="${AGENT_DIR}/data"
CERT_DIR="${AGENT_DIR}/certs"
PY_VENV="${AGENT_DIR}/.venv"

UVICORN_PORT="9042"      # å†…éƒ¨ API ç«¯å£
NGINX_HTTPS_PORT="443"   # å¯¹å¤– mTLS ç«¯å£

PROXY_DIR="/opt/lxd-panel-proxy"
PROXY_PORT="18080"       # é¢æ¿ä»£ç†ç«¯å£ (HTTP)
PANEL_HTML="${PROXY_DIR}/panel.html"

# --- é¢œè‰²å®šä¹‰ ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;36m'
PLAIN='\033[0m'

# æ£€æŸ¥ Root æƒé™
[[ $EUID -ne 0 ]] && echo -e "${RED}é”™è¯¯ï¼šè¯·ä½¿ç”¨ root æƒé™è¿è¡Œæ­¤è„šæœ¬ï¼${PLAIN}" && exit 1

# --- å·¥å…·å‡½æ•° ---
log() { echo -e "${BLUE}[*]${PLAIN} $*"; }
ok()  { echo -e "${GREEN}[OK]${PLAIN} $*"; }
warn(){ echo -e "${YELLOW}[!]${PLAIN} $*"; }

# ==============================================================================
# 1) å®‰è£…ç³»ç»Ÿä¾èµ– + LXD
# ==============================================================================
install_env() {
  echo -e "${YELLOW}[1/7] å®‰è£…ç³»ç»Ÿä¾èµ–...${PLAIN}"
  export DEBIAN_FRONTEND=noninteractive
  apt-get update -qq

  # åŸºç¡€å·¥å…· + Nginx + Python + UFW
  apt-get install -y -qq curl jq openssl nginx python3 python3-venv python3-pip ufw socat ca-certificates >/dev/null

  # Node.jsï¼ˆå°½é‡ç”¨ç³»ç»Ÿä»“åº“ï¼Œå¤Ÿç”¨ï¼›è‹¥ä½ è¦æ›´é«˜ç‰ˆæœ¬å¯è‡ªè¡Œæ¢ NodeSourceï¼‰
  apt-get install -y -qq nodejs npm >/dev/null || true

  # ç¡®ä¿ snap å¯ç”¨ï¼ˆDebian/Ubuntu ä¸€èˆ¬å¯è£…ï¼‰
  if ! command -v snap >/dev/null 2>&1; then
    warn "æœªæ£€æµ‹åˆ° snapï¼Œæ­£åœ¨å®‰è£… snapd..."
    apt-get install -y -qq snapd >/dev/null
    systemctl enable --now snapd >/dev/null 2>&1 || true
  fi

  # å®‰è£… LXDï¼ˆsnapï¼‰
  if ! command -v lxc >/dev/null 2>&1; then
    log "å®‰è£… LXD (snap)..."
    snap install lxd >/dev/null
    # åˆå§‹åŒ– LXD (é»˜è®¤é…ç½®)
    log "åˆå§‹åŒ– LXD (lxd init --auto)..."
    lxd init --auto >/dev/null
  else
    ok "LXD å·²å®‰è£…"
  fi
}

# ==============================================================================
# 2) ç”Ÿæˆ mTLS è¯ä¹¦
# ==============================================================================
generate_certs() {
  echo -e "${YELLOW}[2/7] ç”Ÿæˆ mTLS åŒå‘è®¤è¯è¯ä¹¦...${PLAIN}"
  mkdir -p "${CERT_DIR}"

  # è·å–ä¸€ä¸ªå¯ç”¨çš„ IPï¼ˆä¼˜å…ˆå–ç¬¬ä¸€ä¸ªï¼›å¦‚ä½ è¦ç»‘å®šå…¬ç½‘ IPï¼Œå¯åç»­æ‰‹å·¥æ”¹ server.cnfï¼‰
  HOST_IP="$(hostname -I | awk '{print $1}')"
  [[ -z "${HOST_IP}" ]] && HOST_IP="127.0.0.1"

  # (1) CA
  if [[ ! -f "${CERT_DIR}/ca.crt" ]]; then
    openssl genrsa -out "${CERT_DIR}/ca.key" 4096 2>/dev/null
    openssl req -x509 -new -nodes -key "${CERT_DIR}/ca.key" -days 3650 \
      -subj "/CN=LXD-Panel-CA" -out "${CERT_DIR}/ca.crt" 2>/dev/null
  fi

  # (2) Server cert (Nginx)
  if [[ ! -f "${CERT_DIR}/server.crt" ]]; then
    openssl genrsa -out "${CERT_DIR}/server.key" 2048 2>/dev/null

    cat > "${CERT_DIR}/server.cnf" <<EOF
[req]
default_bits = 2048
prompt = no
default_md = sha256
distinguished_name = dn
req_extensions = req_ext
[dn]
CN = ${HOST_IP}
[req_ext]
subjectAltName = IP:${HOST_IP}
EOF

    openssl req -new -key "${CERT_DIR}/server.key" -config "${CERT_DIR}/server.cnf" \
      -out "${CERT_DIR}/server.csr" 2>/dev/null

    openssl x509 -req -in "${CERT_DIR}/server.csr" \
      -CA "${CERT_DIR}/ca.crt" -CAkey "${CERT_DIR}/ca.key" -CAcreateserial \
      -out "${CERT_DIR}/server.crt" -days 3650 \
      -extensions req_ext -extfile "${CERT_DIR}/server.cnf" 2>/dev/null
  fi

  # (3) Client cert (Panel uses via Proxy)
  if [[ ! -f "${CERT_DIR}/client.crt" ]]; then
    openssl genrsa -out "${CERT_DIR}/client.key" 2048 2>/dev/null
    openssl req -new -key "${CERT_DIR}/client.key" -subj "/CN=LXD-Panel-Client" \
      -out "${CERT_DIR}/client.csr" 2>/dev/null
    openssl x509 -req -in "${CERT_DIR}/client.csr" \
      -CA "${CERT_DIR}/ca.crt" -CAkey "${CERT_DIR}/ca.key" -CAcreateserial \
      -out "${CERT_DIR}/client.crt" -days 3650 2>/dev/null
  fi

  chmod 644 "${CERT_DIR}"/*.crt
  chmod 600 "${CERT_DIR}"/*.key
  ok "è¯ä¹¦ç”Ÿæˆå®Œæˆï¼š${CERT_DIR}"
}

# ==============================================================================
# 3) éƒ¨ç½² FastAPI Agentï¼ˆåŒ…å« /listï¼‰
# ==============================================================================
deploy_agent() {
  echo -e "${YELLOW}[3/7] éƒ¨ç½² LXD æ§åˆ¶ Agent(FastAPI)...${PLAIN}"
  mkdir -p "${AGENT_DIR}" "${DATA_DIR}"

  # ç”Ÿæˆæœ¬åœ°é€šä¿¡å¯†é’¥
  if [[ ! -f "${DATA_DIR}/agent.key" ]]; then
    openssl rand -hex 16 > "${DATA_DIR}/agent.key"
  fi

  # requirements
  cat > "${AGENT_DIR}/requirements.txt" <<'EOF'
fastapi
uvicorn[standard]
pydantic
EOF

  # app.pyï¼ˆå®Œæ•´é‡å†™ï¼Œå¸¦ /listï¼‰
  cat > "${AGENT_DIR}/app.py" <<'PYTHON_EOF'
import subprocess, shlex, json
from typing import Optional, Any
from fastapi import FastAPI, HTTPException, Request, Depends
from pydantic import BaseModel, Field

KEY_PATH = "/opt/lxd-agent/data/agent.key"
try:
    with open(KEY_PATH, "r") as f:
        APP_KEY = f.read().strip()
except Exception:
    APP_KEY = "init_failed"

app = FastAPI(title="LXD Agent", version="1.0.0")

def verify_key(req: Request):
    if req.headers.get("X-API-Key") != APP_KEY:
        raise HTTPException(status_code=401, detail="Invalid API Key")

def run_cmd(cmd: str) -> None:
    try:
        subprocess.check_call(shlex.split(cmd), stdout=subprocess.DEVNULL, stderr=subprocess.STDOUT)
    except subprocess.CalledProcessError as e:
        raise HTTPException(status_code=500, detail=f"Command Error: {cmd}")

def run_capture(cmd: str) -> str:
    try:
        out = subprocess.check_output(shlex.split(cmd), stderr=subprocess.STDOUT)
        return out.decode("utf-8", errors="ignore")
    except subprocess.CalledProcessError as e:
        msg = e.output.decode("utf-8", errors="ignore") if e.output else ""
        raise HTTPException(status_code=500, detail=f"Command Error: {cmd}\n{msg}")

class ContainerReq(BaseModel):
    name: str = Field(..., min_length=1, max_length=64)
    image: str = "images:debian/11"
    cpu: int = Field(1, ge=1, le=128)
    memory: int = Field(512, ge=128, le=1048576)  # MB
    disk: int = Field(5, ge=1, le=1048576)        # GB
    ports: Optional[str] = None                   # "10001:22,10002:80"
    ingress: Optional[int] = Field(None, ge=1, le=100000)  # Mbps
    egress: Optional[int] = Field(None, ge=1, le=100000)   # Mbps

@app.get("/health")
def health():
    return {"ok": True}

@app.get("/list", dependencies=[Depends(verify_key)])
def list_containers() -> Any:
    out = run_capture("lxc list --format json")
    try:
        return json.loads(out)
    except Exception:
        raise HTTPException(status_code=500, detail="Failed to parse lxc list output")

@app.post("/create", dependencies=[Depends(verify_key)])
def create(c: ContainerReq):
    # 1) åˆ›å»ºå®¹å™¨
    run_cmd(f"lxc launch {c.image} {c.name}")

    # 2) èµ„æºé™åˆ¶
    run_cmd(f"lxc config set {c.name} limits.cpu {c.cpu}")
    run_cmd(f"lxc config set {c.name} limits.memory {c.memory}MB")

    # 3) ç£ç›˜é™åˆ¶
    try:
        run_cmd(f"lxc config device set {c.name} root size {c.disk}GB")
    except HTTPException:
        # æŸäº›æƒ…å†µä¸‹ root è®¾å¤‡éœ€è¦ override
        run_cmd(f"lxc config device override {c.name} root size={c.disk}GB")

    # 4) ç½‘å¡å¸¦å®½é™åˆ¶ï¼ˆeth0ï¼‰
    if c.ingress:
        run_cmd(f"lxc config device override {c.name} eth0 limits.ingress={c.ingress}Mbit")
    if c.egress:
        run_cmd(f"lxc config device override {c.name} eth0 limits.egress={c.egress}Mbit")

    # 5) ç«¯å£æ˜ å°„ï¼ˆProxy è®¾å¤‡ï¼‰
    if c.ports:
        for i, mapping in enumerate(c.ports.split(",")):
            mapping = mapping.strip()
            if not mapping or ":" not in mapping:
                continue
            pub, priv = mapping.split(":", 1)
            pub, priv = pub.strip(), priv.strip()
            if not pub.isdigit() or not priv.isdigit():
                continue
            run_cmd(
                f"lxc config device add {c.name} proxy{i} proxy "
                f"listen=tcp:0.0.0.0:{pub} connect=tcp:127.0.0.1:{priv}"
            )

    return {"status": "created", "name": c.name}

@app.delete("/delete/{name}", dependencies=[Depends(verify_key)])
def delete(name: str):
    run_cmd(f"lxc delete {name} --force")
    return {"status": "deleted", "name": name}

@app.post("/action/{name}/{action}", dependencies=[Depends(verify_key)])
def action(name: str, action: str):
    if action not in ["start", "stop", "restart"]:
        raise HTTPException(status_code=400, detail="Invalid action")
    run_cmd(f"lxc {action} {name}")
    return {"status": "ok", "name": name, "action": action}
PYTHON_EOF

  # venv
  if [[ ! -d "${PY_VENV}" ]]; then
    python3 -m venv "${PY_VENV}"
  fi
  "${PY_VENV}/bin/pip" install -r "${AGENT_DIR}/requirements.txt" >/dev/null 2>&1

  # systemd
  cat > /etc/systemd/system/lxd-agent.service <<EOF
[Unit]
Description=LXD Control Agent API
After=network.target snap.lxd.daemon.service
Wants=snap.lxd.daemon.service

[Service]
WorkingDirectory=${AGENT_DIR}
ExecStart=${PY_VENV}/bin/uvicorn app:app --host 127.0.0.1 --port ${UVICORN_PORT} --log-level warning
Restart=always
RestartSec=2

[Install]
WantedBy=multi-user.target
EOF

  systemctl daemon-reload
  systemctl enable --now lxd-agent >/dev/null
  ok "Agent å·²å¯åŠ¨ï¼š127.0.0.1:${UVICORN_PORT}"
}

# ==============================================================================
# 4) é…ç½® Nginx mTLS ç½‘å…³ï¼ˆ443 -> 9042ï¼‰
# ==============================================================================
configure_nginx_mtls() {
  echo -e "${YELLOW}[4/7] é…ç½® Nginx(mTLS) å®‰å…¨ç½‘å…³...${PLAIN}"
  local APP_KEY
  APP_KEY="$(cat "${DATA_DIR}/agent.key")"

  cat > /etc/nginx/sites-available/lxd-agent <<EOF
server {
    listen ${NGINX_HTTPS_PORT} ssl;
    server_name _;

    ssl_certificate      ${CERT_DIR}/server.crt;
    ssl_certificate_key  ${CERT_DIR}/server.key;

    ssl_client_certificate ${CERT_DIR}/ca.crt;
    ssl_verify_client on;

    location / {
        proxy_pass http://127.0.0.1:${UVICORN_PORT};
        proxy_set_header X-API-Key "${APP_KEY}";
        proxy_set_header Host \$host;
    }
}
EOF

  ln -sf /etc/nginx/sites-available/lxd-agent /etc/nginx/sites-enabled/lxd-agent
  rm -f /etc/nginx/sites-enabled/default || true

  nginx -t >/dev/null
  systemctl restart nginx >/dev/null
  ok "Nginx mTLS ç½‘å…³å·²ç”Ÿæ•ˆï¼š443 -> 127.0.0.1:${UVICORN_PORT}"
}

# ==============================================================================
# 5) å®‰è£… Panel Proxyï¼ˆNode/Expressï¼Œè´Ÿè´£ mTLS è½¬å‘ï¼‰
# ==============================================================================
install_panel_proxy() {
  echo -e "${YELLOW}[5/7] å®‰è£… Panel Proxy(Node)...${PLAIN}"
  mkdir -p "${PROXY_DIR}"
  cd "${PROXY_DIR}"

  # package.json
  cat > "${PROXY_DIR}/package.json" <<'EOF'
{
  "name": "lxd-panel-proxy",
  "version": "1.0.0",
  "type": "module",
  "main": "server.js",
  "dependencies": {
    "express": "^4.19.2",
    "cors": "^2.8.5"
  }
}
EOF

  # server.jsï¼ˆä¸Šæ¸¸é»˜è®¤ https://127.0.0.1:443ï¼›è¯ä¹¦æ¥è‡ª /opt/lxd-agent/certsï¼‰
  cat > "${PROXY_DIR}/server.js" <<'EOF'
import fs from "fs";
import https from "https";
import express from "express";
import cors from "cors";

const app = express();
app.use(cors());
app.use(express.json({ limit: "2mb" }));

const UPSTREAM_HOST = process.env.UPSTREAM_HOST || "127.0.0.1";
const UPSTREAM_PORT = Number(process.env.UPSTREAM_PORT || "443");
const CERT_DIR = process.env.CERT_DIR || "/opt/lxd-agent/certs";

const ca = fs.readFileSync(`${CERT_DIR}/ca.crt`);
const cert = fs.readFileSync(`${CERT_DIR}/client.crt`);
const key = fs.readFileSync(`${CERT_DIR}/client.key`);

function upstreamRequest(method, path, body) {
  const options = {
    hostname: UPSTREAM_HOST,
    port: UPSTREAM_PORT,
    path,
    method,
    ca,
    cert,
    key,
    rejectUnauthorized: true,
    headers: { "Content-Type": "application/json" }
  };

  return new Promise((resolve, reject) => {
    const req = https.request(options, (res) => {
      let data = "";
      res.on("data", (chunk) => (data += chunk));
      res.on("end", () => {
        const status = res.statusCode || 500;
        const ct = res.headers["content-type"] || "";
        if (ct.includes("application/json")) {
          try { resolve({ status, data: JSON.parse(data || "{}") }); }
          catch { resolve({ status, data: { raw: data } }); }
        } else {
          resolve({ status, data: { raw: data } });
        }
      });
    });
    req.on("error", reject);
    if (body) req.write(JSON.stringify(body));
    req.end();
  });
}

app.get("/api/list", async (_req, res) => {
  try {
    const r = await upstreamRequest("GET", "/list", null);
    res.status(r.status).json(r.data);
  } catch (e) {
    res.status(500).json({ error: String(e) });
  }
});

app.post("/api/create", async (req, res) => {
  try {
    const r = await upstreamRequest("POST", "/create", req.body);
    res.status(r.status).json(r.data);
  } catch (e) {
    res.status(500).json({ error: String(e) });
  }
});

app.post("/api/action/:name/:action", async (req, res) => {
  try {
    const { name, action } = req.params;
    const r = await upstreamRequest("POST", `/action/${encodeURIComponent(name)}/${encodeURIComponent(action)}`, null);
    res.status(r.status).json(r.data);
  } catch (e) {
    res.status(500).json({ error: String(e) });
  }
});

app.delete("/api/delete/:name", async (req, res) => {
  try {
    const { name } = req.params;
    const r = await upstreamRequest("DELETE", `/delete/${encodeURIComponent(name)}`, null);
    res.status(r.status).json(r.data);
  } catch (e) {
    res.status(500).json({ error: String(e) });
  }
});

const listenPort = Number(process.env.PORT || "18080");
app.listen(listenPort, "0.0.0.0", () => {
  console.log(`lxd-panel-proxy listening on http://0.0.0.0:${listenPort}`);
  console.log(`Upstream: https://${UPSTREAM_HOST}:${UPSTREAM_PORT}`);
});
EOF

  # å®‰è£…ä¾èµ–
  if ! command -v npm >/dev/null 2>&1; then
    echo -e "${RED}é”™è¯¯ï¼šæœªæ‰¾åˆ° npmã€‚è¯·ç¡®è®¤ nodejs/npm å·²å®‰è£…ã€‚${PLAIN}"
    exit 1
  fi
  npm install --silent >/dev/null

  # systemd æœåŠ¡
  cat > /etc/systemd/system/lxd-panel-proxy.service <<EOF
[Unit]
Description=LXD Panel Proxy (mTLS upstream)
After=network.target nginx.service lxd-agent.service
Wants=nginx.service lxd-agent.service

[Service]
WorkingDirectory=${PROXY_DIR}
Environment=UPSTREAM_HOST=127.0.0.1
Environment=UPSTREAM_PORT=${NGINX_HTTPS_PORT}
Environment=CERT_DIR=${CERT_DIR}
Environment=PORT=${PROXY_PORT}
ExecStart=/usr/bin/node ${PROXY_DIR}/server.js
Restart=always
RestartSec=2

[Install]
WantedBy=multi-user.target
EOF

  systemctl daemon-reload
  systemctl enable --now lxd-panel-proxy >/dev/null
  ok "Proxy å·²å¯åŠ¨ï¼š0.0.0.0:${PROXY_PORT}"
}

# ==============================================================================
# 6) ç”Ÿæˆå‰ç«¯é¢æ¿ panel.htmlï¼ˆé™æ€æ–‡ä»¶ï¼‰
# ==============================================================================
write_panel_html() {
  echo -e "${YELLOW}[6/7] ç”Ÿæˆå‰ç«¯é¢æ¿ panel.html...${PLAIN}"
  mkdir -p "${PROXY_DIR}"

  cat > "${PANEL_HTML}" <<'EOF'
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LXD Panel</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-slate-100">
  <div id="app" class="max-w-6xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-semibold">LXD ç®¡ç†é¢æ¿</h1>
        <p class="text-slate-400 text-sm">é¢æ¿èµ° HTTPï¼ŒmTLS äº¤ç»™ Proxy å»æ‰›ã€‚ğŸ›¡ï¸</p>
      </div>
      <div class="flex items-center gap-2">
        <input v-model="proxyBase" class="w-80 px-3 py-2 rounded-xl bg-slate-900 border border-slate-700"
               placeholder="Proxy åœ°å€ï¼Œä¾‹å¦‚ http://1.2.3.4:18080" />
        <button @click="refresh" class="px-4 py-2 rounded-xl bg-slate-100 text-slate-900 font-semibold">
          åˆ·æ–°
        </button>
      </div>
    </header>

    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-1 rounded-2xl border border-slate-800 bg-slate-900/40 p-5">
        <h2 class="text-lg font-semibold mb-4">åˆ›å»ºå®¹å™¨</h2>

        <div class="space-y-3">
          <div>
            <label class="text-sm text-slate-300">åç§°</label>
            <input v-model="form.name" class="w-full px-3 py-2 rounded-xl bg-slate-950 border border-slate-800" placeholder="ä¾‹å¦‚ demo-01"/>
          </div>

          <div>
            <label class="text-sm text-slate-300">é•œåƒ</label>
            <input v-model="form.image" class="w-full px-3 py-2 rounded-xl bg-slate-950 border border-slate-800" placeholder="images:debian/11"/>
          </div>

          <div class="grid grid-cols-3 gap-2">
            <div>
              <label class="text-sm text-slate-300">CPU</label>
              <input v-model.number="form.cpu" type="number" min="1"
                     class="w-full px-3 py-2 rounded-xl bg-slate-950 border border-slate-800"/>
            </div>
            <div>
              <label class="text-sm text-slate-300">å†…å­˜(MB)</label>
              <input v-model.number="form.memory" type="number" min="128"
                     class="w-full px-3 py-2 rounded-xl bg-slate-950 border border-slate-800"/>
            </div>
            <div>
              <label class="text-sm text-slate-300">ç£ç›˜(GB)</label>
              <input v-model.number="form.disk" type="number" min="1"
                     class="w-full px-3 py-2 rounded-xl bg-slate-950 border border-slate-800"/>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="text-sm text-slate-300">å…¥ç«™é™é€Ÿ(Mbps)</label>
              <input v-model.number="form.ingress" type="number" min="0"
                     class="w-full px-3 py-2 rounded-xl bg-slate-950 border border-slate-800" placeholder="å¯ç©º"/>
            </div>
            <div>
              <label class="text-sm text-slate-300">å‡ºç«™é™é€Ÿ(Mbps)</label>
              <input v-model.number="form.egress" type="number" min="0"
                     class="w-full px-3 py-2 rounded-xl bg-slate-950 border border-slate-800" placeholder="å¯ç©º"/>
            </div>
          </div>

          <div>
            <label class="text-sm text-slate-300">ç«¯å£æ˜ å°„</label>
            <input v-model="form.ports" class="w-full px-3 py-2 rounded-xl bg-slate-950 border border-slate-800"
                   placeholder="10001:22,10002:80 (å¯ç©º)"/>
          </div>

          <button @click="create"
                  class="w-full px-4 py-2 rounded-xl bg-emerald-400 text-slate-900 font-semibold">
            åˆ›å»º
          </button>
        </div>

        <p v-if="notice" class="mt-4 text-sm text-slate-300">
          <span class="text-slate-400">æç¤ºï¼š</span>{{ notice }}
        </p>
      </div>

      <div class="lg:col-span-2 rounded-2xl border border-slate-800 bg-slate-900/40 p-5">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">å®¹å™¨åˆ—è¡¨</h2>
          <div class="flex items-center gap-2">
            <input v-model="filter" class="px-3 py-2 rounded-xl bg-slate-950 border border-slate-800"
                   placeholder="æœç´¢åç§°..." />
            <span class="text-sm text-slate-400">å…± {{ filtered.length }} ä¸ª</span>
          </div>
        </div>

        <div v-if="loading" class="text-slate-400">åŠ è½½ä¸­...</div>
        <div v-else class="space-y-3">
          <div v-for="c in filtered" :key="c.name"
               class="rounded-2xl border border-slate-800 bg-slate-950/40 p-4 flex items-center justify-between gap-4">
            <div class="min-w-0">
              <div class="flex items-center gap-2">
                <div class="font-semibold truncate">{{ c.name }}</div>
                <span class="text-xs px-2 py-1 rounded-full"
                      :class="c.status === 'Running' ? 'bg-emerald-500/20 text-emerald-300 border border-emerald-500/30'
                                                     : 'bg-amber-500/20 text-amber-300 border border-amber-500/30'">
                  {{ c.status }}
                </span>
              </div>
              <div class="text-sm text-slate-400 mt-1 truncate">
                IPv4: {{ c.ipv4 || '-' }} Â· Image: {{ c.image || '-' }}
              </div>
            </div>

            <div class="flex items-center gap-2 shrink-0">
              <button @click="doAction(c.name,'start')" class="px-3 py-2 rounded-xl bg-slate-100 text-slate-900 font-semibold">Start</button>
              <button @click="doAction(c.name,'stop')" class="px-3 py-2 rounded-xl bg-slate-800 text-slate-100 border border-slate-700">Stop</button>
              <button @click="doAction(c.name,'restart')" class="px-3 py-2 rounded-xl bg-slate-800 text-slate-100 border border-slate-700">Restart</button>
              <button @click="del(c.name)" class="px-3 py-2 rounded-xl bg-rose-500/90 text-white font-semibold">Delete</button>
            </div>
          </div>

          <div v-if="!filtered.length" class="text-slate-400">æ²¡æœ‰åŒ¹é…çš„å®¹å™¨ã€‚</div>
        </div>

        <div v-if="error" class="mt-4 rounded-xl border border-rose-800 bg-rose-950/40 p-3 text-rose-200 text-sm">
          {{ error }}
        </div>
      </div>
    </section>

    <footer class="text-xs text-slate-500">
      è¯´æ˜ï¼šè¯¥é¢æ¿è°ƒç”¨ proxy çš„ /api/*ï¼›proxy ç”¨å®¢æˆ·ç«¯è¯ä¹¦ä¸èŠ‚ç‚¹ mTLS ç½‘å…³é€šä¿¡ã€‚
    </footer>
  </div>

<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      proxyBase: "http://127.0.0.1:18080",
      loading: false,
      error: "",
      notice: "",
      filter: "",
      containers: [],
      form: {
        name: "",
        image: "images:debian/11",
        cpu: 1,
        memory: 512,
        disk: 5,
        ports: "",
        ingress: null,
        egress: null
      }
    };
  },
  computed: {
    filtered() {
      const kw = this.filter.trim().toLowerCase();
      return this.containers.filter(x => !kw || x.name.toLowerCase().includes(kw));
    }
  },
  methods: {
    async api(path, options = {}) {
      const url = this.proxyBase.replace(/\/+$/, "") + path;
      const res = await fetch(url, {
        headers: { "Content-Type": "application/json" },
        ...options
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data?.detail || data?.error || JSON.stringify(data) || `HTTP ${res.status}`);
      return data;
    },
    normalizeList(raw) {
      return (raw || []).map(item => {
        const name = item?.name || item?.Name || "unknown";
        const status = item?.status || item?.Status || item?.state?.status || "Unknown";
        const image = item?.config?.["image.description"] || item?.expanded_config?.["image.description"] || "";
        let ipv4 = "";
        try {
          const net = item?.state?.network || {};
          for (const nic of Object.values(net)) {
            const addrs = nic?.addresses || [];
            const v4 = addrs.find(a => a.family === "inet");
            if (v4?.address) { ipv4 = v4.address; break; }
          }
        } catch {}
        return { name, status: String(status || ""), ipv4, image };
      }).sort((a,b)=>a.name.localeCompare(b.name));
    },
    async refresh() {
      this.error = "";
      this.notice = "";
      this.loading = true;
      try {
        const raw = await this.api("/api/list", { method: "GET" });
        this.containers = this.normalizeList(raw);
      } catch (e) {
        this.error = String(e.message || e);
      } finally {
        this.loading = false;
      }
    },
    async create() {
      this.error = "";
      this.notice = "";
      if (!this.form.name.trim()) { this.notice = "å®¹å™¨åä¸èƒ½ä¸ºç©ºã€‚"; return; }
      const payload = { ...this.form };
      if (!payload.ports) delete payload.ports;
      if (!payload.ingress) delete payload.ingress;
      if (!payload.egress) delete payload.egress;

      try {
        await this.api("/api/create", { method: "POST", body: JSON.stringify(payload) });
        this.notice = "åˆ›å»ºè¯·æ±‚å·²æäº¤ã€‚ç­‰å®ƒè·‘èµ·æ¥åï¼Œç‚¹åˆ·æ–°ã€‚";
        await this.refresh();
      } catch (e) {
        this.error = String(e.message || e);
      }
    },
    async doAction(name, action) {
      this.error = "";
      try {
        await this.api(`/api/action/${encodeURIComponent(name)}/${encodeURIComponent(action)}`, { method: "POST" });
        await this.refresh();
      } catch (e) {
        this.error = String(e.message || e);
      }
    },
    async del(name) {
      this.error = "";
      if (!confirm(`ç¡®è®¤åˆ é™¤å®¹å™¨ï¼š${name} ï¼Ÿè¿™ä¸€æ­¥ä¸å¯é€†ã€‚`)) return;
      try {
        await this.api(`/api/delete/${encodeURIComponent(name)}`, { method: "DELETE" });
        await this.refresh();
      } catch (e) {
        this.error = String(e.message || e);
      }
    }
  },
  mounted() { this.refresh(); }
}).mount("#app");
</script>
</body>
</html>
EOF

  ok "é¢æ¿æ–‡ä»¶å·²ç”Ÿæˆï¼š${PANEL_HTML}"
}

# ==============================================================================
# 7) é˜²ç«å¢™æ”¾è¡Œï¼ˆæŒ‰éœ€ï¼‰
# ==============================================================================
configure_firewall() {
  echo -e "${YELLOW}[7/7] é…ç½®é˜²ç«å¢™(UFW) æ”¾è¡Œç«¯å£...${PLAIN}"
  # mTLS ç½‘å…³ 443
  ufw allow "${NGINX_HTTPS_PORT}/tcp" >/dev/null 2>&1 || true
  # SSH
  ufw allow 22/tcp >/dev/null 2>&1 || true
  # Proxyï¼ˆæ³¨æ„ï¼šæ— é‰´æƒï¼Œå…¬ç½‘æ…å¼€ï¼ï¼‰
  ufw allow "${PROXY_PORT}/tcp" >/dev/null 2>&1 || true
  ok "å·²æ”¾è¡Œï¼š443/tcp, 22/tcp, ${PROXY_PORT}/tcpï¼ˆproxyï¼‰"
}

# ==============================================================================
# Token è¾“å‡ºï¼ˆå¯é€‰ç»™â€œè·¨æœºå™¨é¢æ¿/ä»£ç†â€ç”¨ï¼›æœ¬æœºæ–¹æ¡ˆAé€šå¸¸ä¸éœ€è¦ï¼‰
# ==============================================================================
show_token() {
  local HOST_IP API_URL JSON_DATA TOKEN
  HOST_IP="$(hostname -I | awk '{print $1}')"
  [[ -z "${HOST_IP}" ]] && HOST_IP="127.0.0.1"
  API_URL="https://${HOST_IP}:${NGINX_HTTPS_PORT}"

  JSON_DATA="$(jq -n \
    --arg url "$API_URL" \
    --arg ca "$(cat ${CERT_DIR}/ca.crt)" \
    --arg cert "$(cat ${CERT_DIR}/client.crt)" \
    --arg key "$(cat ${CERT_DIR}/client.key)" \
    '{api_url: $url, ca_cert: $ca, client_cert: $cert, client_key: $key}')"

  TOKEN="$(echo "$JSON_DATA" | base64 -w0)"

  echo -e "\n${GREEN}==============================================${PLAIN}"
  echo -e "${GREEN}  å®‰è£…å®Œæˆï¼šLXD Agent + Nginx(mTLS) + Panel Proxy${PLAIN}"
  echo -e "${GREEN}==============================================${PLAIN}"
  echo -e "Agent (æœ¬æœº):       http://127.0.0.1:${UVICORN_PORT}"
  echo -e "mTLS ç½‘å…³(å¯¹å¤–):    https://${HOST_IP}:${NGINX_HTTPS_PORT}"
  echo -e "Panel Proxy(å¯¹å¤–):  http://${HOST_IP}:${PROXY_PORT}"
  echo -e "é¢æ¿æ–‡ä»¶:           ${PANEL_HTML}"
  echo -e ""
  echo -e "${YELLOW}é¢æ¿ä½¿ç”¨æ–¹æ³•ï¼š${PLAIN}"
  echo -e "1) æŠŠ ${PANEL_HTML} ä¸‹è½½åˆ°æœ¬åœ°ï¼ˆæˆ–ç”¨æµè§ˆå™¨ç›´æ¥æ‰“å¼€ï¼‰"
  echo -e "2) é¢æ¿é‡Œ Proxy åœ°å€å¡«ï¼š http://${HOST_IP}:${PROXY_PORT}"
  echo -e ""
  echo -e "${YELLOW}å¦‚éœ€ç»™â€œå¤–éƒ¨é¢æ¿/å¤–éƒ¨ä»£ç†â€å¯¼å…¥è¯ä¹¦ï¼Œå¯ç”¨ä¸‹æ–¹ Tokenï¼š${PLAIN}"
  echo -e "${YELLOW}${TOKEN}${PLAIN}"
  echo -e ""
  warn "å®‰å…¨æç¤ºï¼šProxy ç«¯å£ ${PROXY_PORT} é»˜è®¤æ— é‰´æƒï¼Œå…¬ç½‘å¼€æ”¾è¯·åŠ è®¤è¯æˆ–é™åˆ¶ IPï¼"
}

# ==============================================================================
# ä¸»æµç¨‹
# ==============================================================================
install_env
generate_certs
deploy_agent
configure_nginx_mtls
install_panel_proxy
write_panel_html
configure_firewall
show_token
