#!/bin/bash

# ==============================================================================
# é¡¹ç›®åç§°: LXD Master Panel (å‰ç«¯ä¸»æ§)
# æ–‡ä»¶åç§°: lxd-panel.sh
# è¿è¡Œç¯å¢ƒ: Debian 11+ / Ubuntu 20.04+ (éœ€ Root æƒé™)
#
# [ ä½¿ç”¨è¯´æ˜ ]
# 1. èµ‹äºˆæ‰§è¡Œæƒé™å¹¶è¿è¡Œ:
#    chmod +x lxd-panel.sh && ./lxd-panel.sh
#
# [ åŠŸèƒ½æè¿° ]
# - è‡ªåŠ¨å®‰è£… Python3ã€Pipã€Flask ç¯å¢ƒ
# - éƒ¨ç½² LXD å‰ç«¯ç®¡ç†é¢æ¿ (Web UI)
# - é…ç½® Systemd æœåŠ¡å®ˆæŠ¤è¿›ç¨‹ (å¼€æœºè‡ªå¯)
# ==============================================================================

# --- é…ç½® ---
PANEL_DIR="/opt/lxd-panel"
PORT=5000

# --- é¢œè‰² ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
PLAIN='\033[0m'

# æ£€æŸ¥ Root
[[ $EUID -ne 0 ]] && echo -e "${RED}é”™è¯¯ï¼šè¯·ä½¿ç”¨ root æƒé™è¿è¡Œæ­¤è„šæœ¬ï¼${PLAIN}" && exit 1

function install_dependencies() {
    echo -e "${YELLOW}[1/4] å®‰è£…ç³»ç»Ÿä¾èµ–ä¸ Python ç¯å¢ƒ...${PLAIN}"
    apt-get update -qq
    apt-get install -y -qq python3 python3-pip python3-venv >/dev/null
    
    # åˆ›å»ºç›®å½•
    mkdir -p "${PANEL_DIR}"
    
    # å®‰è£… Python åº“ (ç›´æ¥å®‰è£…åˆ°ç³»ç»Ÿæˆ–ç”¨æˆ·ç¯å¢ƒï¼Œç®€åŒ–éƒ¨ç½²)
    echo "    - æ­£åœ¨å®‰è£… Flask å’Œ Requests..."
    pip3 install flask requests >/dev/null 2>&1
}

function deploy_code() {
    echo -e "${YELLOW}[2/4] éƒ¨ç½²é¢æ¿æ ¸å¿ƒä»£ç ...${PLAIN}"

    # å†™å…¥ app.py (ä½¿ç”¨ 'EOF' é¿å… Shell å˜é‡å¹²æ‰° Python ä»£ç )
    cat > "${PANEL_DIR}/app.py" <<'PYTHON_EOF'
# -*- coding: utf-8 -*-
import os
import sys
import json
import time
import base64
import sqlite3
import logging
import requests
import datetime
import threading
from functools import wraps
from flask import Flask, request, session, redirect, url_for, flash, render_template_string

# ================= é…ç½®åŒºåŸŸ =================
SECRET_KEY = os.urandom(24)  # Session å¯†é’¥
DB_FILE = 'panel.db'         # æ•°æ®åº“æ–‡ä»¶
PORT_START = 10000           # NAT ç«¯å£èµ·å§‹å€¼
ADMIN_USER = 'admin'         # é»˜è®¤ç®¡ç†å‘˜
ADMIN_PASS = 'admin123'      # é»˜è®¤å¯†ç 
# ============================================

# è®¾ç½®å½“å‰å·¥ä½œç›®å½•ï¼Œç¡®ä¿æ•°æ®åº“ç”Ÿæˆåœ¨æ­£ç¡®ä½ç½®
os.chdir(os.path.dirname(os.path.abspath(__file__)))

app = Flask(__name__)
app.secret_key = SECRET_KEY
logging.basicConfig(level=logging.INFO)

# ================= HTML æ¨¡æ¿ =================
TEMPLATES = {
    'layout': """
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>LXD äº‘ç®¡é¢æ¿</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; }
        .sidebar { min-height: 100vh; background: #2c3e50; color: #ecf0f1; }
        .sidebar a { color: #bdc3c7; text-decoration: none; display: block; padding: 12px 20px; }
        .sidebar a:hover, .sidebar a.active { background: #34495e; color: #fff; }
        .main-content { padding: 30px; }
        .status-running { color: #27ae60; font-weight: bold; }
        .status-stopped { color: #e74c3c; font-weight: bold; }
        .card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
    </style>
</head>
<body>
<div class="d-flex">
    <div class="sidebar col-md-2 d-none d-md-block">
        <h4 class="text-center py-4">â˜ï¸ LXD Panel</h4>
        <a href="/">ğŸ“Š ä»ªè¡¨ç›˜</a>
        {% if session.is_admin %}
        <a href="/admin/nodes">ğŸ–¥ï¸ èŠ‚ç‚¹ç®¡ç†</a>
        <a href="/admin/users">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</a>
        {% endif %}
        <a href="/logout" class="mt-5 text-danger">ğŸšª é€€å‡ºç™»å½•</a>
    </div>
    <div class="col-md-10 main-content">
        <div class="d-md-none mb-3">
            <a href="/" class="btn btn-secondary btn-sm">é¦–é¡µ</a>
            <a href="/logout" class="btn btn-danger btn-sm float-end">é€€å‡º</a>
        </div>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        {% block content %}{% endblock %}
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
""",

    'login': """
<!DOCTYPE html>
<html>
<head>
    <title>ç™»å½• - LXD Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #e9ecef; display: flex; align-items: center; justify-content: center; height: 100vh; }
        .login-box { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
    </style>
</head>
<body>
    <div class="login-box">
        <h3 class="text-center mb-4">LXD é¢æ¿ç™»å½•</h3>
        <form method="post">
            <div class="mb-3">
                <input type="text" name="username" class="form-control" placeholder="ç”¨æˆ·å" required autofocus>
            </div>
            <div class="mb-3">
                <input type="password" name="password" class="form-control" placeholder="å¯†ç " required>
            </div>
            <button class="btn btn-primary w-100">ç«‹å³ç™»å½•</button>
        </form>
    </div>
</body>
</html>
""",

    'dashboard': """
{% extends "layout" %}
{% block content %}
<h4 class="mb-4">æˆ‘çš„å®ä¾‹</h4>

<div class="card p-4">
    <h5 class="card-title mb-3">ğŸš€ å¼€é€šæ–°å®ä¾‹</h5>
    <form action="/create" method="POST" class="row g-3">
        <div class="col-md-3">
            <label class="form-label">é€‰æ‹©èŠ‚ç‚¹</label>
            <select name="node_id" class="form-select" required>
                {% for node in nodes %}
                <option value="{{ node[0] }}">{{ node[1] }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">é•œåƒç³»ç»Ÿ</label>
            <select name="image" class="form-select">
                <option value="images:debian/11">Debian 11</option>
                <option value="images:ubuntu/22.04">Ubuntu 22.04</option>
                <option value="images:centos/7">CentOS 7</option>
                <option value="images:alpine/3.15">Alpine Linux</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">CPU (æ ¸)</label>
            <select name="cpu" class="form-select">
                <option value="1">1 Core</option>
                <option value="2">2 Cores</option>
                <option value="4">4 Cores</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">å†…å­˜ (MB)</label>
            <input type="number" name="memory" class="form-control" value="512" min="128">
        </div>
        <div class="col-md-2 d-grid">
            <label class="form-label">&nbsp;</label>
            <button type="submit" class="btn btn-success">ç«‹å³åˆ›å»º</button>
        </div>
    </form>
</div>

<div class="card">
    <div class="card-body p-0">
        <table class="table table-hover mb-0" style="vertical-align: middle;">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>å®¹å™¨åç§° / èŠ‚ç‚¹</th>
                    <th>é…ç½® (C/M/D)</th>
                    <th>ç«¯å£æ˜ å°„ (å…¬ç½‘ -> å†…ç½‘)</th>
                    <th>åˆ°æœŸæ—¶é—´</th>
                    <th>çŠ¶æ€</th>
                    <th class="text-end">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for i in instances %}
                <tr>
                    <td>#{{ i[0] }}</td>
                    <td>
                        <strong>{{ i[3] }}</strong><br>
                        <span class="badge bg-light text-dark">{{ i[10] }}</span>
                    </td>
                    <td>{{ i[4] }}C / {{ i[5] }}MB / {{ i[6] }}GB</td>
                    <td>
                        {% for p in i[7].split(',') %}
                        <span class="badge bg-info text-dark">{{ p }}</span>
                        {% endfor %}
                    </td>
                    <td><small>{{ i[8] }}</small></td>
                    <td><span class="status-{{ i[9] }}">{{ i[9] }}</span></td>
                    <td class="text-end">
                        <div class="btn-group btn-group-sm">
                            <a href="/action/start/{{ i[0] }}" class="btn btn-outline-success">å¼€æœº</a>
                            <a href="/action/stop/{{ i[0] }}" class="btn btn-outline-warning">å…³æœº</a>
                            <button type="button" class="btn btn-outline-danger dropdown-toggle" data-bs-toggle="dropdown">æ›´å¤š</button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item text-danger" href="/action/reinstall/{{ i[0] }}" onclick="return confirm('ç¡®å®šè¦é‡è£…ç³»ç»Ÿå—ï¼Ÿæ•°æ®å°†ä¸¢å¤±ï¼')">é‡è£…ç³»ç»Ÿ</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="/action/delete/{{ i[0] }}" onclick="return confirm('ç¡®å®šè¦åˆ é™¤æ­¤å®ä¾‹å—ï¼Ÿ')">åˆ é™¤å®ä¾‹</a></li>
                            </ul>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="7" class="text-center py-4 text-muted">æš‚æ— è¿è¡Œä¸­çš„å®ä¾‹</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
""",

    'nodes': """
{% extends "layout" %}
{% block content %}
<h4 class="mb-4">èŠ‚ç‚¹ç®¡ç†</h4>

<div class="card p-4">
    <form action="/admin/nodes/add" method="POST">
        <label class="form-label fw-bold">æ·»åŠ æ–°èŠ‚ç‚¹ (ç²˜è´´ lxd-agent.sh ç”Ÿæˆçš„ Token)</label>
        <div class="input-group">
            <input type="text" name="name" class="form-control" placeholder="èŠ‚ç‚¹åç§° (å¦‚: US-LAX-01)" style="max-width: 200px;" required>
            <input type="text" name="token" class="form-control" placeholder="ç²˜è´´ Base64 Token..." required>
            <button class="btn btn-primary">æ·»åŠ å¯¹æ¥</button>
        </div>
    </form>
</div>

<div class="row">
    {% for n in nodes %}
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">{{ n[1] }}</h5>
                <p class="card-text text-truncate text-muted">{{ n[2] }}</p>
                <a href="/admin/nodes/delete/{{ n[0] }}" class="btn btn-sm btn-outline-danger w-100" onclick="return confirm('ç¡®å®šåˆ é™¤è¯¥èŠ‚ç‚¹ï¼Ÿ')">åˆ é™¤èŠ‚ç‚¹</a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}
""",

    'users': """
{% extends "layout" %}
{% block content %}
<h4 class="mb-4">ç”¨æˆ·ç®¡ç†</h4>

<div class="card p-4">
    <form action="/admin/users/add" method="POST" class="row g-2">
        <div class="col-md-3"><input name="username" class="form-control" placeholder="ç”¨æˆ·å" required></div>
        <div class="col-md-3"><input name="password" class="form-control" placeholder="å¯†ç " required></div>
        <div class="col-md-2"><input name="balance" type="number" class="form-control" placeholder="ä½™é¢" value="0"></div>
        <div class="col-md-2">
            <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" name="is_admin" value="1" id="isAdmin">
                <label class="form-check-label" for="isAdmin">ç®¡ç†å‘˜</label>
            </div>
        </div>
        <div class="col-md-2"><button class="btn btn-success w-100">æ·»åŠ ç”¨æˆ·</button></div>
    </form>
</div>

<table class="table table-striped bg-white">
    <thead><tr><th>ID</th><th>ç”¨æˆ·å</th><th>ä½™é¢ (CNY)</th><th>è§’è‰²</th><th>æ“ä½œ</th></tr></thead>
    <tbody>
        {% for u in users %}
        <tr>
            <td>{{ u[0] }}</td>
            <td>{{ u[1] }}</td>
            <td>Â¥ {{ u[3] }}</td>
            <td><span class="badge bg-{{ 'primary' if u[4] else 'secondary' }}">{{ 'ç®¡ç†å‘˜' if u[4] else 'æ™®é€šç”¨æˆ·' }}</span></td>
            <td>
                {% if u[1] != 'admin' %}
                <a href="/admin/users/delete/{{ u[0] }}" class="btn btn-sm btn-danger" onclick="return confirm('ç¡®å®šåˆ é™¤ç”¨æˆ·ï¼Ÿ')">åˆ é™¤</a>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}
"""
}

# ================= æ•°æ®åº“æ“ä½œ =================
def get_db():
    conn = sqlite3.connect(DB_FILE)
    conn.row_factory = sqlite3.Row
    return conn

def init_db():
    conn = get_db()
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS users 
                 (id INTEGER PRIMARY KEY, username TEXT UNIQUE, password TEXT, balance REAL, is_admin INTEGER)''')
    c.execute('''CREATE TABLE IF NOT EXISTS nodes 
                 (id INTEGER PRIMARY KEY, name TEXT, api_url TEXT, ca_cert TEXT, client_cert TEXT, client_key TEXT)''')
    c.execute('''CREATE TABLE IF NOT EXISTS instances 
                 (id INTEGER PRIMARY KEY, user_id INTEGER, node_id INTEGER, name TEXT, 
                  cpu INTEGER, memory INTEGER, disk INTEGER, ports TEXT, expiry_date TEXT, status TEXT)''')
    try:
        c.execute("INSERT INTO users (username, password, balance, is_admin) VALUES (?, ?, 9999, 1)", (ADMIN_USER, ADMIN_PASS))
    except sqlite3.IntegrityError:
        pass
    conn.commit()
    conn.close()

# ================= åå°é€šä¿¡é€»è¾‘ =================
def agent_request(node_id, method, endpoint, payload=None):
    conn = get_db()
    node = conn.cursor().execute("SELECT * FROM nodes WHERE id=?", (node_id,)).fetchone()
    conn.close()

    if not node:
        return {"error": "Node not found"}

    temp_prefix = f"/tmp/lxd_node_{node_id}"
    with open(f"{temp_prefix}_ca.crt", 'w') as f: f.write(node['ca_cert'])
    with open(f"{temp_prefix}.crt", 'w') as f: f.write(node['client_cert'])
    with open(f"{temp_prefix}.key", 'w') as f: f.write(node['client_key'])

    url = f"{node['api_url']}{endpoint}"
    headers = {"X-API-Key": "init_failed"}

    try:
        kwargs = {
            "json": payload,
            "verify": f"{temp_prefix}_ca.crt",
            "cert": (f"{temp_prefix}.crt", f"{temp_prefix}.key"),
            "timeout": 10
        }
        if method == 'GET': resp = requests.get(url, **kwargs)
        elif method == 'POST': resp = requests.post(url, **kwargs)
        elif method == 'DELETE': resp = requests.delete(url, **kwargs)
        
        if resp.status_code != 200:
            return {"error": f"API Error {resp.status_code}: {resp.text}"}
        return resp.json()
    except Exception as e:
        return {"error": str(e)}

def allocate_ports():
    conn = get_db()
    c = conn.cursor()
    instances = c.execute("SELECT ports FROM instances").fetchall()
    conn.close()
    
    max_port = PORT_START
    for inst in instances:
        if inst['ports']:
            for mapping in inst['ports'].split(','):
                try:
                    p = int(mapping.split(':')[0])
                    if p > max_port: max_port = p
                except: pass
    
    return max_port + 1, max_port + 2

# ================= è·¯ç”±æ§åˆ¶ =================
def login_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session:
            return redirect(url_for('login'))
        return f(*args, **kwargs)
    return decorated_function

@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        u = request.form['username']
        p = request.form['password']
        conn = get_db()
        user = conn.cursor().execute("SELECT * FROM users WHERE username=? AND password=?", (u, p)).fetchone()
        conn.close()
        if user:
            session['user_id'] = user['id']
            session['is_admin'] = user['is_admin']
            return redirect('/')
        flash('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯', 'danger')
    return render_template_string(TEMPLATES['login'])

@app.route('/logout')
def logout():
    session.clear()
    return redirect('/login')

@app.route('/')
@login_required
def dashboard():
    conn = get_db()
    c = conn.cursor()
    if session['is_admin']:
        sql = "SELECT i.*, n.name as node_name FROM instances i LEFT JOIN nodes n ON i.node_id = n.id"
        instances = c.execute(sql).fetchall()
    else:
        sql = "SELECT i.*, n.name as node_name FROM instances i LEFT JOIN nodes n ON i.node_id = n.id WHERE i.user_id=?"
        instances = c.execute(sql, (session['user_id'],)).fetchall()
    
    nodes = c.execute("SELECT id, name FROM nodes").fetchall()
    conn.close()
    
    full_html = TEMPLATES['dashboard'].replace('{% extends "layout" %}', TEMPLATES['layout'])
    return render_template_string(full_html, instances=instances, nodes=nodes)

@app.route('/create', methods=['POST'])
@login_required
def create():
    node_id = request.form['node_id']
    image = request.form['image']
    cpu = int(request.form['cpu'])
    mem = int(request.form['memory'])
    disk = 10 
    
    p_ssh, p_web = allocate_ports()
    port_map = f"{p_ssh}:22,{p_web}:80"
    name = f"u{session['user_id']}-{int(time.time())}"
    
    payload = {
        "name": name, "image": image, 
        "cpu": cpu, "memory": mem, "disk": disk,
        "ports": port_map, "ingress": 50, "egress": 50
    }
    res = agent_request(node_id, 'POST', '/create', payload)
    
    if 'error' in res:
        flash(f"å¼€é€šå¤±è´¥: {res['error']}", 'danger')
    else:
        expiry = (datetime.datetime.now() + datetime.timedelta(days=30)).strftime("%Y-%m-%d %H:%M:%S")
        conn = get_db()
        conn.cursor().execute(
            "INSERT INTO instances (user_id, node_id, name, cpu, memory, disk, ports, expiry_date, status) VALUES (?,?,?,?,?,?,?,?,?)",
            (session['user_id'], node_id, name, cpu, mem, disk, port_map, expiry, 'running')
        )
        conn.commit()
        conn.close()
        flash(f"å¼€é€šæˆåŠŸï¼SSH ç«¯å£: {p_ssh}", 'success')
        
    return redirect('/')

@app.route('/action/<op>/<int:id>')
@login_required
def action(op, id):
    conn = get_db()
    c = conn.cursor()
    inst = c.execute("SELECT * FROM instances WHERE id=?", (id,)).fetchone()
    
    if not inst: return "Not Found"
    if inst['user_id'] != session['user_id'] and not session['is_admin']: return "Permission Denied"
        
    node_id = inst['node_id']
    name = inst['name']
    
    if op in ['start', 'stop']:
        agent_request(node_id, 'POST', f"/action/{name}/{op}")
        c.execute("UPDATE instances SET status=? WHERE id=?", ('running' if op=='start' else 'stopped', id))
        conn.commit()
        flash(f"æ“ä½œå·²å‘é€: {op}", 'success')

    elif op == 'delete':
        agent_request(node_id, 'DELETE', f"/delete/{name}")
        c.execute("DELETE FROM instances WHERE id=?", (id,))
        conn.commit()
        flash("å®ä¾‹å·²åˆ é™¤", 'success')

    elif op == 'reinstall':
        agent_request(node_id, 'DELETE', f"/delete/{name}")
        time.sleep(2)
        payload = {
            "name": name, "image": "images:debian/11",
            "cpu": inst['cpu'], "memory": inst['memory'], "disk": inst['disk'],
            "ports": inst['ports'], "ingress": 50, "egress": 50
        }
        res = agent_request(node_id, 'POST', '/create', payload)
        if 'error' in res:
            flash(f"é‡è£…å¤±è´¥: {res['error']}", 'danger')
        else:
            flash("é‡è£…æˆåŠŸï¼ç³»ç»Ÿå·²è¿˜åŸã€‚", 'success')
            
    conn.close()
    return redirect('/')

# --- ç®¡ç†å‘˜è·¯ç”± ---
@app.route('/admin/nodes', methods=['GET'])
@login_required
def admin_nodes():
    if not session['is_admin']: return redirect('/')
    conn = get_db()
    nodes = conn.cursor().execute("SELECT * FROM nodes").fetchall()
    conn.close()
    full_html = TEMPLATES['nodes'].replace('{% extends "layout" %}', TEMPLATES['layout'])
    return render_template_string(full_html, nodes=nodes)

@app.route('/admin/nodes/add', methods=['POST'])
@login_required
def add_node():
    if not session['is_admin']: return "403"
    try:
        token = request.form['token']
        data = json.loads(base64.b64decode(token).decode('utf-8'))
        conn = get_db()
        conn.cursor().execute(
            "INSERT INTO nodes (name, api_url, ca_cert, client_cert, client_key) VALUES (?,?,?,?,?)",
            (request.form['name'], data['api_url'], data['ca_cert'], data['client_cert'], data['client_key'])
        )
        conn.commit()
        conn.close()
        flash("èŠ‚ç‚¹æ·»åŠ æˆåŠŸ", 'success')
    except Exception as e:
        flash(f"æ·»åŠ å¤±è´¥: {str(e)}", 'danger')
    return redirect('/admin/nodes')

@app.route('/admin/nodes/delete/<int:id>')
@login_required
def delete_node(id):
    if not session['is_admin']: return "403"
    conn = get_db()
    conn.cursor().execute("DELETE FROM nodes WHERE id=?", (id,))
    conn.commit()
    conn.close()
    flash("èŠ‚ç‚¹å·²åˆ é™¤", 'success')
    return redirect('/admin/nodes')

@app.route('/admin/users', methods=['GET'])
@login_required
def admin_users():
    if not session['is_admin']: return redirect('/')
    conn = get_db()
    users = conn.cursor().execute("SELECT * FROM users").fetchall()
    conn.close()
    full_html = TEMPLATES['users'].replace('{% extends "layout" %}', TEMPLATES['layout'])
    return render_template_string(full_html, users=users)

@app.route('/admin/users/add', methods=['POST'])
@login_required
def add_user():
    if not session['is_admin']: return "403"
    try:
        is_admin = 1 if request.form.get('is_admin') else 0
        conn = get_db()
        conn.cursor().execute(
            "INSERT INTO users (username, password, balance, is_admin) VALUES (?,?,?,?)",
            (request.form['username'], request.form['password'], request.form['balance'], is_admin)
        )
        conn.commit()
        conn.close()
        flash("ç”¨æˆ·åˆ›å»ºæˆåŠŸ", 'success')
    except Exception as e:
        flash("ç”¨æˆ·åˆ›å»ºå¤±è´¥", 'danger')
    return redirect('/admin/users')

@app.route('/admin/users/delete/<int:id>')
@login_required
def delete_user(id):
    if not session['is_admin']: return "403"
    conn = get_db()
    conn.cursor().execute("DELETE FROM users WHERE id=?", (id,))
    conn.commit()
    conn.close()
    flash("ç”¨æˆ·å·²åˆ é™¤", 'success')
    return redirect('/admin/users')

# ================= è®¡è´¹çº¿ç¨‹ =================
def billing_monitor():
    while True:
        try:
            conn = sqlite3.connect(DB_FILE)
            conn.row_factory = sqlite3.Row
            c = conn.cursor()
            now = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            rows = c.execute("SELECT * FROM instances WHERE expiry_date < ? AND status != 'stopped'", (now,)).fetchall()
            for r in rows:
                c.execute("UPDATE instances SET status='stopped' WHERE id=?", (r['id'],))
            conn.commit()
            conn.close()
        except: pass
        time.sleep(60)

if __name__ == '__main__':
    if not os.path.exists(DB_FILE):
        init_db()
    threading.Thread(target=billing_monitor, daemon=True).start()
    app.run(host='0.0.0.0', port=5000)
PYTHON_EOF
}

function configure_service() {
    echo -e "${YELLOW}[3/4] é…ç½® Systemd æœåŠ¡...${PLAIN}"
    
    cat > /etc/systemd/system/lxd-panel.service <<EOF
[Unit]
Description=LXD Management Panel
After=network.target
[Service]
WorkingDirectory=${PANEL_DIR}
ExecStart=/usr/bin/python3 ${PANEL_DIR}/app.py
Restart=always
User=root
[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl enable lxd-panel >/dev/null 2>&1
    systemctl restart lxd-panel
    
    # æ”¾è¡Œç«¯å£
    ufw allow ${PORT}/tcp >/dev/null 2>&1
}

function show_info() {
    HOST_IP=$(hostname -I | awk '{print $1}')
    
    echo -e "\n${GREEN}================ å®‰è£…å®Œæˆ ================${PLAIN}"
    echo -e "é¢æ¿æœåŠ¡å·²å¯åŠ¨ï¼"
    echo -e "è®¿é—®åœ°å€: ${YELLOW}http://${HOST_IP}:${PORT}${PLAIN}"
    echo -e "é»˜è®¤ç”¨æˆ·: ${YELLOW}admin${PLAIN}"
    echo -e "é»˜è®¤å¯†ç : ${YELLOW}admin123${PLAIN}"
    echo -e "${GREEN}==========================================${PLAIN}"
}

# --- æ‰§è¡Œ ---
install_dependencies
deploy_code
configure_service
show_info
