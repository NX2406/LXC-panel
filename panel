#!/usr/bin/env bash
set -euo pipefail

# =========================
# LXD Panel Secure - OneKey
# (Front+Backend+Nginx+Systemd)
# =========================

APP_DIR="/opt/lxd-panel"
DATA_DIR="${APP_DIR}/data"
CERT_CACHE="${APP_DIR}/cert-cache"
LOG_DIR="/var/log/lxd-panel"
PY_VENV="${APP_DIR}/.venv"

say()  { echo -e "\033[1;36m[*]\033[0m $*"; }
warn() { echo -e "\033[1;33m[!]\033[0m $*"; }
err()  { echo -e "\033[1;31m[âœ—]\033[0m $*"; }

need_root() {
  if [[ "${EUID}" -ne 0 ]]; then
    err "è¯·ä½¿ç”¨ root è¿è¡Œï¼šsudo bash panel_onekey.sh"
    exit 1
  fi
}

ask() {
  local prompt="$1"
  local def="$2"
  local var
  read -r -p "${prompt}ï¼ˆé»˜è®¤ ${def}ï¼‰: " var
  echo "${var:-$def}"
}

ask_yn() {
  local prompt="$1"
  local def="$2" # y/n
  local var
  read -r -p "${prompt} (y/nï¼Œé»˜è®¤ ${def}): " var
  var="${var:-$def}"
  var="$(echo "$var" | tr '[:upper:]' '[:lower:]')"
  if [[ "$var" != "y" && "$var" != "n" ]]; then
    echo "$def"
  else
    echo "$var"
  fi
}

normalize_base_path() {
  local p="$1"
  p="${p:-/}"
  if [[ "$p" == "/" ]]; then
    echo "/"
    return
  fi
  p="/$(echo "$p" | sed 's#^/*##; s#/*$##')"
  echo "$p"
}

write_file() {
  local path="$1"
  shift
  mkdir -p "$(dirname "$path")"
  cat > "$path" <<'EOF'
'"$@"'
EOF
}

need_root

say "LXD Panelï¼ˆä¸€é”®å®‰è£…ï¼Œå®‰å…¨ä¼˜å…ˆ mTLS + Key æ¶æ„çš„é¢æ¿ç«¯ï¼‰"
PANEL_PORT="$(ask "1) é¢æ¿å¯¹å¤–ç«¯å£ï¼ˆNginx listenï¼‰" "80")"
BACKEND_PORT="$(ask "2) é¢æ¿åç«¯ç«¯å£ï¼ˆuvicornï¼‰" "8089")"
BASE_PATH_RAW="$(ask "3) é¢æ¿è®¿é—®è·¯å¾„ï¼ˆ/ æˆ– /panelï¼‰" "/")"
BASE_PATH="$(normalize_base_path "$BASE_PATH_RAW")"

CUSTOM_ADMIN="$(ask_yn "4) admin è´¦å·å¯†ç æ˜¯å¦è‡ªå®šä¹‰ï¼Ÿ" "n")"
ADMIN_USER="admin"
ADMIN_PASS="ChangeMeNow!"
if [[ "${CUSTOM_ADMIN}" == "y" ]]; then
  ADMIN_USER="$(ask "   - admin ç”¨æˆ·å" "admin")"
  read -r -p "   - admin å¯†ç ï¼ˆå»ºè®®å¼ºå¯†ç ï¼Œç•™ç©ºåˆ™ä»ç”¨é»˜è®¤ï¼‰: " ADMIN_PASS_IN
  if [[ -n "${ADMIN_PASS_IN}" ]]; then
    ADMIN_PASS="${ADMIN_PASS_IN}"
  fi
fi

WANT_TLS="$(ask_yn "5) é¢æ¿æ˜¯å¦ç”³è¯· HTTPS è¯ä¹¦ï¼ˆLetâ€™s Encryptï¼Œéœ€è¦åŸŸåï¼‰ï¼Ÿ" "n")"
TLS_MODE="none"
DOMAIN="_"
EMAIL=""
if [[ "${WANT_TLS}" == "y" ]]; then
  TLS_MODE="letsencrypt"
  read -r -p "   - è¾“å…¥ç»‘å®šåˆ°æœ¬æœºçš„åŸŸåï¼ˆå¦‚ panel.example.comï¼‰: " DOMAIN_IN
  DOMAIN="${DOMAIN_IN:-_}"
  read -r -p "   - è¾“å…¥é‚®ç®±ï¼ˆLetâ€™s Encrypt ç”¨ï¼‰: " EMAIL
fi

say "å‚æ•°ç¡®è®¤ï¼š"
echo "  - Nginx ç«¯å£: ${PANEL_PORT}"
echo "  - åç«¯ç«¯å£:   ${BACKEND_PORT}"
echo "  - è®¿é—®è·¯å¾„:   ${BASE_PATH}"
echo "  - Admin:      ${ADMIN_USER}"
echo "  - TLS:        ${TLS_MODE} (domain=${DOMAIN})"
echo

say "å®‰è£…ä¾èµ–..."
apt-get update -y
apt-get install -y nginx python3 python3-venv python3-pip openssl jq curl

if [[ "${TLS_MODE}" == "letsencrypt" ]]; then
  say "å®‰è£… certbot..."
  apt-get install -y certbot python3-certbot-nginx
fi

say "åˆ›å»ºç›®å½•..."
mkdir -p "${APP_DIR}" "${DATA_DIR}" "${CERT_CACHE}" "${LOG_DIR}"
chmod 700 "${CERT_CACHE}" || true

# =========================
# Write backend app.py
# =========================
say "å†™å…¥åç«¯ app.py..."
cat > "${APP_DIR}/app.py" <<'PY'
import os, re, time, sqlite3, base64, json
from typing import Optional, List, Dict, Any
import httpx
from fastapi import FastAPI, HTTPException, Request, Depends
from fastapi.middleware.cors import CORSMiddleware
from jose import jwt, JWTError
from passlib.context import CryptContext
from pydantic import BaseModel

APP_NAME = "LXD-Panel"
DB_PATH = os.environ.get("LXD_PANEL_DB", "/opt/lxd-panel/data/panel.db")
JWT_SECRET = os.environ.get("LXD_PANEL_JWT_SECRET", "PLEASE_CHANGE_ME")
CERT_CACHE = os.environ.get("LXD_PANEL_CERT_CACHE", "/opt/lxd-panel/cert-cache")
JWT_ALG = "HS256"
TOKEN_TTL_SECONDS = 12 * 3600

# install.sh ä¼šæ³¨å…¥ï¼›é¦–æ¬¡å¯åŠ¨è‹¥æ—  admin åˆ™ seed
SEED_ADMIN_USER = os.environ.get("LXD_PANEL_ADMIN_USER", "admin")
SEED_ADMIN_PASS = os.environ.get("LXD_PANEL_ADMIN_PASS", "ChangeMeNow!")

ALLOWED_IMAGES = [
    "images:ubuntu/22.04",
    "images:ubuntu/24.04",
    "images:debian/12",
]

NAME_RE = re.compile(r"^[a-zA-Z0-9][a-zA-Z0-9\-]{1,30}$")
pwd_ctx = CryptContext(schemes=["bcrypt"], deprecated="auto")

def db():
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    # ç¨³å®šæ€§ï¼šWAL æ›´é€‚åˆå¹¶å‘è¯»å†™
    conn.execute("PRAGMA journal_mode=WAL;")
    conn.execute("PRAGMA synchronous=NORMAL;")
    return conn

def init_db():
    conn = db()
    cur = conn.cursor()
    cur.execute("""
    CREATE TABLE IF NOT EXISTS users(
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      username TEXT UNIQUE NOT NULL,
      password_hash TEXT NOT NULL,
      role TEXT NOT NULL DEFAULT 'user',
      created_at INTEGER NOT NULL
    );
    """)
    cur.execute("""
    CREATE TABLE IF NOT EXISTS nodes(
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      name TEXT NOT NULL,
      base_url TEXT NOT NULL,
      panel_key TEXT NOT NULL,
      ca_pem TEXT NOT NULL,
      client_cert_pem TEXT NOT NULL,
      client_key_pem TEXT NOT NULL,
      created_at INTEGER NOT NULL
    );
    """)
    conn.commit()

    # åªåœ¨ä¸å­˜åœ¨ä»»ä½• admin æ—¶ seed
    cur.execute("SELECT id FROM users WHERE role='admin' LIMIT 1")
    if not cur.fetchone():
        cur.execute(
            "INSERT INTO users(username,password_hash,role,created_at) VALUES(?,?,?,?)",
            (SEED_ADMIN_USER, pwd_ctx.hash(SEED_ADMIN_PASS), "admin", int(time.time()))
        )
        conn.commit()
    conn.close()

def make_token(user: Dict[str, Any]) -> str:
    payload = {
        "sub": user["username"],
        "role": user["role"],
        "uid": user["id"],
        "exp": int(time.time()) + TOKEN_TTL_SECONDS
    }
    return jwt.encode(payload, JWT_SECRET, algorithm=JWT_ALG)

def parse_token(token: str) -> Dict[str, Any]:
    try:
        return jwt.decode(token, JWT_SECRET, algorithms=[JWT_ALG])
    except JWTError:
        raise HTTPException(status_code=401, detail="Invalid token")

def current_user(req: Request) -> Dict[str, Any]:
    auth = req.headers.get("Authorization", "")
    if not auth.startswith("Bearer "):
        raise HTTPException(status_code=401, detail="Missing token")
    return parse_token(auth.split(" ", 1)[1].strip())

def require_admin(user=Depends(current_user)):
    if user.get("role") != "admin":
        raise HTTPException(status_code=403, detail="Admin only")
    return user

def ensure_short_name(short: str):
    if not NAME_RE.match(short):
        raise HTTPException(status_code=400, detail="Invalid name. Use letters/numbers/dash, 2-31 chars.")

def user_prefix(user: Dict[str, Any]) -> str:
    return f"u_{user['uid']}_"

def full_name(user: Dict[str, Any], short: str) -> str:
    return user_prefix(user) + short

def get_node(node_id: int) -> sqlite3.Row:
    conn = db()
    cur = conn.cursor()
    cur.execute("SELECT * FROM nodes WHERE id=?", (node_id,))
    row = cur.fetchone()
    conn.close()
    if not row:
        raise HTTPException(status_code=404, detail="node not found")
    return row

def _write_cert_files(node: sqlite3.Row) -> Dict[str, str]:
    os.makedirs(CERT_CACHE, exist_ok=True)
    ca_path = os.path.join(CERT_CACHE, f"node{node['id']}.ca.pem")
    crt_path = os.path.join(CERT_CACHE, f"node{node['id']}.client.crt.pem")
    key_path = os.path.join(CERT_CACHE, f"node{node['id']}.client.key.pem")

    def write_if_changed(path: str, content: str, mode: int):
        old = None
        if os.path.exists(path):
            with open(path, "r", encoding="utf-8") as f:
                old = f.read()
        if old != content:
            with open(path, "w", encoding="utf-8") as f:
                f.write(content)
            os.chmod(path, mode)

    write_if_changed(ca_path, node["ca_pem"], 0o644)
    write_if_changed(crt_path, node["client_cert_pem"], 0o644)
    write_if_changed(key_path, node["client_key_pem"], 0o600)
    return {"ca": ca_path, "crt": crt_path, "key": key_path}

async def agent_call(node: sqlite3.Row, method: str, path: str, json_body: Optional[dict]=None) -> dict:
    url = node["base_url"].rstrip("/") + path
    headers = {"X-Panel-Key": node["panel_key"]}
    files = _write_cert_files(node)

    # å…³é”®ï¼šä¸è®©å‰ç«¯â€œå¡ä½â€ï¼Œè¶…æ—¶è¦æ˜ç¡®æŠ›å‡º
    timeout = httpx.Timeout(8.0, read=60.0)
    async with httpx.AsyncClient(
        timeout=timeout,
        verify=files["ca"],
        cert=(files["crt"], files["key"])
    ) as client:
        r = await client.request(method, url, headers=headers, json=json_body)
        try:
            data = r.json()
        except Exception:
            data = {"detail": r.text}
        if r.status_code >= 400:
            raise HTTPException(status_code=r.status_code, detail=data.get("detail", data))
        return data

class LoginReq(BaseModel):
    username: str
    password: str

class AddNodeBundleReq(BaseModel):
    bundle_b64: str

class CreateContainerReq(BaseModel):
    node_id: int
    name: str
    image: str
    cpu: int = 1
    memory_mb: int = 512
    disk_gb: int = 8
    ingress_mbit: Optional[int] = None
    egress_mbit: Optional[int] = None

class ExecReq(BaseModel):
    node_id: int
    name: str
    cmd: List[str]

class NodeOpReq(BaseModel):
    node_id: int
    name: str

app = FastAPI(title=APP_NAME)

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # ç”Ÿäº§å»ºè®®æ”¹æˆä½ çš„åŸŸå
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.on_event("startup")
def _startup():
    init_db()

@app.get("/api/health")
def health():
    return {"ok": True, "app": APP_NAME, "ts": int(time.time())}

@app.post("/api/login")
def login(body: LoginReq):
    conn = db()
    cur = conn.cursor()
    cur.execute("SELECT * FROM users WHERE username=?", (body.username,))
    row = cur.fetchone()
    conn.close()
    if not row or not pwd_ctx.verify(body.password, row["password_hash"]):
        raise HTTPException(status_code=401, detail="Bad credentials")
    token = make_token({"id": row["id"], "username": row["username"], "role": row["role"]})
    return {"token": token, "role": row["role"], "username": row["username"]}

@app.get("/api/me")
def me(user=Depends(current_user)):
    return {"username": user["sub"], "role": user["role"], "uid": user["uid"]}

@app.get("/api/images")
def images(user=Depends(current_user)):
    return {"items": ALLOWED_IMAGES}

@app.post("/api/admin/nodes/bundle")
async def admin_add_node_bundle(body: AddNodeBundleReq, admin=Depends(require_admin)):
    try:
        raw = base64.b64decode(body.bundle_b64.strip()).decode("utf-8", "ignore")
        j = json.loads(raw)
        name = str(j["name"])
        base_url = str(j["base_url"]).rstrip("/")
        panel_key = str(j["panel_key"]).strip()
        ca_pem = str(j["ca_pem"])
        client_cert_pem = str(j["client_cert_pem"])
        client_key_pem = str(j["client_key_pem"])
    except Exception:
        raise HTTPException(status_code=400, detail="Invalid bundle")

    if not base_url.startswith("https://"):
        raise HTTPException(status_code=400, detail="base_url must be https://...")

    conn = db()
    cur = conn.cursor()
    cur.execute(
        "INSERT INTO nodes(name,base_url,panel_key,ca_pem,client_cert_pem,client_key_pem,created_at) VALUES(?,?,?,?,?,?,?)",
        (name, base_url, panel_key, ca_pem, client_cert_pem, client_key_pem, int(time.time()))
    )
    conn.commit()
    node_id = cur.lastrowid
    conn.close()

    # æ·»åŠ åç«‹åˆ»å¥åº·æ£€æŸ¥ï¼Œå¤±è´¥ç›´æ¥è¿”å›é”™è¯¯ï¼ˆä¸è®© UI å‡å¡ï¼‰
    node = get_node(node_id)
    await agent_call(node, "GET", "/agent/health")

    return {"ok": True, "node_id": node_id}

@app.get("/api/nodes")
def list_nodes(user=Depends(current_user)):
    conn = db()
    cur = conn.cursor()
    cur.execute("SELECT id,name,base_url,created_at FROM nodes ORDER BY id DESC")
    rows = [dict(r) for r in cur.fetchall()]
    conn.close()
    return {"items": rows}

@app.get("/api/containers")
async def containers(node_id: int, user=Depends(current_user)):
    node = get_node(node_id)
    data = await agent_call(node, "GET", "/agent/containers")
    items = data.get("items", [])
    if user.get("role") == "admin":
        return {"items": items}
    pref = user_prefix(user)
    return {"items": [x for x in items if (x.get("name","").startswith(pref))]}

@app.post("/api/containers")
async def create_container(body: CreateContainerReq, user=Depends(current_user)):
    ensure_short_name(body.name)
    if body.image not in ALLOWED_IMAGES and user.get("role") != "admin":
        raise HTTPException(status_code=400, detail=f"image not allowed. allowed={ALLOWED_IMAGES}")

    node = get_node(body.node_id)
    cname = full_name(user, body.name)

    payload = {
        "name": cname,
        "image": body.image,
        "cpu": body.cpu,
        "memory_mb": body.memory_mb,
        "disk_gb": body.disk_gb,
        "ingress_mbit": body.ingress_mbit,
        "egress_mbit": body.egress_mbit,
        "autostart": True
    }
    data = await agent_call(node, "POST", "/agent/containers", json_body=payload)
    return {"ok": True, "name": data.get("name", cname)}

def owned_name(user: Dict[str, Any], short: str) -> str:
    ensure_short_name(short)
    return full_name(user, short)

@app.post("/api/containers/start")
async def start(body: NodeOpReq, user=Depends(current_user)):
    node = get_node(body.node_id)
    await agent_call(node, "POST", f"/agent/containers/{owned_name(user, body.name)}/start")
    return {"ok": True}

@app.post("/api/containers/stop")
async def stop(body: NodeOpReq, user=Depends(current_user)):
    node = get_node(body.node_id)
    await agent_call(node, "POST", f"/agent/containers/{owned_name(user, body.name)}/stop")
    return {"ok": True}

@app.post("/api/containers/restart")
async def restart(body: NodeOpReq, user=Depends(current_user)):
    node = get_node(body.node_id)
    await agent_call(node, "POST", f"/agent/containers/{owned_name(user, body.name)}/restart")
    return {"ok": True}

@app.post("/api/containers/delete")
async def delete(body: NodeOpReq, user=Depends(current_user)):
    node = get_node(body.node_id)
    await agent_call(node, "DELETE", f"/agent/containers/{owned_name(user, body.name)}")
    return {"ok": True}

@app.post("/api/containers/exec")
async def exec_cmd(body: ExecReq, user=Depends(current_user)):
    node = get_node(body.node_id)
    data = await agent_call(node, "POST", f"/agent/containers/{owned_name(user, body.name)}/exec", json_body={"cmd": body.cmd})
    return {"ok": True, "output": data.get("output","")}
PY

# =========================
# Write frontend index.html
# =========================
say "å†™å…¥å‰ç«¯ index.html..."
cat > "${APP_DIR}/index.html" <<'HTML'
<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LXD Panel (Secure)</title>
<style>
  body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;margin:0;background:#0b0f17;color:#e6edf3}
  .wrap{max-width:1200px;margin:0 auto;padding:24px}
  .card{background:#111827;border:1px solid #1f2937;border-radius:14px;padding:16px;margin:14px 0;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  input,select,button,textarea{background:#0b1220;border:1px solid #233047;color:#e6edf3;padding:10px 12px;border-radius:10px}
  textarea{min-height:110px;width:100%}
  button{cursor:pointer}
  button.primary{background:#1d4ed8;border-color:#1d4ed8}
  button.danger{background:#b91c1c;border-color:#b91c1c}
  button.ghost{background:transparent}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .grow{flex:1}
  .muted{color:#9ca3af}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-bottom:1px solid #22304a;padding:10px 8px;text-align:left}
  .badge{padding:3px 9px;border-radius:999px;border:1px solid #2b3a55;font-size:12px}
  .ok{border-color:#14532d;color:#86efac}
  .warn{border-color:#7c2d12;color:#fdba74}
  pre{white-space:pre-wrap;background:#0b1220;border:1px solid #233047;padding:12px;border-radius:10px}
</style>
</head>
<body>
<div class="wrap">
  <div class="row" style="justify-content:space-between">
    <div>
      <div style="font-weight:800">ğŸ›¡ï¸ LXD Panel <span class="muted" style="font-size:12px">mTLS + Key</span></div>
      <div class="muted" id="who">æœªç™»å½•</div>
      <div class="muted" id="apiStatus" style="font-size:12px"></div>
    </div>
    <div class="row"><button class="ghost" onclick="logout()">é€€å‡º</button></div>
  </div>

  <div class="card" id="loginCard">
    <h3>ç™»å½•</h3>
    <div class="row">
      <input id="u" value="admin" placeholder="ç”¨æˆ·å"/>
      <input id="p" value="ChangeMeNow!" type="password" placeholder="å¯†ç "/>
      <button class="primary" onclick="login()">ç™»å½•</button>
    </div>
    <div class="muted" id="loginMsg"></div>
  </div>

  <div class="card" id="nodeCard" style="display:none">
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:0">èŠ‚ç‚¹ï¼ˆAgentï¼‰</h3>
      <button onclick="loadNodes()">åˆ·æ–°</button>
    </div>

    <div class="row">
      <select id="nodeSel" onchange="refreshContainers()"></select>
      <span class="muted">æ‰€æœ‰æŒ‡ä»¤é€šè¿‡ Panel è½¬å‘åˆ° Agentï¼ˆhttps + mTLS + keyï¼‰ã€‚</span>
    </div>

    <div id="adminBox" style="display:none; margin-top:12px">
      <h4>æ·»åŠ èŠ‚ç‚¹ï¼ˆç®¡ç†å‘˜ï¼‰</h4>
      <div class="muted">æŠŠå®¿ä¸»æœºè„šæœ¬è¾“å‡ºçš„ Node Bundleï¼ˆbase64ï¼‰ç²˜è´´è¿›æ¥ï¼š</div>
      <textarea id="bundle" placeholder="ç²˜è´´ base64..."></textarea>
      <div class="row">
        <button class="primary" onclick="addNodeBundle()">æ·»åŠ å¹¶å¥åº·æ£€æŸ¥</button>
        <span class="muted" id="nodeMsg"></span>
      </div>
    </div>
  </div>

  <div class="card" id="createCard" style="display:none">
    <h3>åˆ›å»ºå®¹å™¨</h3>
    <div class="row">
      <input id="cname" placeholder="çŸ­åï¼šweb-01"/>
      <select id="image"></select>
      <input id="cpu" type="number" min="1" max="64" value="1" placeholder="CPU"/>
      <input id="mem" type="number" min="128" value="512" placeholder="å†…å­˜(MB)"/>
      <input id="disk" type="number" min="4" value="8" placeholder="ç£ç›˜(GB)"/>
      <input id="ing" type="number" min="1" placeholder="å…¥ç«™é™é€Ÿ(Mbitï¼Œå¯ç©º)"/>
      <input id="eg" type="number" min="1" placeholder="å‡ºç«™é™é€Ÿ(Mbitï¼Œå¯ç©º)"/>
      <button class="primary" onclick="createContainer()">åˆ›å»º</button>
    </div>
    <div class="muted" id="createMsg"></div>
  </div>

  <div class="card" id="listCard" style="display:none">
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:0">å®¹å™¨åˆ—è¡¨</h3>
      <button onclick="refreshContainers()">åˆ·æ–°</button>
    </div>
    <table>
      <thead><tr><th>çŸ­å</th><th>çŠ¶æ€</th><th>IPv4</th><th>æ“ä½œ</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>

    <h4>æ‰§è¡Œå‘½ä»¤ï¼ˆéäº¤äº’ï¼‰</h4>
    <div class="row">
      <input id="execName" placeholder="çŸ­åï¼šweb-01"/>
      <input id="execCmd" class="grow" placeholder="å‘½ä»¤ï¼šuname -a"/>
      <button onclick="execCmdGo()">æ‰§è¡Œ</button>
    </div>
    <pre id="execOut" class="muted">è¾“å‡ºæ˜¾ç¤ºåœ¨è¿™é‡Œ</pre>
  </div>
</div>

<script>
const BASE = "__BASE_PATH__";               // one-key è„šæœ¬ä¼šæ›¿æ¢
const API  = (BASE === "/" ? "" : BASE) + "/api";

let token = localStorage.getItem("token") || "";
let me = null;

function h(){ return token ? {"Authorization":"Bearer "+token} : {}; }
function msg(id,t){ document.getElementById(id).innerText=t||""; }

async function fetchWithTimeout(url, options={}, ms=12000){
  const controller = new AbortController();
  const id = setTimeout(()=>controller.abort(), ms);
  try{
    const r = await fetch(url, {...options, signal: controller.signal});
    clearTimeout(id);
    return r;
  }catch(e){
    clearTimeout(id);
    throw e;
  }
}

async function probeAPI(){
  try{
    const r = await fetchWithTimeout(API + "/health", {}, 4000);
    if(!r.ok) throw new Error("bad status");
    const j = await r.json();
    msg("apiStatus", `APIï¼šåœ¨çº¿ âœ…  (${j.app})`);
  }catch(e){
    msg("apiStatus", `APIï¼šä¸å¯ç”¨ âŒ  (æ£€æŸ¥ Nginx åä»£/åç«¯æœåŠ¡/è·¯å¾„å‰ç¼€)`);
  }
}

async function login(){
  msg("loginMsg","ç™»å½•ä¸­...");
  try{
    const r = await fetchWithTimeout(API + "/login", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({username:u.value.trim(), password:p.value})
    }, 12000);

    let j = {};
    try { j = await r.json(); } catch(_) {}

    if(!r.ok){
      msg("loginMsg", j.detail || `ç™»å½•å¤±è´¥ï¼šHTTP ${r.status}ï¼ˆæ£€æŸ¥åç«¯/åä»£/è·¯å¾„ï¼‰`);
      return;
    }
    token = j.token;
    localStorage.setItem("token", token);
    await boot();
  }catch(e){
    msg("loginMsg", "ç™»å½•è¶…æ—¶/ç½‘ç»œé”™è¯¯ï¼šè¯·æ£€æŸ¥ API åä»£ã€åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œã€è®¿é—®è·¯å¾„æ˜¯å¦ä¸€è‡´");
  }
}

function logout(){ token=""; localStorage.removeItem("token"); location.reload(); }

async function boot(){
  const r = await fetchWithTimeout(API + "/me", {headers:h()}, 8000);
  if(!r.ok){ logout(); return; }
  me = await r.json();

  who.innerText = `å·²ç™»å½•ï¼š${me.username}ï¼ˆ${me.role}ï¼‰ uid=${me.uid}`;
  loginCard.style.display = "none";
  nodeCard.style.display  = "";
  createCard.style.display= "";
  listCard.style.display  = "";
  adminBox.style.display  = (me.role==="admin") ? "" : "none";

  const ir = await fetchWithTimeout(API + "/images", {headers:h()}, 8000);
  const ij = await ir.json();
  image.innerHTML="";
  (ij.items||[]).forEach(x=>{ const o=document.createElement("option"); o.value=x; o.textContent=x; image.appendChild(o); });

  await loadNodes();
}

async function addNodeBundle(){
  msg("nodeMsg","æ·»åŠ ä¸­...");
  try{
    const r = await fetchWithTimeout(API + "/admin/nodes/bundle", {
      method:"POST",
      headers:{"Content-Type":"application/json", ...h()},
      body: JSON.stringify({bundle_b64: bundle.value.trim()})
    }, 20000);

    const j = await r.json().catch(()=>({}));
    if(!r.ok){ msg("nodeMsg", j.detail || "æ·»åŠ å¤±è´¥"); return; }
    msg("nodeMsg", `æ·»åŠ æˆåŠŸ âœ… node_id=${j.node_id}`);
    bundle.value="";
    await loadNodes();
  }catch(e){
    msg("nodeMsg","è¯·æ±‚è¶…æ—¶/ç½‘ç»œé”™è¯¯ï¼šæ£€æŸ¥ Panel->Agent å…¬ç½‘è¿é€šã€è¯ä¹¦ã€Agent ç™½åå•");
  }
}

async function loadNodes(){
  const r = await fetchWithTimeout(API + "/nodes", {headers:h()}, 8000);
  const j = await r.json();
  nodeSel.innerHTML="";
  (j.items||[]).forEach(n=>{
    const o=document.createElement("option");
    o.value=n.id; o.textContent=`#${n.id} ${n.name} (${n.base_url})`;
    nodeSel.appendChild(o);
  });
  if((j.items||[]).length===0){ tbody.innerHTML=""; return; }
  await refreshContainers();
}

function nodeId(){ return parseInt(nodeSel.value||"0",10); }
function badge(s){
  s=(s||"").toLowerCase();
  if(s==="running") return `<span class="badge ok">running</span>`;
  if(s==="stopped") return `<span class="badge warn">stopped</span>`;
  return `<span class="badge">${s}</span>`;
}

async function refreshContainers(){
  const nid=nodeId(); if(!nid) return;
  const r = await fetchWithTimeout(API + `/containers?node_id=${nid}`, {headers:h()}, 15000);
  const j = await r.json();
  tbody.innerHTML="";
  (j.items||[]).forEach(it=>{
    const full=it.name||"";
    const short=full.replace(/^u_\d+_/,"");
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${short}<div class="muted" style="font-size:12px">${full}</div></td>
      <td>${badge(it.status)}</td>
      <td>${it.ipv4||"-"}</td>
      <td class="row">
        <button onclick="op('${short}','start')">start</button>
        <button onclick="op('${short}','stop')">stop</button>
        <button onclick="op('${short}','restart')">restart</button>
        <button class="danger" onclick="op('${short}','delete')">delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

async function op(name, action){
  const nid=nodeId(); if(!nid) return;
  if(action==="delete" && !confirm("ç¡®å®šåˆ é™¤ï¼Ÿè¿™ä¼šå¼ºåˆ¶åˆ é™¤å®¹å™¨ã€‚")) return;

  const r = await fetchWithTimeout(API + `/containers/${action}`, {
    method:"POST",
    headers:{"Content-Type":"application/json",...h()},
    body: JSON.stringify({node_id:nid, name})
  }, 15000);

  const j = await r.json().catch(()=>({}));
  if(!r.ok){ alert(j.detail||"æ“ä½œå¤±è´¥"); return; }
  await refreshContainers();
}

async function createContainer(){
  const nid=nodeId();
  if(!nid){ msg("createMsg","è¯·å…ˆé€‰æ‹©èŠ‚ç‚¹"); return; }
  msg("createMsg","åˆ›å»ºä¸­ï¼ˆé¦–æ¬¡æ‹‰é•œåƒå¯èƒ½è¾ƒæ…¢ï¼‰...");

  const body={node_id:nid,name:cname.value.trim(),image:image.value,
    cpu:parseInt(cpu.value||"1",10),memory_mb:parseInt(mem.value||"512",10),disk_gb:parseInt(disk.value||"8",10)};
  if(ing.value.trim()) body.ingress_mbit=parseInt(ing.value.trim(),10);
  if(eg.value.trim()) body.egress_mbit=parseInt(eg.value.trim(),10);

  const r = await fetchWithTimeout(API + "/containers", {
    method:"POST",
    headers:{"Content-Type":"application/json",...h()},
    body: JSON.stringify(body)
  }, 30000);

  const j = await r.json().catch(()=>({}));
  if(!r.ok){ msg("createMsg", j.detail||"åˆ›å»ºå¤±è´¥"); return; }
  msg("createMsg","åˆ›å»ºæˆåŠŸ âœ…");
  await refreshContainers();
}

async function execCmdGo(){
  const nid=nodeId();
  const name=execName.value.trim();
  const cmdLine=execCmd.value.trim();
  if(!nid||!name||!cmdLine){ alert("èŠ‚ç‚¹ã€çŸ­åã€å‘½ä»¤éƒ½è¦å¡«"); return; }
  execOut.innerText="æ‰§è¡Œä¸­...";

  const r = await fetchWithTimeout(API + "/containers/exec", {
    method:"POST",
    headers:{"Content-Type":"application/json",...h()},
    body: JSON.stringify({node_id:nid,name,cmd:cmdLine.split(" ").filter(Boolean)})
  }, 20000);

  const j = await r.json().catch(()=>({}));
  if(!r.ok){ execOut.innerText=j.detail||"æ‰§è¡Œå¤±è´¥"; return; }
  execOut.innerText=j.output||"";
}

probeAPI();
if(token) boot();
</script>
</body>
</html>
HTML

# Inject BASE_PATH into frontend
say "æ³¨å…¥è®¿é—®è·¯å¾„ BASE_PATH åˆ°å‰ç«¯..."
sed -i "s|__BASE_PATH__|${BASE_PATH}|g" "${APP_DIR}/index.html"

say "åˆ›å»º venv å¹¶å®‰è£…ä¾èµ–..."
python3 -m venv "${PY_VENV}"
"${PY_VENV}/bin/pip" install --upgrade pip >/dev/null
"${PY_VENV}/bin/pip" install \
  fastapi==0.115.0 \
  uvicorn[standard]==0.30.6 \
  python-jose==3.3.0 \
  passlib[bcrypt]==1.7.4 \
  pydantic==2.8.2 \
  httpx==0.27.2 >/dev/null

say "å†™å…¥ systemd æœåŠ¡..."
JWT_SECRET="$(openssl rand -hex 32)"

cat > /etc/systemd/system/lxd-panel.service <<EOF
[Unit]
Description=LXD Panel Backend
After=network.target

[Service]
Type=simple
WorkingDirectory=${APP_DIR}
Environment="LXD_PANEL_DB=${DATA_DIR}/panel.db"
Environment="LXD_PANEL_CERT_CACHE=${CERT_CACHE}"
Environment="LXD_PANEL_JWT_SECRET=${JWT_SECRET}"
Environment="LXD_PANEL_ADMIN_USER=${ADMIN_USER}"
Environment="LXD_PANEL_ADMIN_PASS=${ADMIN_PASS}"
ExecStart=${PY_VENV}/bin/uvicorn app:app --host 127.0.0.1 --port ${BACKEND_PORT}
Restart=always
RestartSec=2
StandardOutput=append:${LOG_DIR}/panel.log
StandardError=append:${LOG_DIR}/panel.err

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable --now lxd-panel.service

say "é…ç½® Nginxï¼ˆæ”¯æŒè·¯å¾„å‰ç¼€ ${BASE_PATH}ï¼‰..."
NGINX_SITE="/etc/nginx/sites-available/lxd-panel"

if [[ "${BASE_PATH}" == "/" ]]; then
  cat > "${NGINX_SITE}" <<EOF
server {
  listen ${PANEL_PORT} default_server;
  listen [::]:${PANEL_PORT} default_server;
  server_name ${DOMAIN};

  root ${APP_DIR};
  index index.html;

  location / {
    try_files \$uri \$uri/ /index.html;
  }

  location /api/ {
    proxy_pass http://127.0.0.1:${BACKEND_PORT}/api/;
    proxy_http_version 1.1;
    proxy_set_header Host \$host;
    proxy_set_header X-Real-IP \$remote_addr;
    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
  }
}
EOF
else
  cat > "${NGINX_SITE}" <<EOF
server {
  listen ${PANEL_PORT} default_server;
  listen [::]:${PANEL_PORT} default_server;
  server_name ${DOMAIN};

  location ${BASE_PATH}/ {
    alias ${APP_DIR}/;
    try_files \$uri \$uri/ ${BASE_PATH}/index.html;
  }

  location ${BASE_PATH}/api/ {
    proxy_pass http://127.0.0.1:${BACKEND_PORT}/api/;
    proxy_http_version 1.1;
    proxy_set_header Host \$host;
    proxy_set_header X-Real-IP \$remote_addr;
    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
  }
}
EOF
fi

rm -f /etc/nginx/sites-enabled/default || true
ln -sf /etc/nginx/sites-available/lxd-panel /etc/nginx/sites-enabled/lxd-panel
nginx -t
systemctl enable --now nginx
systemctl restart nginx

if [[ "${TLS_MODE}" == "letsencrypt" ]]; then
  say "ç”³è¯· Letâ€™s Encrypt è¯ä¹¦ï¼ˆè¦æ±‚åŸŸåå·²è§£æåˆ°æœ¬æœºï¼Œä¸”å…¬ç½‘å¯è®¿é—®ï¼‰..."
  certbot --nginx -d "${DOMAIN}" --non-interactive --agree-tos -m "${EMAIL}" || {
    err "è¯ä¹¦ç”³è¯·å¤±è´¥ï¼šæ£€æŸ¥åŸŸåè§£æ/ç«¯å£/é˜²ç«å¢™ã€‚å¯å…ˆé€‰ n ç”¨ http è·‘èµ·æ¥ã€‚"
    exit 1
  }
fi

say "å¥åº·æ£€æŸ¥ï¼ˆåç«¯æœ¬åœ°ï¼‰..."
set +e
curl -fsS "http://127.0.0.1:${BACKEND_PORT}/api/health" >/dev/null
HC=$?
set -e
if [[ $HC -ne 0 ]]; then
  warn "åç«¯å¥åº·æ£€æŸ¥å¤±è´¥ï¼šjournalctl -u lxd-panel -n 200 --no-pager"
else
  say "åç«¯å¥åº·æ£€æŸ¥ OK"
fi

echo "------------------------------------------------------------"
echo "âœ… Panel éƒ¨ç½²å®Œæˆ"
if [[ "${TLS_MODE}" == "letsencrypt" ]]; then
  echo "è®¿é—®ï¼š https://${DOMAIN}${BASE_PATH}/"
else
  echo "è®¿é—®ï¼š http://<é¢æ¿æœåŠ¡å™¨IP>:${PANEL_PORT}${BASE_PATH}/"
fi
echo "Adminï¼š${ADMIN_USER}"
echo "Passwordï¼š${ADMIN_PASS}"
echo ""
echo "æ’éšœå‘½ä»¤ï¼š"
echo "  - åç«¯æ—¥å¿—ï¼šjournalctl -u lxd-panel -n 200 --no-pager"
echo "  - Nginx é…ç½®ï¼šnginx -T | sed -n '1,200p'"
echo "------------------------------------------------------------"
