#!/usr/bin/env bash
# LXD 实例管理脚本 - 终极全能版
# 功能：创建/查看/批量开关/BBR加速/动态改配
# 2025.11.10 Final Updated

# --- 颜色配置 ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
SKYBLUE='\033[0;36m'
PLAIN='\033[0m'
DIVIDER="${SKYBLUE}------------------------------------------------------${PLAIN}"

# --- 1. 环境自检 ---

check_root() {
    [ "$(id -u)" != "0" ] && { echo -e "${RED}错误: 必须使用 Root 运行${PLAIN}"; exit 1; }
}

check_lxd_env() {
    if ! command -v lxc >/dev/null 2>&1; then
        echo -e "${YELLOW}正在安装 LXD...${PLAIN}"
        if command -v apt-get >/dev/null 2>&1; then apt-get update && apt-get install lxd -y
        elif command -v yum >/dev/null 2>&1; then yum install lxd -y
        elif command -v apk >/dev/null 2>&1; then apk add lxd
        fi
    fi
    if ! lxc storage list >/dev/null 2>&1 || [ -z "$(lxc storage list --format csv)" ]; then
        echo -e "${YELLOW}LXD 未初始化，执行自动初始化...${PLAIN}"
        lxd init --auto
    fi
}

init_env() {
    check_root
    # 清理垃圾文件
    rm -rf lxd.tar.xz rootfs.squashfs *.zip *.zip.* ChangeMirrors.sh ssh_*.sh config.sh
    if ! command -v jq >/dev/null 2>&1; then
        command -v apt-get >/dev/null 2>&1 && apt-get install jq -y
        command -v yum >/dev/null 2>&1 && yum install jq -y
        command -v apk >/dev/null 2>&1 && apk add jq
    fi
}

# --- 2. 基础函数 ---

detect_ip_info() {
    country_code=$(curl -m 5 -s https://ipapi.co/json | jq -r '.country_code' 2>/dev/null)
    [[ -z "$country_code" ]] && country_code=$(curl -m 5 -s https://api.ip.sb/geoip | jq -r '.country_code' 2>/dev/null)
    [[ "$country_code" == "CN" ]] && CN=true || CN=false
}

check_cdn_file() {
    cdn_urls=("https://cdn0.spiritlhl.top/" "http://cdn1.spiritlhl.net/" "http://cdn2.spiritlhl.net/" "http://cdn3.spiritlhl.net/" "http://cdn4.spiritlhl.net/")
    local shuffled=($(shuf -e "${cdn_urls[@]}")) 
    for url in "${shuffled[@]}"; do
        if curl -4 -sL -k "${url}https://raw.githubusercontent.com/spiritLHLS/ecs/main/back/test" --max-time 6 | grep -q "success"; then
            export cdn_success_url="$url"
            return
        fi
    done
}

get_system_arch() {
    sysarch="$(uname -m)"
    case "${sysarch}" in
        "x86_64"|"amd64") sys_bit="x86_64" ;;
        "aarch64"|"armv8") sys_bit="aarch64" ;;
        *) sys_bit="x86_64" ;;
    esac
}

# --- 3. 核心创建逻辑 ---
# (为节省篇幅，保留原有的创建相关函数，逻辑未变)

process_image() {
    image_download_url=""; fixed_system=false
    if [[ "$sys_bit" == "x86_64" || "$sys_bit" == "arm64" ]]; then
        self_fixed_images=($(curl -slk -m 6 ${cdn_success_url}https://raw.githubusercontent.com/oneclickvirt/lxd_images/main/${sys_bit}_all_images.txt))
        for image_name in "${self_fixed_images[@]}"; do
             if [[ -n "$b" ]]; then if [[ "$image_name" == "${a}_${b}"* ]]; then use_fixed_image "$image_name"; break; fi
             else if [[ "$image_name" == "${a}"* ]]; then use_fixed_image "$image_name"; break; fi; fi
        done
    fi
    if [ -z "$image_download_url" ]; then
        local type_flag="container"; [ "$is_vm" == true ] && type_flag="virtual-machine"
        system=$(lxc image list images:${a}/${b} --format=json | jq -r --arg ARCHITECTURE "$sys_bit" --arg TYPE "$type_flag" '.[] | select(.type == $TYPE and .architecture == $ARCHITECTURE) | .aliases[0].name' | head -n 1)
        if [ -n "$system" ]; then echo -e "${GREEN}使用官方镜像: ${system}${PLAIN}"; fixed_system=false; fi
    fi
    if [ -z "$image_download_url" ] && [ -z "$system" ]; then echo -e "${RED}错误：未找到镜像${PLAIN}"; exit 1; fi
}

use_fixed_image() {
    local image_name=$1; fixed_system=true
    image_download_url="https://github.com/oneclickvirt/lxd_images/releases/download/${a}/${image_name}"
    if [[ $(lxc image alias list) != *"$image_name"* ]]; then
        echo -e "${SKYBLUE}下载镜像...${PLAIN}"
        wget -O "lxd_image.zip" "${cdn_success_url}${image_download_url}" || { echo -e "${RED}下载失败${PLAIN}"; exit 1; }
        unzip -o "lxd_image.zip"; rm -f "lxd_image.zip"
        lxc image import lxd.tar.xz rootfs.squashfs --alias "$image_name"; rm -rf lxd.tar.xz rootfs.squashfs
    fi
}

create_container() {
    echo -e "${SKYBLUE}创建实例: $name ...${PLAIN}"
    if lxc info "$name" >/dev/null 2>&1; then lxc delete "$name" --force; fi
    local args="-c limits.cpu=$cpu -c limits.memory=${memory}MiB -s default"
    [ "$is_vm" == true ] && args="--vm $args"
    if [ -n "$image_download_url" ]; then lxc init "$image_name" "$name" $args; else lxc init images:${system} "$name" $args; fi
    if [ $? -ne 0 ]; then echo -e "${RED}创建失败!${PLAIN}"; exit 1; fi
}

configure_storage() {
    local st="btrfs"; [ -f /usr/local/bin/lxd_storage_type ] && st=$(cat /usr/local/bin/lxd_storage_type)
    [[ $disk == *.* ]] && d_mb=$(echo "$disk * 1024" | bc | cut -d. -f1)MB || d_mb="${disk}GB"
    lxc storage create "$name" "$st" size="$d_mb" >/dev/null 2>&1
    lxc config device override "$name" root size="$d_mb"
    lxc config device set "$name" root limits.max "$d_mb"
}

configure_resources() {
    lxc config device set "$name" root limits.read 500MB
    lxc config device set "$name" root limits.write 500MB
    lxc config device set "$name" root limits.read 5000iops
    lxc config device set "$name" root limits.write 5000iops
    lxc config set "$name" limits.cpu.priority 0
    lxc config set "$name" limits.cpu.allowance 50%
    lxc config set "$name" security.nesting true
    if [ "$is_vm" == true ]; then lxc config set "$name" security.secureboot=false; else lxc config set "$name" limits.memory.swap true; fi
}

setup_system() {
    echo -e "${SKYBLUE}系统初始化...${PLAIN}"; ori=$(date | md5sum); passwd=${ori:2:9}
    lxc start "$name"; sleep 3
    if [ "$is_vm" == true ]; then return; fi
    if [ "$fixed_system" = false ]; then setup_mirrors; install_packages; fi
    setup_ssh; configure_ipv6
}

setup_mirrors() {
    [[ "$mirror_choice" == "off" || "$system" == *"win"* ]] && return
    local use_cn=false; [[ "$mirror_choice" == "cn" || ("$mirror_choice" == "auto" && "$CN" == true) ]] && use_cn=true
    if [ "$use_cn" == true ]; then
        lxc exec "$name" -- curl -lk https://gitee.com/SuperManito/LinuxMirrors/raw/main/ChangeMirrors.sh -o ChangeMirrors.sh
        lxc exec "$name" -- chmod 777 ChangeMirrors.sh
        lxc exec "$name" -- ./ChangeMirrors.sh --source mirrors.tuna.tsinghua.edu.cn --web-protocol http --intranet false --backup true --updata-software false --clean-cache false --ignore-backup-tips
        lxc exec "$name" -- rm -rf ChangeMirrors.sh
    fi
}

install_packages() {
    if echo "$system" | grep -qiE "fedora|rocky|almalinux|oracle|centos"; then lxc exec "$name" -- dnf install -y curl dos2unix >/dev/null 2>&1 || lxc exec "$name" -- yum install -y curl dos2unix >/dev/null 2>&1
    elif echo "$system" | grep -qiE "archlinux"; then lxc exec "$name" -- pacman -Sy --noconfirm curl dos2unix >/dev/null 2>&1
    elif echo "$system" | grep -qiE "opensuse"; then lxc exec "$name" -- zypper install -y curl dos2unix >/dev/null 2>&1
    elif echo "$system" | grep -qiE "alpine"; then lxc exec "$name" -- apk add --no-cache curl >/dev/null 2>&1
    else lxc exec "$name" -- apt-get update -y >/dev/null 2>&1; lxc exec "$name" -- apt-get install curl dos2unix -y >/dev/null 2>&1; fi
}

setup_ssh() {
    local st="bash"; echo "$system" | grep -qiE "alpine|openwrt" && st="sh"
    local sn="ssh_${st}.sh"
    [ ! -f "/usr/local/bin/$sn" ] && curl -L "${cdn_success_url}https://raw.githubusercontent.com/oneclickvirt/lxd/main/scripts/$sn" -o "/usr/local/bin/$sn" && chmod 777 "/usr/local/bin/$sn" && dos2unix "/usr/local/bin/$sn"
    lxc file push "/usr/local/bin/$sn" "$name"/root/; lxc exec "$name" -- chmod 777 "$sn"
    if [ "$st" == "sh" ]; then lxc exec "$name" -- ./"$sn" ${passwd}
    else lxc exec "$name" -- dos2unix "$sn"; lxc exec "$name" -- sudo ./"$sn" $passwd; [ ! -f /usr/local/bin/config.sh ] && curl -L ${cdn_success_url}https://raw.githubusercontent.com/oneclickvirt/lxd/main/scripts/config.sh -o /usr/local/bin/config.sh && chmod +x /usr/local/bin/config.sh && dos2unix /usr/local/bin/config.sh; lxc file push /usr/local/bin/config.sh "$name"/root/; lxc exec "$name" -- bash config.sh; fi
}

configure_port() {
    echo -e "${SKYBLUE}网络配置...${PLAIN}"; [ "$is_vm" == true ] && mr=20 || mr=5
    for ((i=1; i<=mr; i++)); do sleep 5; container_ip=$(lxc list "$name" --format json | jq -r '.[0].state.network.eth0.addresses[]? | select(.family=="inet") | .address'); [ -n "$container_ip" ] && break; done
    if [ -z "$container_ip" ]; then echo -e "${RED}获取IP失败${PLAIN}"; return; fi
    ipv4_address=$(ip addr show | awk '/inet .*global/ && !/inet6/ {print $2}' | sed -n '1p' | cut -d/ -f1)
    lxc config device override "$name" eth0 ipv4.address="$container_ip" 2>/dev/null || lxc config device set "$name" eth0 ipv4.address "$container_ip" 2>/dev/null
    lxc config device add "$name" ssh-port proxy listen=tcp:$ipv4_address:$sshn connect=tcp:$container_ip:22 nat=true
    if [ "$nat1" != "0" ] && [ "$nat2" != "0" ]; then lxc config device add "$name" nattcp-ports proxy listen=tcp:$ipv4_address:$nat1-$nat2 connect=tcp:0.0.0.0:$nat1-$nat2 nat=true; lxc config device add "$name" natudp-ports proxy listen=udp:$ipv4_address:$nat1-$nat2 connect=udp:0.0.0.0:$nat1-$nat2 nat=true; fi
}

configure_ipv6() {
    if [ "$enable_ipv6" == "y" ] && [ "$is_vm" == false ]; then [ ! -f "./build_ipv6_network.sh" ] && curl -L ${cdn_success_url}https://raw.githubusercontent.com/oneclickvirt/lxd/main/scripts/build_ipv6_network.sh -o build_ipv6_network.sh && chmod +x build_ipv6_network.sh; ./build_ipv6_network.sh "$name"; fi
}

configure_network_speed() {
    [ "$is_vm" == true ] && return
    lxc stop "$name" --timeout=30; sl=$(($in > $out ? $in : $out))
    lxc config device set "$name" eth0 limits.egress "$out"Mbit; lxc config device set "$name" eth0 limits.ingress "$in"Mbit; lxc config device set "$name" eth0 limits.max "$sl"Mbit
    lxc start "$name"
}

cleanup_and_output() {
    rm -f lxd_image.zip lxd.tar.xz rootfs.squashfs
    clear
    echo "=================================================="
    echo -e "      ${GREEN}创建成功 (Success)${PLAIN}"
    echo "=================================================="
    echo -e " 名称: ${SKYBLUE}$name${PLAIN} | 系统: ${SKYBLUE}$system${PLAIN}"
    echo -e " SSH端口: ${GREEN}$sshn${PLAIN}"
    [ "$is_vm" == false ] && echo -e " 密码: ${GREEN}$passwd${PLAIN}" || echo -e " 密码: ${YELLOW}请VNC设置${PLAIN}"
    [ "$nat1" != "0" ] && echo -e " NAT: ${SKYBLUE}$nat1 - $nat2${PLAIN}"
    lxc config set "$name" user.description "$name $sshn $passwd $nat1 $nat2"
    echo "$name $sshn $passwd $nat1 $nat2" >>"$name"
    echo -e "${YELLOW}>>> 防火墙放行命令(宿主机执行):${PLAIN}"
    if command -v ufw >/dev/null 2>&1; then echo -e "ufw allow $sshn/tcp"; [ "$nat1" != "0" ] && echo -e "ufw allow $nat1:$nat2/tcp && ufw allow $nat1:$nat2/udp"; else echo -e "iptables -I INPUT -p tcp --dport $sshn -j ACCEPT"; [ "$nat1" != "0" ] && echo -e "iptables -I INPUT -p tcp --dport $nat1:$nat2 -j ACCEPT"; fi
}

# --- 4. 新增功能模块 ---

# 一键开启/关闭
manage_all_containers() {
    local action=$1
    local names=$(lxc list --format csv -c n)
    if [ -z "$names" ]; then echo -e "${YELLOW}当前无实例。${PLAIN}"; return; fi
    
    echo -e "${SKYBLUE}正在$([ "$action" == "start" ] && echo "启动" || echo "停止")所有容器...${PLAIN}"
    for container in $names; do
        if [ "$action" == "start" ]; then
            lxc start "$container" >/dev/null 2>&1
            echo -e "启动 ${GREEN}$container${PLAIN} ... 完成"
        else
            lxc stop "$container" --timeout=10 >/dev/null 2>&1
            echo -e "停止 ${YELLOW}$container${PLAIN} ... 完成"
        fi
    done
    read -p "操作完成，按回车返回..." d
}

# 开启 BBR
enable_bbr() {
    clear
    echo -e "${SKYBLUE}正在开启 BBR 加速 (宿主机)...${PLAIN}"
    if grep -q "net.core.default_qdisc=fq" /etc/sysctl.conf; then
        echo -e "${YELLOW}配置已存在，跳过添加。${PLAIN}"
    else
        echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf
        echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf
        echo -e "${GREEN}配置已添加。${PLAIN}"
    fi
    sysctl -p >/dev/null 2>&1
    echo -e "${GREEN}BBR 开启成功！${PLAIN}"
    echo -e "当前状态: $(sysctl net.ipv4.tcp_congestion_control)"
    read -p "按回车返回..." d
}

# 动态改配 (核心新功能)
reconfigure_container() {
    while true; do
        clear
        echo -e "${GREEN}=== 容器配置修改 (Reconfigure) ===${PLAIN}"
        
        # 1. 获取并列表
        local names=($(lxc list --format csv -c n))
        if [ ${#names[@]} -eq 0 ]; then echo -e "${YELLOW}无实例。${PLAIN}"; read -p "回车返回..." d; return; fi
        
        echo "请选择要修改的容器:"
        for i in "${!names[@]}"; do
            printf "%2d) %s\n" $((i+1)) "${names[$i]}"
        done
        echo " 0) 返回主菜单"
        
        read -p "输入编号: " idx
        if [ "$idx" == "0" ]; then return; fi
        target_name="${names[$((idx-1))]}"
        if [ -z "$target_name" ]; then echo -e "${RED}无效编号${PLAIN}"; sleep 1; continue; fi
        
        # 2. 读取当前配置
        cur_cpu=$(lxc config get "$target_name" limits.cpu 2>/dev/null)
        cur_mem=$(lxc config get "$target_name" limits.memory 2>/dev/null)
        cur_disk=$(lxc config device get "$target_name" root size 2>/dev/null)
        cur_net=$(lxc config device get "$target_name" eth0 limits.max 2>/dev/null)
        [ -z "$cur_cpu" ] && cur_cpu="默认"
        [ -z "$cur_mem" ] && cur_mem="默认"
        [ -z "$cur_disk" ] && cur_disk="默认"
        [ -z "$cur_net" ] && cur_net="无限制"

        clear
        echo -e "当前容器: ${SKYBLUE}$target_name${PLAIN}"
        echo "--------------------------------"
        echo -e "1. 修改 CPU 核数 (当前: ${GREEN}$cur_cpu${PLAIN})"
        echo -e "2. 修改 内存 大小 (当前: ${GREEN}$cur_mem${PLAIN})"
        echo -e "3. 修改 硬盘 大小 (当前: ${GREEN}$cur_disk${PLAIN})"
        echo -e "4. 修改 网速 限制 (当前: ${GREEN}$cur_net${PLAIN})"
        echo "0. 返回上级"
        echo "--------------------------------"
        read -p "请选择修改项 [0-4]: " opt
        
        case $opt in
            1)
                read -p "请输入新 CPU 核数 (如 2): " new_val
                lxc config set "$target_name" limits.cpu "$new_val"
                echo -e "${GREEN}CPU 修改成功!${PLAIN}"
                ;;
            2)
                read -p "请输入新 内存 大小 (如 512MiB): " new_val
                # 自动补全单位
                [[ "$new_val" != *MiB && "$new_val" != *GB ]] && new_val="${new_val}MiB"
                lxc config set "$target_name" limits.memory "$new_val"
                echo -e "${GREEN}内存 修改成功!${PLAIN}"
                ;;
            3)
                read -p "请输入新 硬盘 大小 (如 5GB): " new_val
                [[ "$new_val" != *MB && "$new_val" != *GB ]] && new_val="${new_val}GB"
                # 硬盘修改需要 override root 设备
                lxc config device override "$target_name" root size="$new_val" >/dev/null 2>&1 || \
                lxc config device set "$target_name" root size="$new_val"
                echo -e "${GREEN}硬盘 修改成功! (注意: 仅支持扩容，缩容可能失败)${PLAIN}"
                ;;
            4)
                read -p "请输入新 网速 (如 100Mbit): " new_val
                [[ "$new_val" != *Mbit ]] && new_val="${new_val}Mbit"
                lxc config device set "$target_name" eth0 limits.max "$new_val"
                lxc config device set "$target_name" eth0 limits.ingress "$new_val"
                lxc config device set "$target_name" eth0 limits.egress "$new_val"
                echo -e "${GREEN}网速 修改成功!${PLAIN}"
                ;;
            0) continue ;;
            *) echo "无效选项";;
        esac
        read -p "按回车继续..." d
    done
}

# --- 5. 菜单逻辑 ---

start_creation_wizard() {
    clear
    echo -e "${GREEN}创建向导${PLAIN}"
    read -p "1. 名称 [默认:test]: " name; name=${name:-test}
    read -p "2. CPU [默认:1]: " cpu; cpu=${cpu:-1}
    read -p "3. 内存MB [默认:256]: " memory; memory=${memory:-256}
    read -p "4. 硬盘GB [默认:2]: " disk; disk=${disk:-2}

    echo -e "\n5. 系统选择:"
    printf " %-27s %s\n" "1) Debian 12"  "11) CentOS 7"
    printf " %-27s %s\n" "2) Debian 11"  "12) Rocky 9"
    printf " %-27s %s\n" "3) Ubuntu 22.04" "13) AlmaLinux 9"
    printf " %-27s %s\n" "4) Ubuntu 20.04" "21) Windows 11 (VM)"
    printf " %-27s %s\n" "6) Alpine 3.19" "22) Windows 10 (VM)"
    read -p "选择 [1-22]: " os_c
    is_vm=false
    case $os_c in
        1) system="debian12" ;; 2) system="debian11" ;; 3) system="ubuntu22.04" ;; 4) system="ubuntu20.04" ;;
        6) system="alpine3.19" ;; 11) system="centos7" ;; 12) system="rockylinux9" ;; 13) system="almalinux9" ;;
        21) system="win11"; is_vm=true ;; 22) system="win10"; is_vm=true ;;
        *) system="debian12" ;;
    esac

    mirror_choice="auto"
    if [ "$is_vm" == false ]; then
        echo -e "\n6. 镜像源: [1]自动 [2]国内 [3]国外"
        read -p "选择 [1]: " m; [[ "$m" == "2" ]] && mirror_choice="cn"; [[ "$m" == "3" ]] && mirror_choice="global"
    fi

    echo -e "\n7. 端口 (SSH默认:20001)"
    read -p "SSH端口: " sshn; sshn=${sshn:-20001}
    read -p "NAT起始(0禁用): " nat1; nat1=${nat1:-20002}
    [[ "$nat1" != "0" ]] && { read -p "NAT结束[20025]: " nat2; nat2=${nat2:-20025}; } || nat2=0

    read -p "8. 限速Mbit [10240]: " in; in=${in:-10240}; out=$in
    if [ "$is_vm" == false ]; then read -p "IPv6? (y/n): " enable_ipv6; fi
    
    check_cdn_file
    if [[ "$system" == "rockylinux9" ]]; then a="rockylinux"; b="9"; 
    elif [[ "$system" == "almalinux9" ]]; then a="almalinux"; b="9";
    else a="${system%%[0-9]*}"; b="${system##*[!0-9.]}"; fi
    
    get_system_arch; process_image; create_container; configure_storage; configure_resources
    setup_system; configure_port; configure_network_speed; cleanup_and_output
    read -p "回车返回..." d
}

view_instances() {
    clear
    local names=$(lxc list --format csv -c n)
    if [ -z "$names" ]; then echo "无实例"; read -p "回车返回..." d; return; fi
    printf "%-15s %-12s %-10s %-15s\n" "名称" "状态" "SSH端口" "Root密码"
    echo -e "${DIVIDER}"
    for c in $names; do
        info=$(lxc list "$c" --format json)
        status=$(echo "$info" | jq -r '.[0].status')
        desc=$(lxc config get "$c" user.description 2>/dev/null)
        read -r -a d_arr <<< "$desc"
        ssh_p="${d_arr[1]}"; pass="${d_arr[2]}"
        [ -z "$ssh_p" ] && ssh_p="-"
        [ -z "$pass" ] && pass="-"
        if [ "$status" == "Running" ]; then color=$GREEN; else color=$RED; fi
        printf "%-15s ${color}%-12s${PLAIN} %-10s %-15s\n" "$c" "$status" "$ssh_p" "$pass"
    done
    read -p "按回车返回..." d
}

main_menu() {
    while true; do
        clear
        echo "=================================================="
        echo -e "      ${GREEN}LXD 终极管理面板 (Ultimate)${PLAIN}"
        echo "=================================================="
        echo -e " 1. ${SKYBLUE}创建新实例${PLAIN} (Create)"
        echo -e " 2. ${SKYBLUE}查看实例表${PLAIN} (List)"
        echo -e " 3. ${GREEN}修改容器配置${PLAIN} (Reconfigure) [HOT]"
        echo "--------------------------------------------------"
        echo -e " 4. ${GREEN}开启所有容器${PLAIN} (Start All)"
        echo -e " 5. ${YELLOW}关闭所有容器${PLAIN} (Stop All)"
        echo -e " 6. ${GREEN}开启 BBR 加速${PLAIN} (Enable BBR)"
        echo "--------------------------------------------------"
        echo -e " 0. 退出 (Exit)"
        echo "=================================================="
        read -p "请选择: " choice
        case $choice in
            1) start_creation_wizard ;;
            2) view_instances ;;
            3) reconfigure_container ;;
            4) manage_all_containers "start" ;;
            5) manage_all_containers "stop" ;;
            6) enable_bbr ;;
            0) exit 0 ;;
            *) ;;
        esac
    done
}

main() { init_env; check_lxd_env; detect_ip_info; check_cdn_file; main_menu; }
main "$@"
