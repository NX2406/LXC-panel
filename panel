#!/usr/bin/env bash
set -euo pipefail

# --- æ ¸å¿ƒé…ç½® (æ ¹æ®éœ€è¦ä¿®æ”¹è¿™é‡Œ) ---
LISTEN_PORT=80        # é¢æ¿å¯¹å¤–ç»Ÿä¸€ç«¯å£ (å‰ç«¯+åç«¯)
APP_DIR="/opt/lxd-panel"
DATA_DIR="${APP_DIR}/data"
LOG_DIR="/var/log/lxd-panel"
PY_VENV="${APP_DIR}/.venv"

# é»˜è®¤ç®¡ç†å‘˜è´¦å· (å®‰è£…å®Œç›´æ¥ç”¨)
ADMIN_USER="admin"
ADMIN_PASS="admin123"

say()  { echo -e "\033[1;36m[*]\033[0m $*"; }
warn() { echo -e "\033[1;33m[!]\033[0m $*"; }
err()  { echo -e "\033[1;31m[âœ—]\033[0m $*"; }

# æƒé™æ£€æŸ¥
[[ $EUID -eq 0 ]] || { err "è¯·ç”¨ sudo/root è¿è¡Œ"; exit 1; }

say "æ­£åœ¨éƒ¨ç½² LXD Panel (å•ç«¯å£Â·ç‹¬ç«‹ç‰ˆ)..."

# 1. å®‰è£…ä¾èµ– (ç§»é™¤äº† Nginxï¼Œä»…éœ€ Python)
say "é…ç½®ç³»ç»Ÿç¯å¢ƒ..."
if command -v apt-get >/dev/null; then
    apt-get update -y >/dev/null
    apt-get install -y python3 python3-venv python3-pip openssl curl jq >/dev/null
elif command -v yum >/dev/null; then
    yum install -y python3 openssl curl jq
else
    warn "æœªæ£€æµ‹åˆ° apt/yumï¼Œè¯·è‡ªè¡Œç¡®ä¿å®‰è£…äº† python3, pip, openssl"
fi

# 2. åˆ›å»ºç›®å½•
mkdir -p "${APP_DIR}" "${DATA_DIR}" "${LOG_DIR}"

# 3. å†™å…¥åç«¯ app.py
# æ ¸å¿ƒé€»è¾‘ï¼šFastAPI æ—¢å¤„ç† /api è¯·æ±‚ï¼Œä¹Ÿæ‰˜ç®¡æ ¹è·¯å¾„ / çš„ index.html
say "å†™å…¥æ ¸å¿ƒç¨‹åº..."
cat > "${APP_DIR}/app.py" <<'PY'
import os, re, time, sqlite3, json
from typing import Optional, List, Dict, Any
import httpx
from fastapi import FastAPI, HTTPException, Request, Depends
from fastapi.responses import HTMLResponse
from fastapi.middleware.cors import CORSMiddleware
from jose import jwt, JWTError
from passlib.context import CryptContext
from pydantic import BaseModel, Field

APP_NAME = "LXD-Panel"
DB_PATH = os.environ.get("LXD_PANEL_DB", "/opt/lxd-panel/data/panel.db")
JWT_SECRET = os.environ.get("LXD_PANEL_JWT_SECRET", "PLEASE_CHANGE_ME")
SEED_ADMIN_USER = os.environ.get("LXD_PANEL_ADMIN_USER", "admin")
SEED_ADMIN_PASS = os.environ.get("LXD_PANEL_ADMIN_PASS", "ChangeMeNow!")
JWT_ALG = "HS256"
TOKEN_TTL = 12 * 3600

pwd_ctx = CryptContext(schemes=["bcrypt"], deprecated="auto")
NAME_RE = re.compile(r"^[a-zA-Z0-9][a-zA-Z0-9\-]{1,30}$")

ALLOWED_IMAGES = [
    "images:ubuntu/22.04",
    "images:ubuntu/24.04",
    "images:debian/12",
]

def db():
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    conn.execute("PRAGMA journal_mode=WAL;")
    return conn

def init_db():
    c = db(); cur = c.cursor()
    cur.execute("""
    CREATE TABLE IF NOT EXISTS users(
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      username TEXT UNIQUE NOT NULL,
      password_hash TEXT NOT NULL,
      role TEXT NOT NULL DEFAULT 'user',
      created_at INTEGER NOT NULL
    );
    """)
    cur.execute("""
    CREATE TABLE IF NOT EXISTS nodes(
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      name TEXT NOT NULL,
      base_url TEXT NOT NULL,
      panel_key TEXT NOT NULL,
      ca_pem TEXT NOT NULL,
      client_cert_pem TEXT NOT NULL,
      client_key_pem TEXT NOT NULL,
      port_start INTEGER NOT NULL,
      port_end INTEGER NOT NULL,
      created_at INTEGER NOT NULL
    );
    """)
    cur.execute("""
    CREATE TABLE IF NOT EXISTS port_alloc(
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      node_id INTEGER NOT NULL,
      host_port INTEGER NOT NULL,
      user_id INTEGER NOT NULL,
      container_name TEXT NOT NULL,
      proto TEXT NOT NULL,
      inside_port INTEGER NOT NULL,
      created_at INTEGER NOT NULL,
      UNIQUE(node_id, host_port)
    );
    """)
    c.commit()
    # åˆå§‹ç®¡ç†å‘˜
    cur.execute("SELECT id FROM users WHERE role='admin' LIMIT 1")
    if not cur.fetchone():
        cur.execute("INSERT INTO users(username,password_hash,role,created_at) VALUES(?,?,?,?)",
            (SEED_ADMIN_USER, pwd_ctx.hash(SEED_ADMIN_PASS), "admin", int(time.time())))
        c.commit()
    c.close()

def make_token(user):
    payload = {"sub": user["username"], "role": user["role"], "uid": user["id"], "exp": int(time.time()) + TOKEN_TTL}
    return jwt.encode(payload, JWT_SECRET, algorithm=JWT_ALG)

def current_user(req: Request):
    auth = req.headers.get("Authorization", "")
    if not auth.startswith("Bearer "): raise HTTPException(401, "Missing token")
    try: return jwt.decode(auth.split(" ", 1)[1].strip(), JWT_SECRET, algorithms=[JWT_ALG])
    except: raise HTTPException(401, "Invalid token")

def require_admin(user=Depends(current_user)):
    if user.get("role") != "admin": raise HTTPException(403, "Admin only")
    return user

def get_node(node_id: int):
    c = db(); cur = c.cursor()
    cur.execute("SELECT * FROM nodes WHERE id=?", (node_id,))
    r = cur.fetchone(); c.close()
    if not r: raise HTTPException(404, "node not found")
    return r

def cert_cache_dir():
    p = os.environ.get("LXD_PANEL_CERT_CACHE", "/opt/lxd-panel/cert-cache")
    os.makedirs(p, exist_ok=True)
    return p

def write_node_certs(node):
    d = cert_cache_dir()
    ca, crt, key = os.path.join(d,f"n{node['id']}.ca"), os.path.join(d,f"n{node['id']}.crt"), os.path.join(d,f"n{node['id']}.key")
    def w(p, c, m):
        if not os.path.exists(p) or open(p).read() != c:
            with open(p,"w") as f: f.write(c)
            os.chmod(p, m)
    w(ca, node["ca_pem"], 0o644); w(crt, node["client_cert_pem"], 0o644); w(key, node["client_key_pem"], 0o600)
    return {"ca":ca, "crt":crt, "key":key}

# åç«¯ -> LXD å®¿ä¸»æœº çš„é€šä¿¡é€»è¾‘
async def agent_call(node, method, path, json_body=None):
    url = node["base_url"].rstrip("/") + path
    files = write_node_certs(node)
    timeout = httpx.Timeout(10.0)
    # è¿™é‡Œçš„ verify=ca æ˜¯æŒ‡åç«¯éªŒè¯ LXD å®¿ä¸»æœºçš„èº«ä»½
    async with httpx.AsyncClient(timeout=timeout, verify=files["ca"], cert=(files["crt"], files["key"])) as client:
        r = await client.request(method, url, headers={"X-Panel-Key": node["panel_key"]}, json=json_body)
        try: data = r.json()
        except: data = {"detail": r.text}
        if r.status_code >= 400: raise HTTPException(r.status_code, data.get("detail", data))
        return data

# æ•°æ®æ¨¡å‹
class LoginReq(BaseModel):
    username: str
    password: str
class PairNodeReq(BaseModel):
    agent_url: str
    pair_token: str
    port_start: int = 20000
    port_end: int = 40000
class CreateContainerReq(BaseModel):
    node_id: int
    name: str
    image: str
    cpu: str = "2"
    memory_mb: int = 1024
    disk_gb: int = 10
    expose: List[Dict[str, Any]] = []

app = FastAPI(title=APP_NAME)
app.add_middleware(CORSMiddleware, allow_origins=["*"], allow_methods=["*"], allow_headers=["*"])

@app.on_event("startup")
def _startup(): init_db()

# --- å…³é”®ä¿®æ”¹ï¼šç›´æ¥æ‰˜ç®¡å‰ç«¯é¡µé¢ ---
@app.get("/", response_class=HTMLResponse)
async def serve_index():
    with open("index.html", "r", encoding="utf-8") as f: return f.read()

@app.get("/api/health")
def health(): return {"ok": True}

@app.post("/api/login")
def login(body: LoginReq):
    c = db(); cur = c.cursor()
    cur.execute("SELECT * FROM users WHERE username=?", (body.username,))
    row = cur.fetchone(); c.close()
    if not row or not pwd_ctx.verify(body.password, row["password_hash"]): raise HTTPException(401, "Auth failed")
    return {"token": make_token(dict(row)), "role": row["role"], "username": row["username"]}

@app.get("/api/me")
def me(user=Depends(current_user)): return {"username": user["sub"], "role": user["role"]}

@app.get("/api/images")
def images(user=Depends(current_user)): return {"items": ALLOWED_IMAGES}

@app.post("/api/admin/nodes/pair")
async def pair_node(body: PairNodeReq, admin=Depends(require_admin)):
    url = body.agent_url.strip().rstrip("/")
    # ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼ˆæ— è¯ä¹¦ï¼‰ï¼Œäº¤æ¢ Token
    async with httpx.AsyncClient(verify=False, timeout=10) as client:
        r = await client.post(url + "/agent/enroll", json={"pair_token": body.pair_token})
        if r.status_code!=200: raise HTTPException(400, "Pair failed: "+r.text)
        j = r.json()
    
    # ä¿å­˜è¯ä¹¦
    c = db(); cur = c.cursor()
    cur.execute("INSERT INTO nodes(name,base_url,panel_key,ca_pem,client_cert_pem,client_key_pem,port_start,port_end,created_at) VALUES(?,?,?,?,?,?,?,?,?)",
        (j.get("node_name", url), url, j["panel_key"], j["ca_pem"], j["client_cert_pem"], j["client_key_pem"], body.port_start, body.port_end, int(time.time())))
    c.commit(); nid = cur.lastrowid; c.close()
    return {"ok": True, "node_id": nid}

@app.get("/api/nodes")
def list_nodes(user=Depends(current_user)):
    c = db(); cur = c.cursor()
    cur.execute("SELECT id,name,base_url FROM nodes"); rows = [dict(r) for r in cur.fetchall()]; c.close()
    return {"items": rows}

@app.get("/api/containers")
async def list_containers(node_id: int, user=Depends(current_user)):
    node = get_node(node_id)
    # é€šä¿¡ï¼šé€šè¿‡åç«¯ç«¯å£ -> LXD Agent
    data = await agent_call(node, "GET", "/agent/containers")
    items = data.get("items", [])
    if user["role"]!="admin": items = [x for x in items if x["name"].startswith(f"u_{user['uid']}_")]
    return {"items": items}

@app.post("/api/containers")
async def create_container(body: CreateContainerReq, user=Depends(current_user)):
    if not NAME_RE.match(body.name): raise HTTPException(400, "Invalid name")
    node = get_node(body.node_id)
    cname = (f"u_{user['uid']}_" + body.name) if user["role"]!="admin" else body.name
    
    # ç«¯å£åˆ†é…é€»è¾‘ç®€åŒ–ç‰ˆ
    c = db(); cur = c.cursor()
    cur.execute("SELECT port_start, port_end FROM nodes WHERE id=?", (body.node_id,))
    ps, pe = cur.fetchone()
    cur.execute("SELECT host_port FROM port_alloc WHERE node_id=?", (body.node_id,))
    used = {r[0] for r in cur.fetchall()}
    
    mappings = []
    for x in body.expose:
        found_port = -1
        for p in range(ps, pe):
            if p not in used: found_port = p; used.add(p); break
        if found_port == -1: raise HTTPException(409, "No ports available")
        mappings.append({"proto": x.get("proto","tcp"), "host_port": found_port, "inside_port": x["inside_port"]})
        cur.execute("INSERT INTO port_alloc(node_id,host_port,user_id,container_name,proto,inside_port,created_at) VALUES(?,?,?,?,?,?,?)",
            (body.node_id, found_port, user["uid"], cname, x.get("proto","tcp"), x["inside_port"], int(time.time())))
    c.commit(); c.close()

    payload = {"name": cname, "image": body.image, "cpu": body.cpu, "memory_mb": body.memory_mb, "disk_gb": body.disk_gb, "ports": mappings}
    await agent_call(node, "POST", "/agent/containers", json_body=payload)
    return {"ok": True}
PY

# 4. å†™å…¥å‰ç«¯ index.html (é€‚é…å•ç«¯å£æ¨¡å¼)
say "å†™å…¥å‰ç«¯é¡µé¢..."
cat > "${APP_DIR}/index.html" <<'HTML'
<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LXD Panel Lite</title>
<style>
body{background:#0d1117;color:#c9d1d9;font-family:sans-serif;margin:0;padding:20px;display:flex;justify-content:center}
.box{width:100%;max-width:800px}
.card{background:#161b22;border:1px solid #30363d;border-radius:6px;padding:20px;margin-bottom:20px}
input,select,button{background:#0d1117;border:1px solid #30363d;color:#fff;padding:8px;border-radius:6px;margin:5px 0;width:100%;box-sizing:border-box}
button{background:#238636;border-color:#238636;cursor:pointer;font-weight:bold}
button:hover{background:#2ea043}
.row{display:flex;gap:10px} .grow{flex:1}
h3{margin-top:0} .muted{color:#8b949e;font-size:12px}
table{width:100%;border-collapse:collapse} th,td{text-align:left;padding:8px;border-bottom:1px solid #30363d}
</style>
</head>
<body>
<div class="box">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>ğŸ›¡ï¸ LXD Panel Lite</h3>
        <button onclick="logout()" style="width:auto;background:#da3633;border:none">é€€å‡º</button>
    </div>
    <div id="status" class="muted">æ£€æŸ¥ API ä¸­...</div>
  </div>

  <div id="loginView" class="card">
    <h3>ç™»å½•</h3>
    <input id="u" value="admin" placeholder="ç”¨æˆ·å">
    <input id="p" type="password" placeholder="å¯†ç ">
    <button onclick="doLogin()">ç™»å½•</button>
  </div>

  <div id="mainView" style="display:none">
    <div class="card" id="adminArea">
        <h3>ğŸ”— é…å¯¹èŠ‚ç‚¹ (Admin)</h3>
        <div class="row">
            <input id="aUrl" class="grow" placeholder="https://ip:443">
            <input id="aTok" class="grow" placeholder="pair_token">
        </div>
        <button onclick="pairNode()">é…å¯¹</button>
    </div>

    <div class="card">
        <h3>ğŸ“¦ å®¹å™¨ç®¡ç†</h3>
        <div class="row">
            <select id="nodeSel" class="grow" onchange="loadContainers()"></select>
            <button style="width:auto" onclick="loadNodes()">åˆ·æ–°èŠ‚ç‚¹</button>
        </div>
        <hr style="border:0;border-top:1px solid #30363d;margin:15px 0"/>
        <div class="row">
            <input id="cname" class="grow" placeholder="å®¹å™¨å">
            <select id="imgSel" class="grow"></select>
        </div>
        <input id="ports" placeholder="ç«¯å£æ˜ å°„ (å¦‚: tcp 80, tcp 443 å¤šä¸ªç”¨é€—å·éš”å¼€)">
        <button onclick="createContainer()">åˆ›å»ºå®¹å™¨</button>
    </div>

    <div class="card">
        <h3>åˆ—è¡¨</h3>
        <table id="ctable"><thead><tr><th>åç§°</th><th>çŠ¶æ€</th><th>IPv4</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>
<script>
// è‡ªåŠ¨é€‚é…å½“å‰ç«¯å£ï¼Œå‰ç«¯å’Œåç«¯åœ¨åŒä¸€ç«¯å£é€šä¿¡
const API = "/api"; 
let token = localStorage.getItem("token");

async function req(path, method="GET", body=null) {
    const headers = token ? {"Authorization":"Bearer "+token} : {};
    if(body) { headers["Content-Type"]="application/json"; body=JSON.stringify(body); }
    const r = await fetch(API+path, {method, headers, body});
    const d = await r.json().catch(()=>({}));
    if(!r.ok) { alert(d.detail || "Error"); throw "err"; }
    return d;
}

async function init() {
    try {
        await req("/health");
        document.getElementById("status").innerText = "API åœ¨çº¿ âœ…";
        if(token) {
            const u = await req("/me");
            document.getElementById("status").innerText = `å·²ç™»å½•: ${u.username} (${u.role})`;
            if(u.role !== "admin") document.getElementById("adminArea").style.display = "none";
            document.getElementById("loginView").style.display = "none";
            document.getElementById("mainView").style.display = "block";
            
            const imgs = await req("/images");
            imgSel.innerHTML = imgs.items.map(i=>`<option>${i}</option>`).join("");
            loadNodes();
        }
    } catch(e) { console.log(e); }
}

async function doLogin() {
    const d = await req("/login", "POST", {username:u.value, password:p.value});
    token = d.token; localStorage.setItem("token", token);
    location.reload();
}

function logout() { localStorage.clear(); location.reload(); }

async function pairNode() {
    await req("/admin/nodes/pair", "POST", {agent_url:aUrl.value, pair_token:aTok.value});
    alert("é…å¯¹æˆåŠŸ"); loadNodes();
}

async function loadNodes() {
    const d = await req("/nodes");
    nodeSel.innerHTML = d.items.map(n=>`<option value="${n.id}">${n.name}</option>`).join("");
    if(d.items.length) loadContainers();
}

async function loadContainers() {
    const nid = nodeSel.value; if(!nid) return;
    const d = await req("/containers?node_id="+nid);
    ctable.querySelector("tbody").innerHTML = d.items.map(c=>`<tr><td>${c.name}</td><td>${c.status}</td><td>${c.ipv4||"-"}</td></tr>`).join("");
}

async function createContainer() {
    const expose = ports.value.split(",").filter(x=>x.trim()).map(x=>{
        const [p,port] = x.trim().split(/\s+/);
        return {proto: p.toLowerCase(), inside_port: parseInt(port)};
    });
    await req("/containers", "POST", {
        node_id: parseInt(nodeSel.value), name: cname.value, image: imgSel.value, expose
    });
    alert("åˆ›å»ºæˆåŠŸï¼Œç­‰å¾…å¯åŠ¨...");
    setTimeout(loadContainers, 3000);
}

init();
</script>
</body>
</html>
HTML

# 5. å®‰è£…å¹¶é…ç½®æœåŠ¡
say "å®‰è£… Python åº“ (fastapi uvicorn httpx python-jose passlib)..."
python3 -m venv "${PY_VENV}"
"${PY_VENV}/bin/pip" install -U pip >/dev/null
"${PY_VENV}/bin/pip" install fastapi==0.115.0 uvicorn==0.30.6 python-jose==3.3.0 passlib[bcrypt]==1.7.4 pydantic==2.8.2 httpx==0.27.2 >/dev/null

JWT_SECRET="$(openssl rand -hex 32)"
say "é…ç½® Systemd æœåŠ¡ (ç›‘å¬ 0.0.0.0:${LISTEN_PORT})..."
cat > /etc/systemd/system/lxd-panel.service <<EOF
[Unit]
Description=LXD Panel Standalone
After=network.target

[Service]
Type=simple
WorkingDirectory=${APP_DIR}
Environment="LXD_PANEL_JWT_SECRET=${JWT_SECRET}"
Environment="LXD_PANEL_ADMIN_USER=${ADMIN_USER}"
Environment="LXD_PANEL_ADMIN_PASS=${ADMIN_PASS}"
# å…³é”®ï¼šhost 0.0.0.0 è¡¨ç¤ºå…è®¸å¤–ç½‘è®¿é—®
ExecStart=${PY_VENV}/bin/uvicorn app:app --host 0.0.0.0 --port ${LISTEN_PORT}
Restart=always
RestartSec=2
StandardOutput=append:${LOG_DIR}/panel.log

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable --now lxd-panel.service

echo "------------------------------------------------------------"
echo "âœ… å®‰è£…æˆåŠŸï¼å‰ç«¯ä¸é€šä¿¡åç«¯å·²æ•´åˆã€‚"
echo "è®¿é—®åœ°å€ï¼š http://<ä½ çš„IP>:${LISTEN_PORT}/"
echo "è´¦å·ï¼š ${ADMIN_USER}"
echo "å¯†ç ï¼š ${ADMIN_PASS}"
echo "------------------------------------------------------------"
